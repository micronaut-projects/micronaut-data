<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>Micronaut Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
    <link rel="stylesheet" href="../css/custom.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script src="../js/guide.js"></script>
    <script src="../js/multi-language-sample.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="stylesheet" href="../css/multi-language-sample.css"/>
    <script src="../js/docs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.13/clipboard.min.js"></script>
    <script type="text/javascript">
        function addJsClass(el) {
            var classes = document.body.className.split(" ");
            classes.push("js");
            document.body.className = classes.join(" ");
        }
    </script>

</head>

<body class="body" id="docs" onload="addJsClass();" onhashchange="highlightMenu()">

<div id="table-of-content-nav-link" class="desktop">
    <a id="theme-switcher" title="Switch to dark theme" href="javascript:switchTheme(true)"><i class="fa fa-moon-o"></i></a>
    <a title="Collapse/Open Table of contents" title="Hide Table of Contents" href="javascript:hideTableOfContents();" class="button">[ + ]</a>
</div>

<div id="main">
    <div id="navigation" class="no-print">
        <div class="navTitle">
            <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
        </div>
        <div class="navLinks">
            <ul>
                    <li><div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)" class="desktop">
                            <a href="../guide/index.html" class="button">Table of contents</a>
                            <div id="nav-summary-childs" style="display:none;">
                                
                                <div class="toc-item" style="margin-left:0"><a href="#introduction"><strong>1</strong><span>Introduction</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#buildConfig"><strong>2</strong><span>Build Configuration</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#shared"><strong>3</strong><span>Shared Concepts</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#hibernate"><strong>4</strong><span>Micronaut Data JPA Hibernate</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#hibernateReactive"><strong>5</strong><span>Micronaut Data Hibernate Reactive</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#dbc"><strong>6</strong><span>Micronaut Data JDBC and R2DBC</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#mongo"><strong>7</strong><span>Micronaut Data MongoDB</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#azureCosmos"><strong>8</strong><span>Micronaut Data Azure Cosmos</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#howItWorks"><strong>9</strong><span>How Micronaut Data Works</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#graal"><strong>10</strong><span>Going Native with GraalVM</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#spring"><strong>11</strong><span>Spring Data Support</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#dataGuides"><strong>12</strong><span>Guides</span></a></div>
                                
                            </div>
                        </div>
                    </li>

                <li id="table-of-content-nav-link-mobile" class="mobile">
                    <a title="Scroll to Table of contents" href="javascript:scrollToTop();" class="button">Toc</a>
                </li>
                <li class="desktop">
                    <a title="Go to API documentation" href="../api/index.html" class="button">API Reference</a>
                </li>
                <li class="mobile">
                    <a title="Go to API documentation" href="../api/index.html" class="button">API</a>
                </li>
                <li class="desktop">
                    <a title="Go to Configuration Reference documentation" href="../guide/configurationreference.html" class="button">Configuration Reference</a>
                </li>
                <li class="mobile">
                    <a title="Go to Configuration Reference documentation" href="../guide/configurationreference.html" class="button">Conf</a>
                </li>
            </ul>

        </div>
    </div>
    
    <div id="table-of-content">
        <div class="toc-content">

        <h2>Table of Contents</h2>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-introduction"><a href="#introduction"><strong>1</strong><span>Introduction</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-repository"><a href="#repository"><strong>1.1</strong><span>Repository</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-whatsNew"><a href="#whatsNew"><strong>1.2</strong><span>What's New?</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-breaks"><a href="#breaks"><strong>1.3</strong><span>Breaking Changes</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-releaseHistory"><a href="#releaseHistory"><strong>1.4</strong><span>Release History</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-buildConfig"><a href="#buildConfig"><strong>2</strong><span>Build Configuration</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-shared"><a href="#shared"><strong>3</strong><span>Shared Concepts</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-repositories"><a href="#repositories"><strong>3.1</strong><span>Repository Interfaces</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-validation"><a href="#validation"><strong>3.2</strong><span>Validation</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-querying"><a href="#querying"><strong>3.3</strong><span>Writing Queries</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-criteria"><a href="#criteria"><strong>3.3.1</strong><span>Query Criteria</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-pagination"><a href="#pagination"><strong>3.3.2</strong><span>Pagination</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-cursored-pagination"><a href="#cursored-pagination"><strong>3.3.3</strong><span>Cursored Pagination</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-ordering"><a href="#ordering"><strong>3.3.4</strong><span>Ordering</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-projections"><a href="#projections"><strong>3.3.5</strong><span>Query Projections</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-dto"><a href="#dto"><strong>3.3.6</strong><span>DTO Projections</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-explicitQueries"><a href="#explicitQueries"><strong>3.3.7</strong><span>Explicit Queries</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-whereAnnotation"><a href="#whereAnnotation"><strong>3.3.8</strong><span>Modifying Queries with @Where</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-async"><a href="#async"><strong>3.3.9</strong><span>Asynchronous Queries</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-reactive"><a href="#reactive"><strong>3.3.10</strong><span>Reactive Queries</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-dataUpdates"><a href="#dataUpdates"><strong>3.4</strong><span>Accessing data</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-inserts"><a href="#inserts"><strong>3.4.1</strong><span>Inserting</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-updates"><a href="#updates"><strong>3.4.2</strong><span>Updating</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-deletes"><a href="#deletes"><strong>3.4.3</strong><span>Deleting</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-timestamps"><a href="#timestamps"><strong>3.4.4</strong><span>Entity Timestamps</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-entityEvents"><a href="#entityEvents"><strong>3.4.5</strong><span>Entity Events</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-transactions"><a href="#transactions"><strong>3.5</strong><span>Transactions</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-programmaticTransactions"><a href="#programmaticTransactions"><strong>3.5.1</strong><span>Programmatic Transactions</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-transactionalEvents"><a href="#transactionalEvents"><strong>3.5.2</strong><span>Transactional Events</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-kotlinCriteria"><a href="#kotlinCriteria"><strong>3.6</strong><span>Kotlin Criteria API extensions</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-multitenancy"><a href="#multitenancy"><strong>3.7</strong><span>Multi-tenancy</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-discriminatormode"><a href="#discriminatormode"><strong>3.7.1</strong><span>Discriminator Mode</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-datasourcemode"><a href="#datasourcemode"><strong>3.7.2</strong><span>DataSource Mode</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-schemamode"><a href="#schemamode"><strong>3.7.3</strong><span>Schema Mode</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-hibernate"><a href="#hibernate"><strong>4</strong><span>Micronaut Data JPA Hibernate</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-hibernateJpaAnnotations"><a href="#hibernateJpaAnnotations"><strong>4.1</strong><span>JPA Annotations</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-hibernateQuickStart"><a href="#hibernateQuickStart"><strong>4.2</strong><span>Quick Start</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-hibernateLogging"><a href="#hibernateLogging"><strong>4.3</strong><span>Logging SQL with Micronaut Data JPA Hibernate</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-hibernateJoinQueries"><a href="#hibernateJoinQueries"><strong>4.4</strong><span>Join queries</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-hibernateExplicitQueries"><a href="#hibernateExplicitQueries"><strong>4.5</strong><span>Explicit queries</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-hibernateNativeQueries"><a href="#hibernateNativeQueries"><strong>4.6</strong><span>Native queries</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-hibernateProcedures"><a href="#hibernateProcedures"><strong>4.7</strong><span>Procedures</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-hibernateSpecifications"><a href="#hibernateSpecifications"><strong>4.8</strong><span>JPA specifications</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-hibernateReactive"><a href="#hibernateReactive"><strong>5</strong><span>Micronaut Data Hibernate Reactive</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-dbc"><a href="#dbc"><strong>6</strong><span>Micronaut Data JDBC and R2DBC</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-jdbc"><a href="#jdbc"><strong>6.1</strong><span>JDBC</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-jdbcQuickStart"><a href="#jdbcQuickStart"><strong>6.1.1</strong><span>Quick Start</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-jdbcConfiguration"><a href="#jdbcConfiguration"><strong>6.1.2</strong><span>Configuration</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-r2dbc"><a href="#r2dbc"><strong>6.2</strong><span>R2DBC</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-r2dbcQuickStart"><a href="#r2dbcQuickStart"><strong>6.2.1</strong><span>Quick Start</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-r2dbcConfiguration"><a href="#r2dbcConfiguration"><strong>6.2.2</strong><span>Configuration</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-r2querying"><a href="#r2querying"><strong>6.2.3</strong><span>Reactive repositories</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-r2transactionManagement"><a href="#r2transactionManagement"><strong>6.2.4</strong><span>Transactions</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-r2entityEvents"><a href="#r2entityEvents"><strong>6.2.5</strong><span>Reactive Entity Events</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-dbcRepositories"><a href="#dbcRepositories"><strong>6.3</strong><span>Repositories</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlInserts"><a href="#sqlInserts"><strong>6.3.1</strong><span>Accessing data</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-optimisticLocking"><a href="#optimisticLocking"><strong>6.3.2</strong><span>Optimistic locking</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-pessimisticLocking"><a href="#pessimisticLocking"><strong>6.3.3</strong><span>Pessimistic Locking</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-dbcCriteriaSpecifications"><a href="#dbcCriteriaSpecifications"><strong>6.4</strong><span>Repositories with Criteria API</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-criteriaExecuteQuery"><a href="#criteriaExecuteQuery"><strong>6.4.1</strong><span>Querying</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-criteriaExecuteUpdate"><a href="#criteriaExecuteUpdate"><strong>6.4.2</strong><span>Updating</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-criteriaExecuteDelete"><a href="#criteriaExecuteDelete"><strong>6.4.3</strong><span>Deleting</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-otherRepositoryVariations"><a href="#otherRepositoryVariations"><strong>6.4.4</strong><span>Other repository variations</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-typeSafeJava"><a href="#typeSafeJava"><strong>6.4.5</strong><span>Type-Safe Java queries</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-sqlMapping"><a href="#sqlMapping"><strong>6.5</strong><span>Mapping Entities</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlAnnotations"><a href="#sqlAnnotations"><strong>6.5.1</strong><span>SQL Annotations</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlExpandableQueries"><a href="#sqlExpandableQueries"><strong>6.5.2</strong><span>Expandable queries</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlIdGenerator"><a href="#sqlIdGenerator"><strong>6.5.3</strong><span>ID Generation</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlCompositeId"><a href="#sqlCompositeId"><strong>6.5.4</strong><span>Composite Primary Keys</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlConstructorArguments"><a href="#sqlConstructorArguments"><strong>6.5.5</strong><span>Constructor Arguments</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlNaming"><a href="#sqlNaming"><strong>6.5.6</strong><span>SQL Naming Strategies</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlAssociationMapping"><a href="#sqlAssociationMapping"><strong>6.5.7</strong><span>Association Mapping</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlAssociationFetching"><a href="#sqlAssociationFetching"><strong>6.5.8</strong><span>Association Fetching</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-columnTransformer"><a href="#columnTransformer"><strong>6.5.9</strong><span>Using @ColumnTransformer</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mappedPropertyAlias"><a href="#mappedPropertyAlias"><strong>6.5.10</strong><span>Using @MappedProperty alias</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlJsonType"><a href="#sqlJsonType"><strong>6.5.11</strong><span>JSON Column Support</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-sqlJsonView"><a href="#sqlJsonView"><strong>6.5.12</strong><span>JSON View</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-javaRecords"><a href="#javaRecords"><strong>6.5.13</strong><span>Support for Java 16 Records</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-kotlinData"><a href="#kotlinData"><strong>6.5.14</strong><span>Support for Kotlin immutable data classes</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-dbcDataTypes"><a href="#dbcDataTypes"><strong>6.6</strong><span>Data Types</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-dbcAttributeConverter"><a href="#dbcAttributeConverter"><strong>6.7</strong><span>Using Attribute Converter</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-dbcJoinQueries"><a href="#dbcJoinQueries"><strong>6.8</strong><span>Join Queries</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-dbcNativeQueries"><a href="#dbcNativeQueries"><strong>6.9</strong><span>Explicit Queries</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-dbcProcedures"><a href="#dbcProcedures"><strong>6.10</strong><span>Procedures</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-mongo"><a href="#mongo"><strong>7</strong><span>Micronaut Data MongoDB</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-mongoQuickStart"><a href="#mongoQuickStart"><strong>7.1</strong><span>Quick Start</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-mongoRepositories"><a href="#mongoRepositories"><strong>7.2</strong><span>Repositories</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoInsertsAndUpdates"><a href="#mongoInsertsAndUpdates"><strong>7.2.1</strong><span>Accessing data</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoCustomQueries"><a href="#mongoCustomQueries"><strong>7.2.2</strong><span>Custom Queries and Options</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-mongoMapping"><a href="#mongoMapping"><strong>7.3</strong><span>Mapping Entities</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoAnnotations"><a href="#mongoAnnotations"><strong>7.3.1</strong><span>Mapping Annotations</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoIdGenerator"><a href="#mongoIdGenerator"><strong>7.3.2</strong><span>ID Generation</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoCompositeId"><a href="#mongoCompositeId"><strong>7.3.3</strong><span>Composite Primary Keys</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoConstructorArguments"><a href="#mongoConstructorArguments"><strong>7.3.4</strong><span>Constructor Arguments</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoNaming"><a href="#mongoNaming"><strong>7.3.5</strong><span>Naming Strategies</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoAssociationMapping"><a href="#mongoAssociationMapping"><strong>7.3.6</strong><span>Association Mapping</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoAssociationFetching"><a href="#mongoAssociationFetching"><strong>7.3.7</strong><span>Association Fetching</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-mongoJoinQueries"><a href="#mongoJoinQueries"><strong>7.4</strong><span>Join Queries</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-mongoAttributeConverter"><a href="#mongoAttributeConverter"><strong>7.5</strong><span>Using Attribute Converter</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-mongoCriteriaSpecifications"><a href="#mongoCriteriaSpecifications"><strong>7.6</strong><span>Repositories with Criteria API</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoCriteriaExecuteQuery"><a href="#mongoCriteriaExecuteQuery"><strong>7.6.1</strong><span>Querying</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoCriteriaExecuteUpdate"><a href="#mongoCriteriaExecuteUpdate"><strong>7.6.2</strong><span>Updating</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoCriteriaExecuteDelete"><a href="#mongoCriteriaExecuteDelete"><strong>7.6.3</strong><span>Deleting</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-mongoOtherRepositoryVariations"><a href="#mongoOtherRepositoryVariations"><strong>7.6.4</strong><span>Other repository variations</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-mongoOptimisticLocking"><a href="#mongoOptimisticLocking"><strong>7.7</strong><span>Optimistic locking</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-azureCosmos"><a href="#azureCosmos"><strong>8</strong><span>Micronaut Data Azure Cosmos</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-azureCosmosQuickStart"><a href="#azureCosmosQuickStart"><strong>8.1</strong><span>Quick Start</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-azureCosmosConfiguration"><a href="#azureCosmosConfiguration"><strong>8.2</strong><span>Configuration</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-azureCosmosRepositories"><a href="#azureCosmosRepositories"><strong>8.3</strong><span>Repositories</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-azureCosmosCriteriaSpecifications"><a href="#azureCosmosCriteriaSpecifications"><strong>8.4</strong><span>Repositories with Criteria API</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-azureCosmosCriteriaExecuteQuery"><a href="#azureCosmosCriteriaExecuteQuery"><strong>8.4.1</strong><span>Querying</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-azureCosmosCriteriaExecuteUpdate"><a href="#azureCosmosCriteriaExecuteUpdate"><strong>8.4.2</strong><span>Updating</span></a></div>
        
        <div class="toc-item" style="margin-left:20px" id="toc-item-azureCosmosCriteriaExecuteDelete"><a href="#azureCosmosCriteriaExecuteDelete"><strong>8.4.3</strong><span>Deleting</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-azureCosmosSpecifics"><a href="#azureCosmosSpecifics"><strong>8.5</strong><span>Azure Cosmos Specifics</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-azureCosmosAttributeConverter"><a href="#azureCosmosAttributeConverter"><strong>8.6</strong><span>Using Attribute Converter</span></a></div>
        
        <div class="toc-item" style="margin-left:10px" id="toc-item-azureCosmosOptimisticLocking"><a href="#azureCosmosOptimisticLocking"><strong>8.7</strong><span>Optimistic locking</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-howItWorks"><a href="#howItWorks"><strong>9</strong><span>How Micronaut Data Works</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-graal"><a href="#graal"><strong>10</strong><span>Going Native with GraalVM</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-spring"><a href="#spring"><strong>11</strong><span>Spring Data Support</span></a></div>
        
        <div class="toc-item" style="margin-left:0px" id="toc-item-dataGuides"><a href="#dataGuides"><strong>12</strong><span>Guides</span></a></div>
        
        </div>
    </div>
    
    <div class="docs-content">
    <div class="project">
        <h1>Micronaut Data</h1>
        <p></p>
        <p>Data Repository Support for Micronaut</p>
        <p><strong>Version:</strong> 4.9.0-SNAPSHOT </p>
    </div>
    
<h1 id="introduction"><a class="anchor" href="#introduction"></a>1 Introduction</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/introduction.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data is a database access toolkit that uses Ahead of Time (AoT) compilation to pre-compute queries for repository interfaces that are then executed by a thin, lightweight runtime layer.</p>
</div>
<div class="paragraph">
<p>Micronaut Data is inspired by <a href="https://gorm.grails.org">GORM</a> and <a href="https://spring.io/projects/spring-data">Spring Data</a>, however improves on those solutions in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>No runtime model</strong> - Both GORM and Spring Data maintain a runtime metamodel that uses reflection to model relationships between entities. This model consumes significant memory and memory requirements grow as your application size grows. The problem is worse when combined with Hibernate which maintains its own metamodel as you end up with duplicate meta-models.</p>
</li>
<li>
<p><strong>No query translation</strong> - Both GORM and Spring Data use regular expressions and pattern matching in combination with runtime generated proxies to translate a method definition on a Java interface into a query at runtime. No such runtime translation exists in Micronaut Data and this work is carried out by the Micronaut compiler at compilation time.</p>
</li>
<li>
<p><strong>No Reflection or Runtime Proxies</strong> - Micronaut Data uses no reflection or runtime proxies, resulting in better performance, smaller stack traces and reduced memory consumption due to a complete lack of reflection caches (Note that the backing implementation, for example Hibernate, may use reflection).</p>
</li>
<li>
<p><strong>Type Safety</strong> - Micronaut Data will actively check at compile time that a repository method can be implemented and fail compilation if it cannot.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Micronaut Data provides a general API for translating a compile time Query model into a query at compilation time and provides runtime support for the following backends:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#hibernate">JPA (Hibernate)</a> and <a href="#hibernateReactive">Hibernate Reactive</a></p>
</li>
<li>
<p><a href="#sql">SQL (JDBC, R2DBC)</a></p>
</li>
<li>
<p><a href="#mongo">MongoDB</a></p>
</li>
<li>
<p><a href="#azureCosmos">Azure Cosmos</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Further implementations for other databases are planned in the future.</p>
</div>
<div class="paragraph">
<p>The following sections will take you through the basics of querying and using Micronaut Data, if you wish to understand more detail about how Micronaut Data works check out the <a href="#howItWorks">How Micronaut Data Works</a> section.</p>
</div>
<div class="paragraph">
<p>At a fundamental level however what Micronaut Data does can be summed up in the following snippets. Given the following interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.context.annotation.Parameter;
import io.micronaut.data.annotation.Id;
import io.micronaut.data.annotation.ParameterExpression;
import io.micronaut.data.annotation.Query;
import io.micronaut.data.annotation.QueryHint;
import io.micronaut.data.annotation.Repository;
import io.micronaut.data.model.Page;
import io.micronaut.data.model.Pageable;
import io.micronaut.data.model.Slice;
import io.micronaut.data.repository.CrudRepository;

import java.util.List;

@Repository // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    Book find(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.context.annotation.Executable
import io.micronaut.context.annotation.Parameter
import io.micronaut.data.annotation.*
import io.micronaut.data.model.*
import io.micronaut.data.repository.CrudRepository

@Repository // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    @Executable
    Book find(String title)
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.context.annotation.Executable
import io.micronaut.context.annotation.Parameter
import io.micronaut.data.annotation.*
import io.micronaut.data.model.*
import io.micronaut.data.repository.CrudRepository

@Repository // <b class="conum">(1)</b>
interface BookRepository : CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    @Executable
    fun find(title: String): Book
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@Repository</code> annotation designates <code>BookRepository</code> as a data repository. Since, it is an interface, the <code>@Repository</code> annotation provides implementations at compilation time.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By extending <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a> you enable automatic generation of CRUD (Create, Read, Update, Delete) operations.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Micronaut Data computes the query for the <code>find</code> method automatically at compilation time making it available at runtime via annotation metadata:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
BeanContext beanContext;

@Test
void testAnnotationMetadata() {
    String query = beanContext.getBeanDefinition(BookRepository.class) // <b class="conum">(1)</b>
            .getRequiredMethod("find", String.class) // <b class="conum">(2)</b>
            .getAnnotationMetadata().stringValue(Query.class) // <b class="conum">(3)</b>
            .orElse(null);

    assertEquals( // <b class="conum">(4)</b>
            "SELECT book_ FROM example.Book AS book_ WHERE (book_.title = :p1)", query);

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Inject
BeanContext beanContext

void "test annotation metadata"() {
    given:"The value of the Query annotation"
    String query = beanContext.getBeanDefinition(BookRepository.class) // <b class="conum">(1)</b>
            .getRequiredMethod("find", String.class) // <b class="conum">(2)</b>
            .getAnnotationMetadata()
            .stringValue(Query.class) // <b class="conum">(3)</b>
            .orElse(null)

    expect:"The JPA-QL query to be correct" // <b class="conum">(4)</b>
    query == "SELECT book_ FROM example.Book AS book_ WHERE (book_.title = :p1)"
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Inject
lateinit var beanContext: BeanContext

@Test
fun testAnnotationMetadata() {
    val query = beanContext.getBeanDefinition(BookRepository::class.java) // <b class="conum">(1)</b>
            .getRequiredMethod&lt;Any&gt;("find", String::class.java) // <b class="conum">(2)</b>
            .annotationMetadata
            .stringValue(Query::class.java) // <b class="conum">(3)</b>
            .orElse(null)


    assertEquals( // <b class="conum">(4)</b>
            "SELECT book_ FROM example.Book AS book_ WHERE (book_.title = :p1)",
            query
    )

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/inject/BeanDefinition.html">BeanDefinition</a> is retrieved from the <a href="https://docs.micronaut.io/latest/api/io/micronaut/context/BeanContext.html">BeanContext</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>find</code> method is retrieved</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The value of the <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation is retrieved</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The JPA-QL query for the method is correct</td>
</tr>
</table>
</div>

<h2 id="repository"><a class="anchor" href="#repository"></a>1.1 Repository</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/repository.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>You can find the source code of this project in this repository:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/micronaut-projects/micronaut-data">https://github.com/micronaut-projects/micronaut-data</a></p>
</div>

<h2 id="whatsNew"><a class="anchor" href="#whatsNew"></a>1.2 What's New?</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/whatsNew.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect2">
<h3 id="_micronaut_data_4_2">Micronaut Data 4.2</h3>
<div class="ulist">
<ul>
<li>
<p>Procedure invocations in repositories for <a href="#hibernateProcedures">Data JPA</a> and <a href="#dbcProcedures">Data JDBC/R2DBC</a></p>
</li>
<li>
<p>Added possibility to have associations (JOINs) in DTOs</p>
</li>
<li>
<p>Support for inserts, updates and deletes with <code>RETURNING</code> clause in repositories</p>
</li>
<li>
<p>MongoDB: Support <a href="https://www.mongodb.com/docs/manual/reference/operator/update/positional-filtered/"><code>arrayFilters</code></a></p>
</li>
<li>
<p>Kotlin: New coroutine variations of connection / transaction operations:</p>
<div class="ulist">
<ul>
<li>
<p><code>io.micronaut.data.connection.kotlin.CoroutineConnectionOperations</code></p>
</li>
<li>
<p><code>io.micronaut.transaction.kotlin.CoroutineTransactionOperations</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>R2DBC: New <a href="../api/io/micronaut/data/connection/reactive/ReactiveConnectionSynchronization.html">connection status callback</a>. Corrected cancellation.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_4_1">Micronaut Data 4.1</h3>
<div class="ulist">
<ul>
<li>
<p>Support NESTED transaction propagation</p>
</li>
<li>
<p>Bugfixes</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_4_0">Micronaut Data 4.0</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://hibernate.org/orm/documentation/6.0/">Hibernate 6</a></p>
</li>
<li>
<p><a href="https://hibernate.org/reactive/releases/2.0/">Hibernate Reactive 2</a> (Hibernate 6 compatible)</p>
</li>
<li>
<p>New implementation of the transaction and connection management</p>
</li>
<li>
<p>JPA repository <code>merge</code> method</p>
</li>
<li>
<p>Oracle JSON-Relational Duality Views Support</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_3_5">Micronaut Data 3.5</h3>
<div class="ulist">
<ul>
<li>
<p>Hibernate Reactive</p>
</li>
<li>
<p>Type-safe Java Criteria</p>
</li>
<li>
<p>Type-safe Kotlin Criteria and builders</p>
</li>
<li>
<p>Improved transaction handling</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_3_4">Micronaut Data 3.4</h3>
<div class="ulist">
<ul>
<li>
<p>New async, reactive and coroutines repositories to support pagination</p>
</li>
<li>
<p>Propagating synchronous transaction state in Kotlin&#8217;s coroutines</p>
</li>
<li>
<p>R2DBC upgraded to <code>1.0.0.RELEASE</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_3_3">Micronaut Data 3.3</h3>
<div class="ulist">
<ul>
<li>
<p>Support for <a href="#mongo">MongoDB repositories</a></p>
</li>
<li>
<p>R2DBC upgraded to Arabba-SR12 and OracleDB R2DBC 0.4.0</p>
</li>
<li>
<p>Propagating JDBC transaction context in Kotlin&#8217;s coroutines</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_3_2">Micronaut Data 3.2</h3>
<div class="ulist">
<ul>
<li>
<p>Repositories with JPA Criteria API specification for Micronaut JDBC/R2DBC</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_3_1">Micronaut Data 3.1</h3>
<div class="ulist">
<ul>
<li>
<p>Kotlin&#8217;s coroutines support. New repository interface <code>CoroutineCrudRepository</code></p>
</li>
<li>
<p>Support for <a href="#dbcAttributeConverter"><code>AttributeConverter</code></a></p>
</li>
<li>
<p>R2DBC upgraded to <code>Arabba-SR11</code></p>
</li>
<li>
<p>JPA Criteria specifications</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_3_0">Micronaut Data 3.0</h3>
<div class="ulist">
<ul>
<li>
<p>Micronaut 3.0</p>
</li>
<li>
<p>Hibernate optimizations</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_2_5_0">Micronaut Data 2.5.0</h3>
<div class="ulist">
<ul>
<li>
<p>Repositories now support batch insert/update/delete even with a custom query</p>
</li>
<li>
<p>Rewritten entity mapper allows more complex mapping for JDBC/R2DBC entities</p>
</li>
<li>
<p>Support for <code>@JoinTable</code> and <code>@JoinColumn</code> annotations</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut_data_2_4_0">Micronaut Data 2.4.0</h3>
<div class="ulist">
<ul>
<li>
<p>Full support for immutable entities. You can use Java 16 records or Kotlin immutable data classes</p>
</li>
<li>
<p>Integrated support for R2DBC, now the <code>data-r2dbc</code> module is a part of the data project and shares the same code with JDBC</p>
</li>
<li>
<p>Optimistic locking for JDBC/R2DBC</p>
</li>
</ul>
</div>
</div>

<h2 id="breaks"><a class="anchor" href="#breaks"></a>1.3 Breaking Changes</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/breaks.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>This section documents breaking changes between Micronaut versions</p>
</div>
<div class="sect1">
<h2 id="_4_0_0">4.0.0</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_repositories_validation">Repositories validation</h3>
<div class="paragraph">
<p>Default repository interfaces no longer have Jakarta Validation annotations to validate the entity and the ID.
To add the validation, annotate the repository&#8217;s generic type argument with Jakarta Validation annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Repository
public interface BookRepository implements CrudRepository&lt;@jakarta.validation.Valid Book, @jakarta.validation.constraints.NotNull Long&gt; {
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_repositories_now_return_list">Repositories now return <code>List</code></h3>
<div class="paragraph">
<p>Find all return type changed to be <code>List</code> instead of <code>Iterable</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_hibernate_transaction_manager">Hibernate transaction manager</h3>
<div class="paragraph">
<p>The signature of the Hibernate transaction manager has changed to include <code>org.hibernate.Session</code> instead of a data source connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
public TransactionOperations&lt;org.hibernate.Session&gt; hibernateTransactionOperations;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transaction_manager">Transaction manager</h3>
<div class="paragraph">
<p>Micronaut 4 comes with a rewritten transaction propagation and management. It replaces the previous implementation forked form Spring Framework.
The new implementation has a newly added connection management, allowing to share a connection between multiple repositories and services without an open transaction. The new method supporting extracting the current transaction status <code>TransactionOperations#findTransactionStatus</code>. The <code>TransactionStatus</code> now includes information about the connection and the transaction definition.</p>
</div>
</div>
<div class="sect2">
<h3 id="_async_and_reactive_repositories">Async and Reactive repositories</h3>
<div class="paragraph">
<p>Async and reactive repositories are no longer throw <code>EmptyResultException</code> if the entity is not found.</p>
</div>
</div>
</div>
</div>

<h2 id="releaseHistory"><a class="anchor" href="#releaseHistory"></a>1.4 Release History</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/introduction/releaseHistory.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>For this project, you can find a list of releases (with release notes) here:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/micronaut-projects/micronaut-data/releases">https://github.com/micronaut-projects/micronaut-data/releases</a></p>
</div>

<h1 id="buildConfig"><a class="anchor" href="#buildConfig"></a>2 Build Configuration</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/buildConfig.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Since Micronaut Data is a build time tool, it will not work correctly unless your build is configured correctly.</p>
</div>
<div class="paragraph">
<p>There are two important aspects to Micronaut Data:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The build time annotation processors</p>
</li>
<li>
<p>The runtime APIs</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The build time processor is added by adding the <code>micronaut-data-processor</code> module to your annotation processor configuration in either Gradle or Maven:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">annotationProcessor(<span class="hljs-string">"io.micronaut.data:micronaut-data-processor")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;annotationProcessorPaths&gt;
    &lt;path&gt;
        &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
        &lt;artifactId&gt;micronaut-data-processor&lt;/artifactId&gt;
    &lt;/path&gt;
&lt;/annotationProcessorPaths&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>For document databases like <a href="#mongo">MongoDB</a> or <a href="#azureCosmos">Azure Cosmos Data</a> instead of dependency above you need to use:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">annotationProcessor(<span class="hljs-string">"io.micronaut.data:micronaut-data-document-processor")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;annotationProcessorPaths&gt;
    &lt;path&gt;
        &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
        &lt;artifactId&gt;micronaut-data-document-processor&lt;/artifactId&gt;
    &lt;/path&gt;
&lt;/annotationProcessorPaths&gt;</code></pre>
</div>
</div></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For Kotlin, add the <code>micronaut-data-processor</code> or <code>micronaut-data-document-processor</code> dependency in <a href="https://docs.micronaut.io/4.4.3/guide/#kaptOrKsp">kapt or ksp scope</a>, and for Groovy add <code>micronaut-data-processor</code> or <code>micronaut-data-document-processor</code> in compileOnly scope.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use Micronaut Launch to create a pre-configured project:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Gradle</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Maven</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Java</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;lang=JAVA&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;lang=JAVA&amp;build=MAVEN">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kotlin</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;lang=KOTLIN&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;lang=KOTLIN&amp;build=MAVEN">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Groovy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;lang=GROOVY&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;lang=GROOVY&amp;build=MAVEN">Open</a></p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_micronaut_data_and_lombok">Micronaut Data and Lombok</h3>
<div class="paragraph">
<p>If you intend to use Lombok with Micronaut Data then you must place the Lombok annotation processor <strong>before</strong> the Micronaut processors in your build configuration since Micronaut needs to see the mutations to the AST that Lombok applies.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Lombok plugins like the Gradle plugin <code>io.franzbecker.gradle-lombok</code> are not supported as they place the annotation processors in an incorrect order.
</td>
</tr>
</table>
</div>
</div>

<h1 id="shared"><a class="anchor" href="#shared"></a>3 Shared Concepts</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The following sections describe shared concepts of all Micronaut Data modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#repositories">Repositories</a> - use existing or create a custom repository</p>
</li>
<li>
<p><a href="#querying">Querying</a> - define a repository method to access your data</p>
</li>
<li>
<p><a href="#dataUpdates">Data access</a> - data access operations</p>
</li>
<li>
<p><a href="#transactions">Transactions</a> - transactional access support</p>
</li>
</ul>
</div>

<h2 id="repositories"><a class="anchor" href="#repositories"></a>3.1 Repository Interfaces</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/repositories.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data repositories are defined as interfaces that are annotated with the <a href="../api/io/micronaut/data/annotation/Repository.html">@Repository</a> annotation.</p>
</div>
<div class="paragraph">
<p>The <a href="../api/io/micronaut/data/annotation/Repository.html">@Repository</a> annotation accepts an optional string value which represents the name of the connection or datasource in a multiple datasource scenario. By default, Micronaut Data will look for the default datasource.</p>
</div>
<div class="paragraph">
<p>It&#8217;s possible to annotate the repository injection point with <a href="../api/io/micronaut/data/annotation/Repository.html">@Repository</a> and set the data source name. Note that you cannot inject generic repositories, each repository needs to be bound to an entity.</p>
</div>
<div class="paragraph">
<p>The entity to treat as the root entity for the purposes of querying is established either from the method signature or from the generic type parameter specified to the <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> interface.</p>
</div>
<div class="paragraph">
<p>If no root entity can be established then a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>The following table summarizes the repository interfaces that come with Micronaut Data:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Builtin Repository Interfaces</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Interface</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A root interface that features no methods but defines the entity type and ID type as generic arguments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and adds methods to perform CRUD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/jpa/repository/JpaRepository.html">JpaRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a> and adds JPA specific methods like <code>merge</code> and <code>flush</code>. (requires JPA implementation)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/PageableRepository.html">PageableRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a> and adds methods for pagination</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/async/AsyncCrudRepository.html">AsyncCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and adds methods for asynchronous CRUD execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/async/AsyncPageableRepository.html">AsyncPageableRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/async/AsyncCrudRepository.html">AsyncCrudRepository</a> and adds methods for pagination</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactiveStreamsCrudRepository.html">ReactiveStreamsCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and adds CRUD methods that return <a href="https://www.reactive-streams.org/reactive-streams-1.0.3-javadoc/org/reactivestreams/Publisher.html">Publisher</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactiveStreamsPageableRepository.html">ReactiveStreamsPageableRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/reactive/ReactiveStreamsCrudRepository.html">ReactiveStreamsCrudRepository</a> and adds methods for pagination</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactorCrudRepository.html">ReactorCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/ReactiveStreamsCrudRepository.html">ReactiveStreamsCrudRepository</a> and is using Reactor return types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactorPageableRepository.html">ReactorPageableRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/reactive/ReactorCrudRepository.html">ReactorCrudRepository</a> and adds methods for pagination</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/RxJavaCrudRepository.html">RxJavaCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and adds CRUD methods that return RxJava 2 types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/kotlin/CoroutineCrudRepository.html">CoroutineCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and is using Kotlin coroutines for reactive CRUD operations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/kotlin/CoroutinePageableCrudRepository.html">CoroutinePageableCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/kotlin/CoroutineCrudRepository.html">CoroutineCrudRepository</a> and adds methods for pagination</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that in addition to interfaces you can also define repositories as abstract classes:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.Repository;
import io.micronaut.data.repository.CrudRepository;

import jakarta.persistence.EntityManager;
import java.util.List;

@Repository
public abstract class AbstractBookRepository implements CrudRepository&lt;Book, Long&gt; {

    private final EntityManager entityManager;

    public AbstractBookRepository(EntityManager entityManager) {
        this.entityManager = entityManager;
    }

    public List&lt;Book&gt; findByTitle(String title) {
        return entityManager.createQuery("FROM Book AS book WHERE book.title = :title", Book.class)
                    .setParameter("title", title)
                    .getResultList();
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.Repository
import io.micronaut.data.repository.CrudRepository

import jakarta.persistence.EntityManager

@Repository
abstract class AbstractBookRepository implements CrudRepository&lt;Book, Long&gt; {

    private final EntityManager entityManager

    AbstractBookRepository(EntityManager entityManager) {
        this.entityManager = entityManager
    }

    List&lt;Book&gt; findByTitle(String title) {
        return entityManager.createQuery("FROM Book AS book WHERE book.title = :title", Book)
                .setParameter("title", title)
                .getResultList()
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.Repository
import io.micronaut.data.repository.CrudRepository

import jakarta.persistence.EntityManager

@Repository
abstract class AbstractBookRepository(private val entityManager: EntityManager) : CrudRepository&lt;Book, Long&gt; {

    fun findByTitle(title: String): List&lt;Book&gt; {
        return entityManager.createQuery("FROM Book AS book WHERE book.title = :title", Book::class.java)
                .setParameter("title", title)
                .resultList
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the above example, using abstract classes can be useful as it allows you to combine custom code that interacts with a repository interface implemented automatically by Micronaut Data.</p>
</div>

<h2 id="validation"><a class="anchor" href="#validation"></a>3.2 Validation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/validation.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Repositories can have the entity and the ID values validated.
To add the validation, annotate the repository&#8217;s generic type argument with Jakarta Validation annotations:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.Repository;
import io.micronaut.data.repository.CrudRepository;

import jakarta.validation.Valid;
import jakarta.validation.constraints.Min;

@Repository
public interface AccountRepository extends CrudRepository&lt;@Valid Account, @Min(0) Long&gt; {
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.Repository
import io.micronaut.data.repository.CrudRepository

@Repository
interface AccountRepository extends CrudRepository&lt;@jakarta.validation.Valid Account, @jakarta.validation.constraints.Min(0) Long&gt; {
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.Repository
import io.micronaut.data.repository.CrudRepository

@Repository
interface AccountRepository : CrudRepository&lt;@jakarta.validation.Valid Account, @jakarta.validation.constraints.Min(0) Long&gt;</code></pre>
</div>
</div>

<h2 id="querying"><a class="anchor" href="#querying"></a>3.3 Writing Queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The implementation of querying in Micronaut Data is based on the dynamic finders in <a href="https://gorm.grails.org">GORM</a>.</p>
</div>
<div class="paragraph">
<p>A pattern matching approach is taken at compilation time. The general pattern of query methods is:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/finderpattern.svg" alt="finderpattern">
</div>
<div class="title">Figure 1. Query Method Pattern</div>
</div>
<div class="paragraph">
<p>As shown in Figure 1, the most common query stem is <code>find</code>, but you can also use <code>search</code>, <code>query</code>, <code>get</code>, <code>read</code> or <code>retrieve</code>.</p>
</div>
<div class="paragraph">
<p>The projection and ordering parts of the query pattern are optional (more on those later). The following snippet demonstrates 3 simple queries that use a different stem but perform the same query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book findByTitle(String title);

Book getByTitle(String title);

Book retrieveByTitle(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Book findByTitle(String title)

Book getByTitle(String title)

Book retrieveByTitle(String title)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findByTitle(title: String): Book

fun getByTitle(title: String): Book

fun retrieveByTitle(title: String): Book</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above examples return a single instance of an entity, the supported return types are described in the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Supported Return Types for Finder Methods</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Return Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Book</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>null</code> is retrieved only if the return type is nullable otherwise a <a href="../api/io/micronaut/data/exceptions/EmptyResultException.html">EmptyResultException</a> is thrown</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;Book&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.util.List</code> or any common <code>Iterable</code> type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Stream&lt;Book&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 <code>java.util.stream.Stream</code> instance</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;Book&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Page&lt;Book&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An instance of <a href="../api/io/micronaut/data/model/Page.html">Page</a> for pagination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Slice&lt;Book&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An instance of <a href="../api/io/micronaut/data/model/Slice.html">Slice</a> for pagination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Future&lt;Book&gt;</code> or <code>CompletableFuture&lt;Book&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.util.concurrent.Future</code> for asynchronous execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Publisher&lt;Book&gt;</code> (or 'Flowable', <code>Single</code>, <code>Maybe</code>, <code>Flux</code>, <code>Mono</code> etc.)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Reactive Streams compatible type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flow&lt;Book&gt;</code> as an alternative to <code>suspend</code> functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Kotlin reactive type. Requires <code>kotlinx-coroutines-reactive</code> dependency for the proper conversion.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primitive/Simple Types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In the case of projections primitive/basic types can be returned</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Methods with <code>Stream&lt;Book&gt;</code> results need to be used with a 'try-with-resources' block and should be executed within a transaction.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition, to the standard <code>findBy*</code> pattern, a few other patterns exist that have special return type requirements.</p>
</div>
<div class="paragraph">
<p>The following table summarizes the possible alternative patterns, behaviour and expected return types:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Method Patterns and Return Types</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Method Prefix</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Supported Return Types</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findBy</code>, <code>getBy</code>, <code>queryBy</code>, <code>retrieveBy</code>, <code>readBy</code>, <code>searchBy</code> following by <a href="#criteria">criteria</a> with method parameters for criteria predicates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An entity or any common <code>Iterable&lt;E&gt;</code> type, <code>Stream&lt;E&gt;</code>, <code>Optional&lt;E&gt;</code>, <code>Page&lt;E&gt;</code>, <code>Slice&lt;E&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find one or many records matching criteria</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>find</code>, <code>get</code>, <code>query</code>, <code>retrieve</code>, <code>read</code>, <code>search</code> with zero or many method parameters to match</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An entity or any common <code>Iterable&lt;E&gt;</code> type, <code>Stream&lt;E&gt;</code>, <code>Optional&lt;E&gt;</code>, <code>Page&lt;E&gt;</code>, <code>Slice&lt;E&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find one or many records matching properties (every method parameter should have a name after the property it wants to match)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>countBy</code> following by <a href="#criteria">criteria</a> with method parameters for criteria predicates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A primitive number of an instance of <code>java.lang.Number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the number of records matching criteria</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>count</code> with zero or many method parameters to match</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A primitive number of an instance of <code>java.lang.Number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the number of records matching properties</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>existsBy</code> following by <a href="#criteria">criteria</a> with method parameters for criteria predicates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A primitive or wrapper <code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks whether a record exists matching criteria</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exists</code> with zero or many method parameters to match</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A primitive or wrapper <code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks whether a record exists matching properties</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>save</code>, <code>persist</code>, <code>store</code>, <code>insert</code> with an entity or entities method parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>void</code> or an entity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inserts one or many instances</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delete</code>, <code>remove</code>, <code>erase</code>, <code>eliminate</code> with an entity or entities method parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>void</code> or <code>Number</code> return type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete one or many entries</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deleteBy</code>, <code>removeBy</code>, <code>eraseBy</code>, <code>eliminateBy</code> following by <a href="#criteria">criteria</a> with parameters for criteria predicates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>void</code> or <code>Number</code> return type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch delete matching criteria</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delete</code>, <code>remove</code>, <code>erase</code>, <code>eliminate</code> with zero or many method parameters to match</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>void</code> or <code>Number</code> return type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch delete where parameter/s represents an entity&#8217;s property (must be named the same)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update</code> with an entity or entities parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>void</code> or <code>Number</code> return type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update one or many entities</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update</code> + properties to update + <code>By</code> following by <a href="#criteria">criteria</a> with method parameters to match following by parameters for criteria predicates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>void</code> or <code>Number</code> return type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch update by properties</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update</code> with by method parameters to match (annotated @Id or @Version) followed by method parameters to update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>void</code> or <code>Number</code> return type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch update where parameter/s represents an entity&#8217;s property (must be named the same)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>saveReturning</code> all of the save variations plus a suffix <code>Returning</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An entity type or any types that can be returned by the query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert with a returning clause (Might not be supported by a DIALECT or an implementation)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updateReturning</code> all of the update variations plus a suffix <code>Returning</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An entity type or any types that can be returned by the query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update with a returning clause (Might not be supported by a DIALECT or an implementation)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deleteReturning</code> all of the delete variations plus a suffix <code>Returning</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An entity type or any types that can be returned by the query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete with a returning clause (Might not be supported by a DIALECT or an implementation)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that every method prefix can have <code>One</code> or <code>All</code> suffix: <code>findOneByTitle</code>, <code>countAllByTitle</code> etc.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
More details about the batch update variants of these methods is covered in the <a href="#dataUpdates">Data Updates</a> section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, as an alternative to the <code>By</code> syntax you also define simple finders that use the parameter names to match properties to query. This syntax is less flexible, but is more readable in certain circumstances. For example the following can be used as an alternative to <code>findByTitle</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book find(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Executable
Book find(String title)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Executable
fun find(title: String): Book</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in this case if the <code>title</code> parameter does not exist as a property in the entity being queried or the type does not match up a compilation error will occur. Also, you can specify more than one parameter to perform a logical <code>AND</code>.</p>
</div>

<h2 id="criteria"><a class="anchor" href="#criteria"></a>3.3.1 Query Criteria</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/criteria.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The previous example presented a simple <code>findByTitle</code> query which searches for all <code>Book</code> instances that have a <code>title</code> property <em>equal to</em> the given value.</p>
</div>
<div class="paragraph">
<p>This is the simplest type of query supported by Micronaut Data, but you can use an optional suffix on the property name to modify the type of criterion to apply.</p>
</div>
<div class="paragraph">
<p>For example the following query pattern will execute a query that finds only <code>Book</code> instances that have a page count greater than the given value:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Book&gt; findByPagesGreaterThan(int pageCount);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">List&lt;Book&gt; findByPagesGreaterThan(int pageCount)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findByPagesGreaterThan(pageCount: Int): List&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table summarizes the possible expressions and behaviour:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Property Criterion Expressions</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example Suffix</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Sample</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>After</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property is after the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByDateCreatedAfter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Before</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property is before the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByDateCreatedBefore</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Contains</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property contains the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTitleContains</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StartsWith</code> or <code>StartingWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property starts with the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTitleStartsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EndsWith</code> or <code>EndingWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property ends with the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTitleEndsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Equals</code> or <code>Equal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results equal to the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTitleEquals</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotEquals</code> or <code>NotEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results not equal to the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTitleNotEquals</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property is greater than the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByPagesGreaterThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThanEquals</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property is greater than or equal to the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByPagesGreaterThanEquals</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property is less than the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByPagesLessThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThanEquals</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property is less than or equal to the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByPagesLessThanEquals</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Like</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds string values "like" the given expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTitleLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Ilike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Case insensitive "like" query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTitleIlike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>InList</code> or <code>In</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property is that are contained within the given list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTitleInList</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code> or <code>InRange</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find results where the property is between the given values</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByDateCreatedBetween</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds results where the property is <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAuthorIsNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds results where the property is not <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAuthorIsNotNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsEmpty</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds results where the property is empty or <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAuthorIsEmpty</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotEmpty</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds results where the property is not empty or <code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAuthorIsNotEmpty</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>True</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds results where the property is true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAuthorEnabledTrue</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>False</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds results where the property is false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAuthorEnabledFalse</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ArrayContains</code> or <code>CollectionContains</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds results where the property which is an array or list contains given element. Supported only by Micronaut Data MongoDB and Azure Cosmos Db.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByTagsArrayContains</code> or <code>findByColorsCollectionContains</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Any of these criterion expressions can be negated by adding the word <code>Not</code> before the expression (for example <code>NotInList</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can combine multiple criterion by separating them with <code>And</code> or <code>Or</code> logical operators. For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Book&gt; findByPagesGreaterThanOrTitleLike(int pageCount, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">List&lt;Book&gt; findByPagesGreaterThanOrTitleLike(int pageCount, String title)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findByPagesGreaterThanOrTitleLike(pageCount: Int, title: String): List&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example uses <code>Or</code> to express a greater than condition and a like condition.</p>
</div>
<div class="paragraph">
<p>You can also negate any of the aforementioned expressions by adding <code>Not</code> prior the name of the expression (example <code>NotTrue</code> or <code>NotContain</code>).</p>
</div>

<h2 id="pagination"><a class="anchor" href="#pagination"></a>3.3.2 Pagination</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/pagination.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Typically, when returning multiple records you need some control over paging the data. Micronaut Data includes the ability to specify pagination requirements with the <a href="../api/io/micronaut/data/model/Pageable.html">Pageable</a> type (inspired by GORM&#8217;s <a href="https://gorm.grails.org/latest/api/grails/orm/PagedResultList.html">PagedResultList</a> and Spring Data&#8217;s <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Pageable.html">Pageable</a>).</p>
</div>
<div class="paragraph">
<p>In addition, methods can return a <a href="../api/io/micronaut/data/model/Page.html">Page</a> object which includes the execution of an additional query to obtain the total number of results for a given query.</p>
</div>
<div class="paragraph">
<p>The following are some example signatures:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Book&gt; findByPagesGreaterThan(int pageCount, Pageable pageable);

Page&lt;Book&gt; findByTitleLike(String title, Pageable pageable);

Slice&lt;Book&gt; list(Pageable pageable);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">List&lt;Book&gt; findByPagesGreaterThan(int pageCount, Pageable pageable)

Page&lt;Book&gt; findByTitleLike(String title, Pageable pageable)

Slice&lt;Book&gt; list(Pageable pageable)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findByPagesGreaterThan(pageCount: Int, pageable: Pageable): List&lt;Book&gt;

fun findByTitleLike(title: String, pageable: Pageable): Page&lt;Book&gt;

fun list(pageable: Pageable): Slice&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And some test data:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.saveAll(Arrays.asList(new Book("The Stand", 1000), new Book("The Shining", 600),
        new Book("The Power of the Dog", 500), new Book("The Border", 700),
        new Book("Along Came a Spider", 300), new Book("Pet Cemetery", 400), new Book("A Game of Thrones", 900),
        new Book("A Clash of Kings", 1100)));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.saveAll(Arrays.asList(
        new Book("The Stand", 1000),
        new Book("The Shining", 600),
        new Book("The Power of the Dog", 500),
        new Book("The Border", 700),
        new Book("Along Came a Spider", 300),
        new Book("Pet Cemetery", 400),
        new Book("A Game of Thrones", 900),
        new Book("A Clash of Kings", 1100)
))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.saveAll(Arrays.asList(
        Book(0,"The Stand", 1000),
        Book(0,"The Shining", 600),
        Book(0,"The Power of the Dog", 500),
        Book(0,"The Border", 700),
        Book(0,"Along Came a Spider", 300),
        Book(0,"Pet Cemetery", 400),
        Book(0,"A Game of Thrones", 900),
        Book(0,"A Clash of Kings", 1100)
))</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can execute queries and return paginated data using the <code>from</code> method of <a href="../api/io/micronaut/data/model/Pageable.html">Pageable</a> and specifying an appropriate return type:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Slice&lt;Book&gt; slice = bookRepository.list(Pageable.from(0, 3));
List&lt;Book&gt; resultList = bookRepository.findByPagesGreaterThan(500, Pageable.from(0, 3));
Page&lt;Book&gt; page = bookRepository.findByTitleLike("The%", Pageable.from(0, 3));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Slice&lt;Book&gt; slice = bookRepository.list(Pageable.from(0, 3))
List&lt;Book&gt; resultList =
        bookRepository.findByPagesGreaterThan(500, Pageable.from(0, 3))
Page&lt;Book&gt; page = bookRepository.findByTitleLike("The%", Pageable.from(0, 3))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val slice = bookRepository.list(Pageable.from(0, 3))
val resultList = bookRepository.findByPagesGreaterThan(500, Pageable.from(0, 3))
val page = bookRepository.findByTitleLike("The%", Pageable.from(0, 3))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>from</code> method accepts <code>index</code> and <code>size</code> arguments which are the page number to begin from and the number of records to return per page.</p>
</div>
<div class="paragraph">
<p>A <a href="../api/io/micronaut/data/model/Slice.html">Slice</a> is the same as a <a href="../api/io/micronaut/data/model/Page.html">Page</a> but results in one less query as it excludes the total number of pages calculation.</p>
</div>

<h2 id="cursored-pagination"><a class="anchor" href="#cursored-pagination"></a>3.3.3 Cursored Pagination</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/cursored-pagination.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data includes the ability to specify cursored pagination with the <a href="../api/io/micronaut/data/model/CursoredPageable.html">CursoredPageable</a> type.
For cursored page methods return a <a href="../api/io/micronaut/data/model/CursoredPage.html">CursoredPage</a> type (inspired by <a href="https://jakarta.ee/specifications/data/1.0/apidocs/jakarta.data/jakarta/data/page/cursoredpage">CursoredPage</a> in Jakarta Data).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Cursored pagination is currently only supported with Micronaut Data JDBC and R2DBC.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following are some example signatures:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CursoredPage&lt;Book&gt; find(CursoredPageable pageable); // <b class="conum">(1)</b>

CursoredPage&lt;Book&gt; findByPagesBetween(int minPageCount, int maxPageCount, Pageable pageable); // <b class="conum">(2)</b>

Page&lt;Book&gt; findByTitleStartingWith(String title, Pageable pageable); // <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">CursoredPage&lt;Book&gt; find(CursoredPageable pageable) // <b class="conum">(1)</b>

CursoredPage&lt;Book&gt; findByPagesBetween(int minPageCount, int maxPageCount, Pageable pageable) // <b class="conum">(2)</b>

Page&lt;Book&gt; findByTitleStartingWith(String title, Pageable pageable) // <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun find(pageable: CursoredPageable): CursoredPage&lt;Book&gt; // <b class="conum">(1)</b>

fun findByPagesBetween(minPageCount: Int, maxPageCount: Int, pageable: Pageable): CursoredPage&lt;Book&gt; // <b class="conum">(2)</b>

fun findByTitleStartingWith(title: String, pageable: Pageable): Page&lt;Book&gt;  // <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The signature defines a <a href="../api/io/micronaut/data/model/CursoredPageable.html">CursoredPageable</a> parameter and <a href="../api/io/micronaut/data/model/CursoredPage.html">CursoredPage</a> return type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The signature of method defines a <a href="../api/io/micronaut/data/model/CursoredPage.html">CursoredPage</a> return type, therefore method will throw an error if the request is not for the first page or is not cursored.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The method will return a <a href="../api/io/micronaut/data/model/CursoredPage.html">CursoredPage</a> only whenever a <a href="../api/io/micronaut/data/model/CursoredPageable.html">CursoredPageable</a> is supplied.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Therefore, you can use the repository methods to retrieve data with cursored pagination using the following queries:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CursoredPage&lt;Book&gt; page =  // <b class="conum">(1)</b>
    bookRepository.find(CursoredPageable.from(5, Sort.of(Order.asc("title"))));
CursoredPage&lt;Book&gt; page2 = bookRepository.find(page.nextPageable()); // <b class="conum">(2)</b>
CursoredPage&lt;Book&gt; pageByPagesBetween = // <b class="conum">(3)</b>
    bookRepository.findByPagesBetween(400, 700, Pageable.from(0, 3));
Page&lt;Book&gt; pageByTitleStarts = // <b class="conum">(4)</b>
    bookRepository.findByTitleStartingWith("The", CursoredPageable.from( 3, Sort.unsorted()));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">CursoredPage&lt;Book&gt; page =  // <b class="conum">(1)</b>
        bookRepository.find(CursoredPageable.from(5, Sort.of(Sort.Order.asc("title"))))
CursoredPage&lt;Book&gt; page2 = bookRepository.find(page.nextPageable()) // <b class="conum">(2)</b>
CursoredPage&lt;Book&gt; pageByPagesBetween = // <b class="conum">(3)</b>
        bookRepository.findByPagesBetween(400, 700, Pageable.from(0, 3))
Page&lt;Book&gt; pageByTitleStarts = // <b class="conum">(4)</b>
        bookRepository.findByTitleStartingWith("The", CursoredPageable.from( 3, Sort.unsorted()))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val page =  // <b class="conum">(1)</b>
    bookRepository.find(CursoredPageable.from(5, Sort.of(Sort.Order.asc("title"))))
val page2 = bookRepository.find(page.nextPageable()) // <b class="conum">(2)</b>
val pageByPagesBetween =  // <b class="conum">(3)</b>
    bookRepository.findByPagesBetween(400, 700, Pageable.from(0, 3))
val pageByTitleStarts =  // <b class="conum">(4)</b>
    bookRepository.findByTitleStartingWith("The", CursoredPageable.from(3, Sort.unsorted()))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a cursored pageable with a desired size and sorting and get a cursored page.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the next cursored pageable by calling <code>CursoredPage.getNextPageable()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Request first cursored page.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Supply a <code>CursoredPageable</code> to the repository method and a <code>CursoredPage</code> will be returned.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The cursor of pagination is based on the supplied sorting. If the supplied <a href="../api/io/micronaut/data/model/Sort.html">Sort</a> in pageable does not produce a unique sorting, Micronaut Data internally will additionally sort by the identity column and extend the cursor with the column value to make sure pagination works correctly.
</td>
</tr>
</table>
</div>

<h2 id="ordering"><a class="anchor" href="#ordering"></a>3.3.4 Ordering</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/ordering.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>You can control ordering of results by appending an <code>OrderBy*</code> expression to the end of the method name:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Book&gt; listOrderByTitle();

List&lt;Book&gt; listOrderByTitleDesc();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">List&lt;Book&gt; listOrderByTitle()

List&lt;Book&gt; listOrderByTitleDesc()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun listOrderByTitle(): List&lt;Book&gt;

fun listOrderByTitleDesc(): List&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>OrderBy*</code> expression refer to the property name to order by and can optionally be appended with either <code>Asc</code> or <code>Desc</code> to control ascending or descending order. Multiple conditions can be used by joining them with <code>And</code> like <code>findByTypeOrderByNameAndDate</code>.</p>
</div>

<h2 id="projections"><a class="anchor" href="#projections"></a>3.3.5 Query Projections</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/projections.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Frequently, rather than retrieving all the data for a particular entity, you may only want a single property or association of an entity or to perform some kind of computation and obtain just that result. This is where query projections come in.</p>
</div>
<div class="paragraph">
<p>The simplest form of projection is to retrieve a property or association. For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;String&gt; findTitleByPagesGreaterThan(int pageCount);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">List&lt;String&gt; findTitleByPagesGreaterThan(int pageCount)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findTitleByPagesGreaterThan(pageCount: Int): List&lt;String&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the <code>findTitleByPagesGreaterThan</code> method is resolving the <code>title</code> property of the <code>Book</code> entity and returning the data as a <code>List</code> of <code>String</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the projected property type and the return generic type do not match up then Micronaut Data will fail to compile the method.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also use projections on association paths, for example if an <code>author</code> association were present you could write <code>findAuthorNameByPagesGreaterThan</code> to retrieve the names of all the authors.</p>
</div>
<div class="paragraph">
<p>In addition to this, Micronaut Data also supports projection expressions. The following table summarizes the possible expressions with an example and description:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Projection Expressions</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Expression</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>countTitleByPagesGreaterThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CountDistinct</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>countDistinctTitleByPagesGreaterThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the distinct values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Distinct</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findDistinctTitleByPagesGreaterThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds the distinct property values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Max</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findMaxPagesByTitleLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds the maximum property value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Min</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findMinPagesByTitleLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds the minimum property value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Sum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findSumPagesByTitleLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds the sum of all the property values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Avg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findAvgPagesByTitleLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finds the average of all the property values</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can also use <code>top</code> or <code>first</code> to limit the results returned (as a simple alternative to pagination)</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Book&gt; findTop3ByTitleLike(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">List&lt;Book&gt; findTop3ByTitleLike(String title)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findTop3ByTitleLike(title: String): List&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above query will return the first 3 results for the given query expression.</p>
</div>

<h2 id="dto"><a class="anchor" href="#dto"></a>3.3.6 DTO Projections</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/dto.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data supports reflection-free Data Transfer Object (DTO) projections if the return type is annotated with <code>@Introspected</code>.</p>
</div>
<div class="paragraph">
<p>For example if you wanted to project on an entity called <code>Book</code> you could define a DTO as follows:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.Introspected;

@Introspected
public class BookDTO {

    private String title;
    private int pages;

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public int getPages() {
        return pages;
    }

    public void setPages(int pages) {
        this.pages = pages;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.Introspected

@Introspected
class BookDTO {
    String title
    int pages
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.core.annotation.Introspected

@Introspected
data class BookDTO(
    var title: String,
    var pages: Int
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DTO should include properties that match the property names you wish to project on (in this case <code>title</code> and <code>pages</code>). If any properties do not match then a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>You can then use the DTO object as return type in query methods:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">BookDTO findOne(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">BookDTO findOne(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findOne(title: String): BookDTO</code></pre>
</div>
</div>
<div class="paragraph">
<p>Micronaut Data will optimize the query to only select the necessary properties from the database.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can use <a href="../api/io/micronaut/data/annotation/NamingStrategy.html">@NamingStrategy</a> annotation to override the default naming strategy.
</td>
</tr>
</table>
</div>

<h2 id="explicitQueries"><a class="anchor" href="#explicitQueries"></a>3.3.7 Explicit Queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/explicitQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>If you want to have more control over the JPA-QL query then you can use the <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation to specify an explicit query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query("FROM Book b WHERE b.title = :t ORDER BY b.title")
List&lt;Book&gt; listBooks(String t);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query("FROM Book b WHERE b.title = :t ORDER BY b.title")
List&lt;Book&gt; listBooks(String t)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query("FROM Book b WHERE b.title = :t ORDER BY b.title")
fun listBooks(t: String): List&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You specify named parameters using colon (<code>:</code>) followed by the name and these must match a parameter specified to the method otherwise a compilation error will occur, use backslash <code>\:</code> to escape the colon that is not a parameter specification.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, Micronaut Data does not parse the JPA-QL AST and perform any further type checking hence greater care should be taken when using explicit queries. This may change in a future version of Micronaut Data.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that if the method returns a <a href="../api/io/micronaut/data/model/Page.html">Page</a> for pagination then you must additionally specify a query that performs the equivalent count using the <code>countQuery</code> member of the <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation.</p>
</div>

<h2 id="whereAnnotation"><a class="anchor" href="#whereAnnotation"></a>3.3.8 Modifying Queries with @Where</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/whereAnnotation.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>You can use the <a href="../api/io/micronaut/data/annotation/Where.html">@Where</a> annotation to modify compile time generated query with additional query criterion.</p>
</div>
<div class="paragraph">
<p>A common use case for this is to implement soft delete. For example considering the following <code>User</code> entity which declares an <code>enabled</code> property:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.*;
import io.micronaut.data.model.naming.NamingStrategies;

@MappedEntity(namingStrategy = NamingStrategies.Raw.class)
@Where("@.userEnabled = true") // <b class="conum">(1)</b>
public class User {
    @GeneratedValue
    @Id
    private Long id;
    private String userName;
    private boolean userEnabled = true; // <b class="conum">(2)</b>

    public User(String userName) {
        this.userName = userName;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUserName() {
        return userName;
    }

    public void setUserName(String userName) {
        this.userName = userName;
    }

    public boolean isUserEnabled() {
        return userEnabled;
    }

    public void setUserEnabled(boolean userEnabled) {
        this.userEnabled = userEnabled;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.EqualsAndHashCode
import io.micronaut.data.annotation.*

@MappedEntity
@Where("@.enabled = true") // <b class="conum">(1)</b>
@EqualsAndHashCode(includes = "name")
class User {
    @GeneratedValue
    @Id
    Long id
    String name
    boolean enabled = true // <b class="conum">(2)</b>

    User(String name) {
        this.name = name
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import io.micronaut.data.annotation.Where


@MappedEntity
@Where("@.enabled = true") // <b class="conum">(1)</b>
data class User(
    @GeneratedValue
    @field:Id
    var id: Long,
    val name: String,
    val enabled: Boolean // <b class="conum">(2)</b>
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="../api/io/micronaut/data/annotation/Where.html">@Where</a> annotation is used to declare that all queries should include <code>enabled = true</code> and <code>@</code> is a placeholder for the query&#8217;s alias.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>An <code>enabled</code> property exists on the entity</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can then easily modify the <code>delete</code> operations to instead issue an update. For example, consider the following repository implementation:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.NonNull;
import io.micronaut.data.annotation.Query;
import io.micronaut.data.jdbc.annotation.JdbcRepository;
import io.micronaut.data.model.query.builder.sql.Dialect;
import io.micronaut.data.repository.CrudRepository;
import jakarta.validation.constraints.NotNull;
import java.util.List;

@JdbcRepository(dialect = Dialect.H2)
public interface UserRepository extends CrudRepository&lt;User, Long&gt; { // <b class="conum">(1)</b>

    @Override
    @Query("UPDATE user SET userEnabled = false WHERE id = :id") // <b class="conum">(2)</b>
    void deleteById(@NonNull @NotNull Long id);

    @Query("SELECT * FROM user WHERE userEnabled = false") // <b class="conum">(3)</b>
    List&lt;User&gt; findDisabled();
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.NonNull
import io.micronaut.data.annotation.Query
import io.micronaut.data.jdbc.annotation.JdbcRepository
import io.micronaut.data.model.query.builder.sql.Dialect
import io.micronaut.data.repository.CrudRepository

import jakarta.validation.constraints.NotNull

@JdbcRepository(dialect = Dialect.H2)
interface UserRepository extends CrudRepository&lt;User, Long&gt; { // <b class="conum">(1)</b>

    @Override
    @Query("UPDATE user SET enabled = false WHERE id = :id") // <b class="conum">(2)</b>
    void deleteById(@NonNull @NotNull Long id)

    @Query("SELECT * FROM user WHERE enabled = false") // <b class="conum">(3)</b>
    List&lt;User&gt; findDisabled()
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.Query
import io.micronaut.data.jdbc.annotation.JdbcRepository
import io.micronaut.data.model.query.builder.sql.Dialect
import io.micronaut.data.repository.CrudRepository

@JdbcRepository(dialect = Dialect.H2)
interface UserRepository : CrudRepository&lt;User, Long&gt; { // <b class="conum">(1)</b>

    @Query("UPDATE user SET enabled = false WHERE id = :id") // <b class="conum">(2)</b>
    override fun deleteById(id: Long)

    @Query("SELECT * FROM user WHERE enabled = false") // <b class="conum">(3)</b>
    fun findDisabled(): List&lt;User&gt;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The interface extends <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>deleteById</code> is overridden to perform a soft delete by setting <code>enabled</code> to false.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An additional method is added to return disabled entities if needed using an explicit query.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All other queries performed on the entity will include <code>enabled = true</code> in the query statement.</p>
</div>
<div class="paragraph">
<p>It is also possible to override an entities <a href="../api/io/micronaut/data/annotation/Where.html">@Where</a> annotation by annotating a repository method with it.
The <code>findDisabled</code> example would then be:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.Where;

import java.util.List;

public interface UserRepositoryWithWhere {

    // ...

    @Where("@.enabled = false")
    List&lt;User&gt; findDisabled();
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.Where

interface UserRepositoryWithWhere {

    // ...

    @Where("@.enabled = false")
    List&lt;User&gt; findDisabled()
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.Where

interface UserRepositoryWithWhere {
    // ...
    @Where("@.enabled = false")
    fun findDisabled(): List&lt;User&gt;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to remove a <a href="../api/io/micronaut/data/annotation/Where.html">@Where</a> criteria from a particular repository method, you can use <a href="../api/io/micronaut/data/annotation/IgnoreWhere.html">@IgnoreWhere</a>.</p>
</div>

<h2 id="async"><a class="anchor" href="#async"></a>3.3.9 Asynchronous Queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/async.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data supports asynchronous query execution by defining methods that return either <code>CompletionStage</code>, <code>CompletableFuture</code> or <code>Future</code>.</p>
</div>
<div class="paragraph">
<p>In the case of asynchronous execution and if the backing implementation is blocking, Micronaut Data will use the <a href="https://docs.micronaut.io/latest/guide/index.html#reactiveServer">Configured I/O thread pool</a> to schedule the query execution on a different thread.</p>
</div>
<div class="paragraph">
<p>The following is an example of a couple of asynchronous methods:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Repository
public interface ProductRepository extends CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Join("manufacturer")
    CompletableFuture&lt;Product&gt; findByNameContains(String str);

    CompletableFuture&lt;Long&gt; countByManufacturerName(String name);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Repository
abstract class ProductRepository implements CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Join("manufacturer")
    abstract CompletableFuture&lt;Product&gt; findByNameContains(String str)

    abstract CompletableFuture&lt;Long&gt; countByManufacturerName(String name)
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Repository
interface ProductRepository : CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Join("manufacturer")
    fun findByNameContains(str: String): CompletableFuture&lt;Product&gt;

    fun countByManufacturerName(name: String): CompletableFuture&lt;Long&gt;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example defines two methods that use <code>CompletableFuture</code> as return type, the API for which you can use to compose query operations:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long total = productRepository.findByNameContains("o")
        .thenCompose(product -&gt; productRepository.countByManufacturerName(product.getManufacturer().getName()))
        .get(1000, TimeUnit.SECONDS);

Assertions.assertEquals(
        2,
        total
);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">when:"A result is retrieved using async composition"
long total = productRepository.findByNameContains("o")
        .thenCompose { product -&gt; productRepository.countByManufacturerName(product.manufacturer.name) }
        .get(1000, TimeUnit.SECONDS)

then:"the result is correct"
total == 2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val total = productRepository.findByNameContains("o")
        .thenCompose { product -&gt; productRepository.countByManufacturerName(product.manufacturer.name) }
        .get(1000, TimeUnit.SECONDS)

assertEquals(
        2,
        total
)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the case of JPA each operation will run with its own transaction and session, hence care needs to be taken to fetch the correct data and avoid detached objects. In addition, for more complex operations it may be more efficient to write custom code that uses a single session.
</td>
</tr>
</table>
</div>

<h2 id="reactive"><a class="anchor" href="#reactive"></a>3.3.10 Reactive Queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/querying/reactive.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data supports reactive query execution by defining methods that return either <a href="https://www.reactive-streams.org/reactive-streams-1.0.3-javadoc/org/reactivestreams/Publisher.html">Publisher</a>, Reactor or a RxJava 2 type. If you use Kotlin, you can use coroutines and <code>Flow</code>.</p>
</div>
<div class="paragraph">
<p>In the case of reactive execution and if the backing implementation is blocking, Micronaut Data will use the <a href="https://docs.micronaut.io/latest/guide/index.html#reactiveServer">Configured I/O thread pool</a> to schedule the query execution on a different thread.</p>
</div>
<div class="paragraph">
<p>If the backing implementation natively supports reactive types at the driver level then the I/O thread pool is not used, and instead it is assumed the driver will handle the query in a non-blocking manner.</p>
</div>
<div class="paragraph">
<p>The following is an example of a couple of reactive methods:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Join("manufacturer")
Maybe&lt;Product&gt; queryByNameContains(String str);

Single&lt;Long&gt; countDistinctByManufacturerName(String name);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Join("manufacturer")
abstract Maybe&lt;Product&gt; queryByNameContains(String str)

abstract Single&lt;Long&gt; countDistinctByManufacturerName(String name)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Join("manufacturer")
fun queryByNameContains(str: String): Maybe&lt;Product&gt;

fun countDistinctByManufacturerName(name: String): Single&lt;Long&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example defines two methods that use reactive return types from RxJava 2, the API for which you can use to compose query operations:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long total = productRepository.queryByNameContains("o")
        .flatMap(product -&gt; productRepository.countDistinctByManufacturerName(product.getManufacturer().getName())
                                .toMaybe())
        .defaultIfEmpty(0L)
        .blockingGet();

Assertions.assertEquals(
        2,
        total
);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">when:"A result is retrieved with reactive composition"
long total = productRepository.queryByNameContains("o")
        .flatMap { product -&gt; productRepository.countDistinctByManufacturerName(product.manufacturer.name).toMaybe() }
        .defaultIfEmpty(0L)
        .blockingGet()

then:"The result is correct"
total == 2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val total = productRepository.queryByNameContains("o")
        .flatMap { product -&gt;
            productRepository.countDistinctByManufacturerName(product.manufacturer.name)
                    .toMaybe()
        }
        .defaultIfEmpty(0L)
        .blockingGet()

assertEquals(
        2,
        total
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of JPA each operation will run with its own transaction and session, hence care needs to be taken to fetch the correct data and avoid detached objects.</p>
</div>
<div class="paragraph">
<p>In addition, for more complex operations it may be more efficient to write custom code that uses a single session.</p>
</div>

<h2 id="dataUpdates"><a class="anchor" href="#dataUpdates"></a>3.4 Accessing data</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/dataUpdates.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>There are various ways to perform read/write operations with Micronaut Data interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>extend one of the <a href="#repositories">builtin repository interfaces</a></p>
</li>
<li>
<p>simply define a new method with a <a href="#criteria">criteria query naming convention</a></p>
</li>
<li>
<p>define a new method with a custom query using <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation</p>
</li>
</ul>
</div>

<h2 id="inserts"><a class="anchor" href="#inserts"></a>3.4.1 Inserting</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/dataUpdates/inserts.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To insert data the simplest form is to define a method that accepts the type of the entity, the same way as the <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a> interface does:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
Book save(Book entity);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Book save(Book entity)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun save(entity: Book): Book</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method must accept a single argument that is the entity and start with either <code>save</code>, <code>persist</code>, <code>insert</code> or <code>store</code>, to persist multiple entities the method needs to accept <code>java.lag.Iterable</code> of the entity.</p>
</div>
<div class="paragraph">
<p>Alternatively you can also define a method that features parameter names that match the properties of the entity name:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book persist(String title, int pages);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Book persist(String title, int pages)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun persist(title: String, pages: Int): Book</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, when update of whole entity is intended, you must specify parameters for all properties other than those that are declared as <code>@Nullable</code> or as a <code>@GeneratedValue</code>, if you do not a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>The insert method can have a custom query defined by <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
@ParameterExpression(name = "title", expression = "#{book.title + 'ABC'}")
@ParameterExpression(name = "pages", expression = "#{book.pages}")
void insertCustomExp(Book book);

@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
void insertOne(Book book);

@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
void insertMany(Iterable&lt;Book&gt; books);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
void insert(String title, int pages)

@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
void insertOne(Book entity)

@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
void insertMany(Iterable&lt;Book&gt; entities)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
fun insert(title: String, pages: Int)

@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
fun insertOne(book: Book)

@Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
fun insertMany(books: Iterable&lt;Book&gt;)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is not possible to use the entity as the return type in partial updates because it would require an additional select to retrieve the additional information. A number type (int, long, etc.) can be returned to indicate the number of rows updated. The updated row count should be checked in most scenarios to ensure the update actually affected the row.
</td>
</tr>
</table>
</div>

<h2 id="updates"><a class="anchor" href="#updates"></a>3.4.2 Updating</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/dataUpdates/updates.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To update an entity you can once again pass the entity to the <code>update</code> method:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
Book update(Book newBook);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Book update(Book newBook)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun update(newBook: Book): Book</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, generally it is more efficient to use batch updates to only update the properties that have actually changed.</p>
</div>
<div class="paragraph">
<p>There are a couple of ways to achieve batch updates. One way is to define a method that features an argument annotated with <a href="../api/io/micronaut/data/annotation/Id.html">@Id</a>, starts with the stem <code>update</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void update(@Id Long id, int pages);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void update(@Id Long id, int pages)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun update(@Id id: Long?, pages: Int)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the ID of the entity will be used to query and perform an update on the entity with all the remaining arguments (in this case <code>pages</code>). If an argument does not match an existing property of the entity a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>Another alternative is to use <code>updateBy*</code> (the method should again return <code>void</code> or a <code>Number</code> indicating the number of records that were updated):</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void updateByTitle(String title, int pages);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void updateByTitle(String title, int pages)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun updateByTitle(title: String, pages: Int)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case you can use any finder expression to query on arbitrary properties and any remaining arguments that don&#8217;t form part of the query expression are used for the update. Once again if one of the remaining arguments does not match an existing property of the entity a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>You can also specify a custom query for the update methods:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query("UPDATE book SET title = :title where id = :id")
void updateOne(Book book);

@Query("UPDATE book SET title = :title where id = :id")
void updateMany(Iterable&lt;Book&gt; books);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query("UPDATE book SET title = :title where id = :id")
void updateOne(Book book)

@Query("UPDATE book SET title = :title where id = :id")
void updateMany(Iterable&lt;Book&gt; books)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query("UPDATE book SET title = :title where id = :id")
fun updateOne(book: Book)

@Query("UPDATE book SET title = :title where id = :id")
fun updateMany(books: Iterable&lt;Book&gt;)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query("UPDATE book SET title = :title where id = :id")
void updateOne(Book book);

@Query("UPDATE book SET title = :title where id = :id")
void updateMany(Iterable&lt;Book&gt; books);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query("UPDATE book SET title = :title where id = :id")
void updateOne(Book book)

@Query("UPDATE book SET title = :title where id = :id")
void updateMany(Iterable&lt;Book&gt; books)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query("UPDATE book SET title = :title where id = :id")
fun updateOne(book: Book)

@Query("UPDATE book SET title = :title where id = :id")
fun updateMany(books: Iterable&lt;Book&gt;)</code></pre>
</div>
</div>

<h2 id="deletes"><a class="anchor" href="#deletes"></a>3.4.3 Deleting</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/dataUpdates/deletes.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Deleting can be performed in a number of ways. To delete everything (use with care!) you can use <code>deleteAll</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
void deleteAll();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void deleteAll()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">override fun deleteAll()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>deleteAll</code> does not cascade. Delete all foreign key references first or use <code>delete</code> on all individual items.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To delete by ID or by the value of a property you can specify a parameter that matches a property of an entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void delete(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void delete(String title)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun delete(title: String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you can also use the <code>deleteBy*</code> pattern (the method must start with <code>delete</code>, <code>remove</code>, <code>erase</code> or <code>eliminate</code>) and any finder expression, for example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void deleteByTitleLike(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void deleteByTitleLike(String title)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun deleteByTitleLike(title: String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify A custom query for a delete method:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query("DELETE FROM Book WHERE title = :title")
void deleteOne(Book book);

@Query("DELETE FROM Book WHERE title = :title")
void deleteMany(Iterable&lt;Book&gt; books);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query("DELETE FROM Book WHERE title = :title")
void deleteOne(Book book)

@Query("DELETE FROM Book WHERE title = :title")
void deleteMany(Iterable&lt;Book&gt; books)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query("DELETE FROM Book WHERE title = :title")
fun deleteOne(book: Book)

@Query("DELETE FROM Book WHERE title = :title")
fun deleteMany(books: Iterable&lt;Book&gt;)</code></pre>
</div>
</div>

<h2 id="timestamps"><a class="anchor" href="#timestamps"></a>3.4.4 Entity Timestamps</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/dataUpdates/timestamps.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>It is common to want to add a field that represents the time when an entity was first persisted and the time when it was last updated.</p>
</div>
<div class="paragraph">
<p>You can annotate a property that is a date type of entity with <a href="../api/io/micronaut/data/annotation/DateCreated.html">@DateCreated</a> which will be automatically populated when saving entities and indicates the date a record was created.</p>
</div>
<div class="paragraph">
<p>You can also annotate a property that is a date type of entity with <a href="../api/io/micronaut/data/annotation/DateUpdated.html">@DateUpdated</a> which will be automatically populated whenever the entity is updated either via the <code>persist</code> method or when using one of the batch update methods of Micronaut Data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you update the entity with an external SQL statement or custom logic you will need to update the underlying <code>DateUpdated</code> column manually.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_jpa_hibernate_and_entity_timestamps">JPA Hibernate and Entity Timestamps</h3>
<div class="paragraph">
<p>The <a href="../api/io/micronaut/data/annotation/DateCreated.html">@DateCreated</a> and <a href="../api/io/micronaut/data/annotation/DateUpdated.html">@DateUpdated</a> annotations require a <code>ValidatorFactory</code> bean to be present in the application context when used with JPA Hibernate.
This can be provided by ensuring one of</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut:io.micronaut.validation:micronaut-validation")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut&lt;/groupId&gt;
    &lt;artifactId&gt;io.micronaut.validation&lt;/artifactId&gt;
    &lt;version&gt;micronaut-validation&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut:io.micronaut.beanvalidation:micronaut-hibernate-validator")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut&lt;/groupId&gt;
    &lt;artifactId&gt;io.micronaut.beanvalidation&lt;/artifactId&gt;
    &lt;version&gt;micronaut-hibernate-validator&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>is added to your project.</p>
</div>
</div>

<h2 id="entityEvents"><a class="anchor" href="#entityEvents"></a>3.4.5 Entity Events</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/dataUpdates/entityEvents.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Since 2.3, Micronaut Data supports defining entity event listeners for either JPA or JDBC using either annotations or by implementation the <a href="../api/io/micronaut/data/event/EntityEventListener.html">EntityEventListener</a> interface.</p>
</div>
<div class="paragraph">
<p>The following table lists the available event annotations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Entity Event Listener Annotations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Annotation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/event/PrePersist.html">@PrePersist</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered prior to persisting an object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/event/PostPersist.html">@PostPersist</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered after persisting an object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/event/PreRemove.html">@PreRemove</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered prior to deleting an object (note: doesn&#8217;t apply to batch deletes)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/event/PostRemove.html">@PostRemove</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered after to deleting an object (note: doesn&#8217;t apply to batch deletes)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/event/PreUpdate.html">@PreUpdate</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered prior to updating an object (note: doesn&#8217;t apply to batch updates)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/event/PostUpdate.html">@PostUpdate</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered after updating an object (note: doesn&#8217;t apply to batch updates)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use the JPA annotations in the <code>javax.persistence</code> package if you prefer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each event listener annotation can be applied to an instance method of an entity class (a JPA entity or a class annotated with ann:data.annotation.MappedEntity) in which case the method must return <code>void</code> and have zero arguments for example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import jakarta.persistence.Column;
import jakarta.persistence.Convert;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import jakarta.persistence.PrePersist;
import java.nio.charset.StandardCharsets;
import java.time.MonthDay;
import java.util.Base64;

@Entity
public class Account {
    @GeneratedValue
    @Id
    private Long id;
    private String username;
    private String password;
    @Column(columnDefinition = "date")
    @Convert(converter = MonthDayDateAttributeConverter.class)
    private MonthDay paymentDay;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public MonthDay getPaymentDay() {
        return paymentDay;
    }

    public void setPaymentDay(MonthDay paymentDay) {
        this.paymentDay = paymentDay;
    }

    @PrePersist
    void encodePassword() {
        this.password = Base64.getEncoder()
                .encodeToString(this.password.getBytes(StandardCharsets.UTF_8));
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import jakarta.persistence.*
import java.nio.charset.StandardCharsets

@Entity
class Account {
    @GeneratedValue
    @Id
    Long id
    String username
    String password

    @PrePersist
    void encodePassword() {
        this.password = Base64.encoder
                .encodeToString(this.password.getBytes(StandardCharsets.UTF_8))
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import java.nio.charset.StandardCharsets
import java.util.*
import jakarta.persistence.*

@Entity
data class Account(@GeneratedValue @Id
                   var id: Long? = null,
                   val username: String,
                   var password: String) {

    @PrePersist
    fun encodePassword() {
        password = Base64.getEncoder()
            .encodeToString(password.toByteArray(StandardCharsets.UTF_8))
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example defines a <code>@PrePersist</code> listener that encodes the password (in a not very secure base64 format, clearly not recommended!) prior to inserting into the database.</p>
</div>
<div class="paragraph">
<p>In addition, the annotations can be applied to any instance method of a Micronaut bean, in which case the method must return <code>void</code> and have a single argument that is the entity type (note the type can be <code>Object</code> to listener for all events). For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.event.PrePersist;

import jakarta.inject.Singleton;

@Singleton
public class AccountUsernameValidator {
    @PrePersist
    void validateUsername(Account account) {
        final String username = account.getUsername();
        if (username == null || !username.matches("[a-z0-9]+")) {
            throw new IllegalArgumentException("Invalid username");
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.event.PrePersist

import jakarta.inject.Singleton

@Singleton
class AccountUsernameValidator {
    @PrePersist
    void validateUsername(Account account) {
        final String username = account.username
        if (!username || !(username ==~ /[a-z0-9]+/)) {
            throw new IllegalArgumentException("Invalid username")
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.event.PrePersist
import jakarta.inject.Singleton

@Singleton
class AccountUsernameValidator {
    @PrePersist
    fun validateUsername(account: Account) {
        val username: String = account.username
        require(username.matches("[a-z0-9]+".toRegex())) { "Invalid username" }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above listener serves to validate the account username prior to any insert.</p>
</div>
<div class="paragraph">
<p>Finally, it is also possible to define a Micronaut bean that implements the <a href="../api/io/micronaut/data/event/EntityEventListener.html">EntityEventListener</a> interface or one of the functional interfaces that are sub-interfaces of the <a href="../api/io/micronaut/data/event/EntityEventListener.html">EntityEventListener</a> listed in the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Entity Event Listener Interfaces</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Interface</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/event/listeners/PrePersistListener.html">PrePersistListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered prior to persisting an object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/event/listeners/PostPersistListener.html">@PostPersistListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered after persisting an object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/event/listeners/PreRemoveListener.html">@PreRemoveListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered prior to deleting an object (note: doesn&#8217;t apply to batch deletes)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/event/listeners/PostRemoveListener.html">@PostRemoveListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered after to deleting an object (note: doesn&#8217;t apply to batch deletes)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/event/listeners/PreUpdateListener.html">@PreUpdateListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered prior to updating an object (note: doesn&#8217;t apply to batch updates)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/event/listeners/PostUpdateListener.html">@PostUpdateListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggered after updating an object (note: doesn&#8217;t apply to batch updates)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example the following Micronaut factory bean defines listeners that are executed before and after the <code>Book</code> entity is persisted:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.context.annotation.Factory;
import io.micronaut.data.event.listeners.PostPersistEventListener;
import io.micronaut.data.event.listeners.PrePersistEventListener;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import jakarta.inject.Singleton;

@Factory
public class BookListeners {
    private static final Logger LOG = LoggerFactory.getLogger(BookListeners.class);

    @Singleton
    PrePersistEventListener&lt;Book&gt; beforeBookPersist() { // <b class="conum">(1)</b>
        return (book) -&gt; {
            LOG.debug("Inserting book: {}", book.getTitle() );
            return true; // <b class="conum">(2)</b>
        };
    }

    @Singleton
    PostPersistEventListener&lt;Book&gt; afterBookPersist() { // <b class="conum">(3)</b>
        return (book) -&gt; LOG.debug("Book inserted: {}", book.getTitle() );
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.context.annotation.Factory
import io.micronaut.data.event.listeners.PostPersistEventListener
import io.micronaut.data.event.listeners.PrePersistEventListener
import org.slf4j.Logger
import org.slf4j.LoggerFactory

import jakarta.inject.Singleton

@Factory
class BookListeners {
    private static final Logger LOG = LoggerFactory.getLogger(BookListeners)

    @Singleton
    PrePersistEventListener&lt;Book&gt; beforeBookPersist() { // <b class="conum">(1)</b>
        return (book) -&gt; {
            LOG.debug "Inserting book: ${book.title}"
            return true // <b class="conum">(2)</b>
        }
    }

    @Singleton
    PostPersistEventListener&lt;Book&gt; afterBookPersist() { // <b class="conum">(3)</b>
        return (book) -&gt; LOG.debug("Book inserted: ${book.title}")
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.context.annotation.Factory
import io.micronaut.data.event.listeners.PostPersistEventListener
import io.micronaut.data.event.listeners.PrePersistEventListener
import org.slf4j.LoggerFactory
import jakarta.inject.Singleton

@Factory
class BookListeners {
    @Singleton
    fun beforeBookPersist(): PrePersistEventListener&lt;Book&gt; { // <b class="conum">(1)</b>
        return PrePersistEventListener { book: Book -&gt;
            LOG.debug("Inserting book: ${book.title}")
            true // <b class="conum">(2)</b>
        }
    }

    @Singleton
    fun afterBookPersist(): PostPersistEventListener&lt;Book&gt; { // <b class="conum">(3)</b>
        return PostPersistEventListener { book: Book -&gt;
            LOG.debug("Book inserted: ${book.title}")
        }
    }

    companion object {
        private val LOG = LoggerFactory.getLogger(BookListeners::class.java)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The factory returns a bean of type <a href="../api/io/micronaut/data/event/listeners/PrePersistListener.html">PrePersistListener</a> that includes <code>Book</code> as the generic argument</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>PrePersistListener</code> can return <code>false</code> if the operation should not proceed, if this case <code>true</code> is returned</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An additional <a href="../api/io/micronaut/data/event/listeners/PostPersistListener.html">@PostPersistListener</a> event listener is defined</td>
</tr>
</table>
</div>

<h2 id="transactions"><a class="anchor" href="#transactions"></a>3.5 Transactions</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/transactions.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data will automatically manage transactions for you. You can simply declare a method as transactional with the <code>jakarta.transaction.Transactional</code> annotation.</p>
</div>
<div class="paragraph">
<p>Micronaut Data maps the declared transaction annotation to the correct underlying semantics and compilation time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Starting Micronaut Data 4 repositories are no longer executed using a new transaction and will create a new connection if none is present.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you prefer Spring-managed transactions for Hibernate or JDBC you can add the <code>micronaut-data-spring</code> dependency and Spring-managed transactions will be used instead. See the section on <a href="#spring">Spring Support</a> for more information.
</td>
</tr>
</table>
</div>

<h2 id="programmaticTransactions"><a class="anchor" href="#programmaticTransactions"></a>3.5.1 Programmatic Transactions</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/transactions/programmaticTransactions.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>You can use the <a href="../api/io/micronaut/transaction/TransactionOperations.html">TransactionOperations</a> API to perform programmatic transactions.</p>
</div>
<div class="paragraph">
<p>The following demonstrates an example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.transaction.TransactionOperations;
import jakarta.inject.Singleton;
import jakarta.persistence.EntityManager;
import org.hibernate.Session;

@Singleton
public class ProductManager {

    private final EntityManager entityManager;
    private final TransactionOperations&lt;Session&gt; transactionManager;

    public ProductManager(EntityManager entityManager,
                          TransactionOperations&lt;Session&gt; transactionManager) { // <b class="conum">(1)</b>
        this.entityManager = entityManager;
        this.transactionManager = transactionManager;
    }

    Product save(String name, Manufacturer manufacturer) {
        return transactionManager.executeWrite(status -&gt; { // <b class="conum">(2)</b>
            final Product product = new Product(name, manufacturer);
            entityManager.persist(product);
            return product;
        });
    }

    Product find(String name) {
        return transactionManager.executeRead(status -&gt; // <b class="conum">(3)</b>
            status.getConnection().createQuery("from Product p where p.name = :name", Product.class)
                .setParameter("name", name)
                .getSingleResult()
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.transaction.TransactionOperations
import jakarta.inject.Singleton
import jakarta.persistence.EntityManager
import org.hibernate.Session

@Singleton
class ProductManager {

    private final EntityManager entityManager
    private final TransactionOperations&lt;Session&gt; transactionManager

    ProductManager(EntityManager entityManager,
                   TransactionOperations&lt;Session&gt; transactionManager) { // <b class="conum">(1)</b>
        this.entityManager = entityManager
        this.transactionManager = transactionManager
    }

    Product save(String name, Manufacturer manufacturer) {
        return transactionManager.executeWrite { // <b class="conum">(2)</b>
            Product product = new Product(name, manufacturer)
            entityManager.persist(product)
            return product
        }
    }

    Product find(String name) {
        return transactionManager.executeRead { status -&gt; // <b class="conum">(3)</b>
            status.getConnection().createQuery("from Product p where p.name = :name", Product)
                    .setParameter("name", name)
                    .singleResult
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.transaction.TransactionOperations
import jakarta.inject.Singleton
import jakarta.persistence.EntityManager
import org.hibernate.Session

@Singleton
class ProductManager(
    private val entityManager: EntityManager,
    private val transactionManager: TransactionOperations&lt;Session&gt; // <b class="conum">(1)</b>
) {

    fun save(name: String, manufacturer: Manufacturer): Product {
        return transactionManager.executeWrite { // <b class="conum">(2)</b>
            val product = Product(null, name, manufacturer)
            entityManager.persist(product)
            product
        }
    }

    fun find(name: String): Product {
        return transactionManager.executeRead { status -&gt;  // <b class="conum">(3)</b>
            status.connection.createQuery("from Product p where p.name = :name", Product::class.java)
                .setParameter("name", name)
                .singleResult
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The constructor is injected with the <a href="../api/io/micronaut/transaction/TransactionOperations.html">TransactionOperations</a> and a session-aware <code>EntityManager</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>save</code> method uses the <code>executeWrite</code> method to execute a write transaction within the context of the passed lambda.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>find</code> method uses the <code>executeRead</code> method to execute a read-only transaction within the context of the passed lambda. This example is accessing the session using the status provided by the transaction manager.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that if you are using Micronaut Data JDBC then instead of an <code>EntityManager</code> you should inject a contextual-connection-aware JDBC <code>Connection</code> object.</p>
</div>
<div class="paragraph">
<p>The following presents an example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.transaction.TransactionOperations;
import jakarta.inject.Singleton;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

@Singleton
public class ProductManager {

    private final Connection connection;
    private final TransactionOperations&lt;Connection&gt; transactionManager;
    private final ProductRepository productRepository;

    public ProductManager(Connection connection,
                          TransactionOperations&lt;Connection&gt; transactionManager, // <b class="conum">(1)</b>
                          ProductRepository productRepository) {
        this.connection = connection;
        this.transactionManager = transactionManager;
        this.productRepository = productRepository;
    }

    Product save(String name, Manufacturer manufacturer) {
        return transactionManager.executeWrite(status -&gt; { // <b class="conum">(2)</b>
            final Product product = new Product(name, manufacturer);
            try (PreparedStatement ps = connection.prepareStatement("insert into product (name, manufacturer_id) values (?, ?)")) {
                ps.setString(1, name);
                ps.setLong(2, manufacturer.getId());
                ps.execute();
            }
            return product;
        });
    }

    Product find(String name) {
        return transactionManager.executeRead(status -&gt; { // <b class="conum">(3)</b>
            try (PreparedStatement ps = status.getConnection().prepareStatement("select * from product p where p.name = ?")) {
                ps.setString(1, name);
                try (ResultSet rs = ps.executeQuery()) {
                    if (rs.next()) {
                        return new Product(rs.getString("name"), null);
                    }
                    return null;
                }
            }
        });
    }

    /**
     * Creates new product using transaction operations and product repository.
     *
     * @param name the product name
     * @param manufacturer the manufacturer
     * @return the created product instance
     */
    Product saveUsingRepo(String name, Manufacturer manufacturer) {
        return transactionManager.executeWrite(status -&gt; { // <b class="conum">(4)</b>
            return productRepository.save(new Product(name, manufacturer));
        });
    }

    /**
     * Finds product by name using transaction manager and product repository.
     *
     * @param name the product name
     * @return found product or null if none product found matching by name
     */
    Product findUsingRepo(String name) {
        return transactionManager.executeRead(status -&gt; { // <b class="conum">(5)</b>
            return productRepository.findByName(name).orElse(null);
        });
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.transaction.TransactionOperations
import jakarta.inject.Singleton

import java.sql.Connection
import java.sql.PreparedStatement
import java.sql.ResultSet

@Singleton
class ProductManager {

    private final Connection connection
    private final TransactionOperations&lt;Connection&gt; transactionManager
    private final ProductRepository productRepository

    ProductManager(Connection connection,
                   TransactionOperations&lt;Connection&gt; transactionManager, // <b class="conum">(1)</b>
                   ProductRepository productRepository) {
        this.connection = connection
        this.transactionManager = transactionManager
        this.productRepository = productRepository
    }

    Product save(String name, Manufacturer manufacturer) {
        return transactionManager.executeWrite { // <b class="conum">(2)</b>
            final Product product = new Product(name, manufacturer)
            connection.prepareStatement("insert into product (name, manufacturer_id) values (?, ?)")
                    .withCloseable { PreparedStatement ps -&gt;
                        ps.setString(1, name)
                        ps.setLong(2, manufacturer.getId())
                        ps.execute()
                    }
            return product
        }
    }

    Product find(String name) {
        return transactionManager.executeRead { status -&gt; // <b class="conum">(3)</b>
            status.getConnection().prepareStatement("select * from product p where p.name = ?").withCloseable {
                PreparedStatement ps -&gt;
                    ps.setString(1, name)
                    ps.executeQuery().withCloseable { ResultSet rs -&gt;
                        if (rs.next()) {
                            return new Product(rs.getString("name"), null)
                        }
                        return null
                    }
            }
        }
    }

    /**
     * Creates new product using transaction operations and product repository.
     *
     * @param name the product name
     * @param manufacturer the manufacturer
     * @return the created product instance
     */
    Product saveUsingRepo(String name, Manufacturer manufacturer) {
        return transactionManager.executeWrite(status -&gt; { // <b class="conum">(4)</b>
            return productRepository.save(new Product(name, manufacturer));
        })
    }

    /**
     * Finds product by name using transaction manager and product repository.
     *
     * @param name the product name
     * @return found product or null if none product found matching by name
     */
    Product findUsingRepo(String name) {
        return transactionManager.executeRead(status -&gt; { // <b class="conum">(5)</b>
            return productRepository.findByName(name).orElse(null);
        })
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.exceptions.EmptyResultException
import io.micronaut.transaction.TransactionOperations
import jakarta.inject.Singleton
import java.sql.Connection

@Singleton
class ProductManager(
    private val connection: Connection,
    private val transactionManager: TransactionOperations&lt;Connection&gt;, // <b class="conum">(1)</b>
    private val productRepository: ProductRepository
) {

    fun save(name: String, manufacturer: Manufacturer): Product {
        return transactionManager.executeWrite { // <b class="conum">(2)</b>
            val product = Product(0, name, manufacturer)
            connection.prepareStatement("insert into product (name, manufacturer_id) values (?, ?)").use { ps -&gt;
                ps.setString(1, name)
                ps.setLong(2, manufacturer.id!!)
                ps.execute()
            }
            product
        }
    }

    fun find(name: String): Product {
        return transactionManager.executeRead { status -&gt; // <b class="conum">(3)</b>
            status.connection.prepareStatement("select * from product p where p.name = ?").use { ps -&gt;
                    ps.setString(1, name)
                    ps.executeQuery().use { rs -&gt;
                        if (rs.next()) {
                            return@executeRead Product(
                                rs.getLong("id"), rs.getString("name"), null
                            )
                        }
                        throw EmptyResultException()
                    }
                }
        }
    }

    fun saveUsingRepo(name: String, manufacturer: Manufacturer): Product {
        return transactionManager.executeWrite { // <b class="conum">(4)</b>
            productRepository.save(Product(0, name, manufacturer))
        }
    }

    fun findUsingRepo(name: String): Product? {
        return transactionManager.executeRead { status -&gt; // <b class="conum">(5)</b>
            productRepository.findByName(name).orElse(null)
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The constructor is injected with the <a href="../api/io/micronaut/transaction/TransactionOperations.html">TransactionOperations</a> and a contextual-connection-aware <code>Connection</code>. Additional parameter is productRepository to demonstrate that Micronaut Data JDBC repository can also work with programmatic transactions.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>save</code> method uses the <code>executeWrite</code> method to execute a write transaction within the context of the passed lambda.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>find</code> method uses the <code>executeRead</code> method to execute a read-only transaction within the context of the passed lambda. This example is accessing the connection using the status provided by the transaction manager.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>saveUsingRepo</code> method uses <code>executeWrite</code> method to execute a write transaction within the context of the passed lambda and saves data using Micronaut Data JDBC repository. Please note that Micronaut Data JPA Repository can be used the same way.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>findUsingRepo</code> uses the <code>executeRead</code> method to execute a read-only transaction within the context of the passed lambda and finds data using Micronaut Data JDBC repository.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that it is important that you always use the injected connection as Micronaut Data makes available a transaction-aware implementation that uses the connection associated with the underlying transaction.</p>
</div>
<div class="paragraph">
<p>If a transaction is not active when using this connection then a <a href="../api/io/micronaut/transaction/exceptions/NoTransactionException.html">NoTransactionException</a> will be thrown indicating you should either provide a programmatic transaction or use <code>@Transactional</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For Kotlin suspended methods use <a href="../api/io/micronaut/transaction/kotlin/CoroutineTransactionOperations.html">CoroutineTransactionOperations</a>
</td>
</tr>
</table>
</div>

<h2 id="transactionalEvents"><a class="anchor" href="#transactionalEvents"></a>3.5.2 Transactional Events</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/transactions/transactionalEvents.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>You can write event listeners that are transaction aware using the <a href="../api/io/micronaut/transaction/annotation/TransactionalEventListener.html">@TransactionalEventListener</a> annotation.</p>
</div>
<div class="paragraph">
<p>The following demonstrates an example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.context.event.ApplicationEventPublisher;
import io.micronaut.transaction.annotation.TransactionalEventListener;
import jakarta.inject.Singleton;
import jakarta.transaction.Transactional;

@Singleton
public class BookManager {
    private final BookRepository bookRepository;
    private final ApplicationEventPublisher&lt;NewBookEvent&gt; eventPublisher;

    public BookManager(BookRepository bookRepository, ApplicationEventPublisher&lt;NewBookEvent&gt; eventPublisher) { // <b class="conum">(1)</b>
        this.bookRepository = bookRepository;
        this.eventPublisher = eventPublisher;
    }

    @Transactional
    void saveBook(String title, int pages) {
        final Book book = new Book(title, pages);
        bookRepository.save(book);
        eventPublisher.publishEvent(new NewBookEvent(book)); // <b class="conum">(2)</b>
    }

    @TransactionalEventListener
    void onNewBook(NewBookEvent event) {
        System.out.println("book = " + event.book); // <b class="conum">(3)</b>
    }

    static class NewBookEvent {
        final Book book;

        public NewBookEvent(Book book) {
            this.book = book;
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.context.event.ApplicationEventPublisher
import io.micronaut.transaction.annotation.TransactionalEventListener
import jakarta.inject.Singleton
import jakarta.transaction.Transactional

@Singleton
class BookManager {
    private final BookRepository bookRepository
    private final ApplicationEventPublisher&lt;NewBookEvent&gt; eventPublisher

    BookManager(BookRepository bookRepository, ApplicationEventPublisher&lt;NewBookEvent&gt; eventPublisher) { // <b class="conum">(1)</b>
        this.bookRepository = bookRepository
        this.eventPublisher = eventPublisher
    }

    @Transactional
    void saveBook(String title, int pages) {
        final Book book = new Book(title, pages)
        bookRepository.save(book)
        eventPublisher.publishEvent(new NewBookEvent(book)) // <b class="conum">(2)</b>
    }

    @TransactionalEventListener
    void onNewBook(NewBookEvent event) {
        println("book = $event.book") // <b class="conum">(3)</b>
    }

    static class NewBookEvent {
        final Book book

        NewBookEvent(Book book) {
            this.book = book
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.context.event.ApplicationEventPublisher
import io.micronaut.transaction.annotation.TransactionalEventListener
import jakarta.inject.Singleton
import jakarta.transaction.Transactional

@Singleton
open class BookManager(
        private val bookRepository: BookRepository, private val eventPublisher: ApplicationEventPublisher&lt;NewBookEvent&gt;) { // <b class="conum">(1)</b>

    @Transactional
    open fun saveBook(title: String, pages: Int) {
        val book = Book(0, title, pages)
        bookRepository.save(book)
        eventPublisher.publishEvent(NewBookEvent(book)) // <b class="conum">(2)</b>
    }

    @TransactionalEventListener
    open fun onNewBook(event: NewBookEvent) {
        println("book = ${event.book}") // <b class="conum">(3)</b>
    }

    class NewBookEvent(val book: Book)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>BookManager</code> class receives an instance of <code>ApplicationEventPublisher</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When the event is published if there is a running transaction then it will only trigger the listener once the transaction is committed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The listener itself is annotated with <a href="../api/io/micronaut/transaction/annotation/TransactionalEventListener.html">@TransactionalEventListener</a></td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can set the value of the <a href="../api/io/micronaut/transaction/annotation/TransactionalEventListener.html">@TransactionalEventListener</a> annotation to bind the listener to a particular transaction phase.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using <a href="../api/io/micronaut/transaction/annotation/TransactionalEventListener.html">@TransactionalEventListener</a> annotations for transaction events is not supported for reactive transactions.
</td>
</tr>
</table>
</div>

<h2 id="kotlinCriteria"><a class="anchor" href="#kotlinCriteria"></a>3.6 Kotlin Criteria API extensions</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/kotlinCriteria.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data includes experimental extensions and query builders for Jakarta Criteria API which simplifies writing queries with Kotlin.</p>
</div>
<div class="paragraph">
<p>Extensions and builders are located in <code>io.micronaut.data.runtime.criteria.KCriteriaBuilderExt</code> file.</p>
</div>
<div class="paragraph">
<p>There are simple extension methods that simplify working with the criteria API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KProperty.asPath(jakarta.persistence.criteria.Root): jakarta.persistence.criteria.Path</code> - Extension on the <code>KProperty</code> allowing to get type-safe property path: <code>Person::name.asPath(root)</code></p>
</li>
<li>
<p><code>operator Path.get(KProperty1): Path</code> chain property access: <code>root[Person::parent][Parent::name]</code></p>
</li>
<li>
<p><code>From.joinMany(KProperty1, JoinType): Join</code> join <code>*-to-many</code> relationship</p>
</li>
<li>
<p><code>From.joinOne(KProperty1, JoinType): Join</code> join <code>*-to-one</code> relationship</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_predicate_builder">Predicate builder</h3>
<div class="paragraph">
<p>To implement a simple predicate query a function <code>where</code> can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun nameEquals(name: String?) = where&lt;Person&gt; { root[Person::name] eq name }

fun ageIsLessThan(age: Int) = where&lt;Person&gt; { root[Person::age] lt age }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are contextual extension functions added to <code>jakarta.persistence.criteria.Expression</code> allowing to use predicate methods from <code>jakarta.persistence.criteria.CriteriaBuilder</code> directly on an expression instance. Most of them are infix functions allowing to use the syntax: <code>root[Person::name] eq "Xyz"</code>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s possible to use <code>and</code>, <code>or</code> for conjunction/disjunction and <code>not</code> for the negation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun nameOrAgeMatches(age: Int, name: String?) = where&lt;Person&gt; {
    or {
        root[Person::name] eq name
        root[Person::age] lt age
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s possible to use <code>where</code> predicate builder with following methods in <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>findOne(io.micronaut.data.repository.jpa.criteria.PredicateSpecification)</code></p>
</li>
<li>
<p><code>findAll(io.micronaut.data.repository.jpa.criteria.PredicateSpecification)</code></p>
</li>
<li>
<p><code>findAll(io.micronaut.data.repository.jpa.criteria.PredicateSpecification, io.micronaut.data.model.Sort)</code></p>
</li>
<li>
<p><code>findAll(io.micronaut.data.repository.jpa.criteria.PredicateSpecification, io.micronaut.data.model.Pageable)</code></p>
</li>
<li>
<p><code>count(io.micronaut.data.repository.jpa.criteria.PredicateSpecification)</code></p>
</li>
<li>
<p><code>deleteAll(io.micronaut.data.repository.jpa.criteria.PredicateSpecification)</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example using a join</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">personRepository.findOne(where {
    val manufacturer = root.joinOne(Product::manufacturer)
    manufacturer[Manufacturer::name] eq name
})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example deleting</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val recordsDeleted = personRepository.deleteAll(where {
    root[Person::name] eq "Denis"
})</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update_builder">Update builder</h3>
<div class="paragraph">
<p>To implement an update query a function <code>update</code> can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val updateQuery = update&lt;Person&gt; {
    set(Person::name, "Frank")
    where {
        root[Person::name] eq "Denis"
    }
}
personRepository.updateAll(updateQuery)</code></pre>
</div>
</div>
</div>

<h2 id="multitenancy"><a class="anchor" href="#multitenancy"></a>3.7 Multi-tenancy</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/multitenancy.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data supports multi-tenancy to allow the use of multiple databases or schemas by a single micronaut application.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Supported Multitenancy Modes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Multitenancy Mode</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATASOURCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A separate database with a separate connection pool is used to store each tenants data. Internally different repository operations  / transaction manager instance will be used for each tenant.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCHEMA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The same database, but different schemas are used to store each tenants data. Only supported by JDBC/R2DBC/MongoDB (collections)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DISCRIMINATOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A single database/schema stores all tenants' data, but a discriminator column separates the data.</p></td>
</tr>
</tbody>
</table>

<h2 id="discriminatormode"><a class="anchor" href="#discriminatormode"></a>3.7.1 Discriminator Mode</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/multitenancy/discriminatormode.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The DISCRIMINATOR mode uses a single entity&#8217;s property to store the tenant id.</p>
</div>
<div class="openblock">
<div class="title">Example of the configuration with one data source</div>
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">micronaut.data.multi-tenancy.mode=DISCRIMINATOR
micronaut.multitenancy.tenantresolver.httpheader.enabled=true
datasources.default.url=jdbc:h2:mem:db
datasources.default.driverClassName=org.h2.Driver
datasources.default.username=sa
datasources.default.password=
datasources.default.dialect=H2
datasources.default.schema-generate=CREATE_DROP</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
  data:
    multi-tenancy:
      mode: DISCRIMINATOR
  multitenancy:
    tenantresolver:
      httpheader:
        enabled: true

datasources:
  default:
    url: jdbc:h2:mem:db
    driverClassName: org.h2.Driver
    username: sa
    password: ''
    dialect: H2
    schema-generate: CREATE_DROP</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[micronaut]
  [micronaut.data]
    [micronaut.data.multi-tenancy]
      mode="DISCRIMINATOR"
  [micronaut.multitenancy]
    [micronaut.multitenancy.tenantresolver]
      [micronaut.multitenancy.tenantresolver.httpheader]
        enabled=true
[datasources]
  [datasources.default]
    url="jdbc:h2:mem:db"
    driverClassName="org.h2.Driver"
    username="sa"
    password=""
    dialect="H2"
    schema-generate="CREATE_DROP"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">micronaut {
  data {
    multiTenancy {
      mode = "DISCRIMINATOR"
    }
  }
  multitenancy {
    tenantresolver {
      httpheader {
        enabled = true
      }
    }
  }
}
datasources {
  'default' {
    url = "jdbc:h2:mem:db"
    driverClassName = "org.h2.Driver"
    username = "sa"
    password = ""
    dialect = "H2"
    schemaGenerate = "CREATE_DROP"
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  micronaut {
    data {
      multi-tenancy {
        mode = "DISCRIMINATOR"
      }
    }
    multitenancy {
      tenantresolver {
        httpheader {
          enabled = true
        }
      }
    }
  }
  datasources {
    default {
      url = "jdbc:h2:mem:db"
      driverClassName = "org.h2.Driver"
      username = "sa"
      password = ""
      dialect = "H2"
      schema-generate = "CREATE_DROP"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "micronaut": {
    "data": {
      "multi-tenancy": {
        "mode": "DISCRIMINATOR"
      }
    },
    "multitenancy": {
      "tenantresolver": {
        "httpheader": {
          "enabled": true
        }
      }
    }
  },
  "datasources": {
    "default": {
      "url": "jdbc:h2:mem:db",
      "driverClassName": "org.h2.Driver",
      "username": "sa",
      "password": "",
      "dialect": "H2",
      "schema-generate": "CREATE_DROP"
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The entity with multitenancy enabled requires a tenant property to be annotated with <a href="../api/io/micronaut/data/annotation/TenantId.html">TenantId</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity
public class Book {
    @Id
    @GeneratedValue
    private Long id;
    private String title;
    private int pages;
    @TenantId
    private String tenant;
// ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are specific annotations to alter the behaviour of repositories with <a href="../api/io/micronaut/data/annotation/TenantId.html">TenantId</a> property and its methods:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Annotation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/WithoutTenantId.html">WithoutTenantId</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The method&#8217;s query will not have implicit predicate to include the tenant id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/WithTenantId.html">WithTenantId</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modify the tenant id of the query</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The tenancy annotations are only supported for the discriminator multitenancy
</td>
</tr>
</table>
</div>

<h2 id="datasourcemode"><a class="anchor" href="#datasourcemode"></a>3.7.2 DataSource Mode</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/multitenancy/datasourcemode.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The DATASOURCE mode is used in combination with the micronaut-multitenancy library in order to resolve the tenant name.
In the below example, the tenant resolver is set to use a http header. See <a href="https://micronaut-projects.github.io/micronaut-multitenancy/latest/guide/">Micronaut Multitenancy</a> for more information.</p>
</div>
<div class="openblock">
<div class="title">Example of the configuration with two data sources to be chosen based on the tenancy</div>
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">micronaut.data.multi-tenancy.mode=DATASOURCE
micronaut.multitenancy.tenantresolver.httpheader.enabled=true
datasources.foo.url=jdbc:h2:mem:dbTenantFoo
datasources.foo.driverClassName=org.h2.Driver
datasources.foo.username=sa
datasources.foo.password=
datasources.foo.schema-generate=CREATE_DROP
datasources.foo.dialect=H2
datasources.bar.url=jdbc:h2:mem:dbTenantBar
datasources.bar.driverClassName=org.h2.Driver
datasources.bar.username=sa
datasources.bar.password=
datasources.bar.schema-generate=CREATE_DROP
datasources.bar.dialect=H2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
  data:
    multi-tenancy:
      mode: DATASOURCE
  multitenancy:
    tenantresolver:
      httpheader:
        enabled: true

datasources:
  foo:
    url: jdbc:h2:mem:dbTenantFoo
    driverClassName: org.h2.Driver
    username: sa
    password: ''
    schema-generate: CREATE_DROP
    dialect: H2
  bar:
    url: jdbc:h2:mem:dbTenantBar
    driverClassName: org.h2.Driver
    username: sa
    password: ''
    schema-generate: CREATE_DROP
    dialect: H2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[micronaut]
  [micronaut.data]
    [micronaut.data.multi-tenancy]
      mode="DATASOURCE"
  [micronaut.multitenancy]
    [micronaut.multitenancy.tenantresolver]
      [micronaut.multitenancy.tenantresolver.httpheader]
        enabled=true
[datasources]
  [datasources.foo]
    url="jdbc:h2:mem:dbTenantFoo"
    driverClassName="org.h2.Driver"
    username="sa"
    password=""
    schema-generate="CREATE_DROP"
    dialect="H2"
  [datasources.bar]
    url="jdbc:h2:mem:dbTenantBar"
    driverClassName="org.h2.Driver"
    username="sa"
    password=""
    schema-generate="CREATE_DROP"
    dialect="H2"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">micronaut {
  data {
    multiTenancy {
      mode = "DATASOURCE"
    }
  }
  multitenancy {
    tenantresolver {
      httpheader {
        enabled = true
      }
    }
  }
}
datasources {
  foo {
    url = "jdbc:h2:mem:dbTenantFoo"
    driverClassName = "org.h2.Driver"
    username = "sa"
    password = ""
    schemaGenerate = "CREATE_DROP"
    dialect = "H2"
  }
  bar {
    url = "jdbc:h2:mem:dbTenantBar"
    driverClassName = "org.h2.Driver"
    username = "sa"
    password = ""
    schemaGenerate = "CREATE_DROP"
    dialect = "H2"
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  micronaut {
    data {
      multi-tenancy {
        mode = "DATASOURCE"
      }
    }
    multitenancy {
      tenantresolver {
        httpheader {
          enabled = true
        }
      }
    }
  }
  datasources {
    foo {
      url = "jdbc:h2:mem:dbTenantFoo"
      driverClassName = "org.h2.Driver"
      username = "sa"
      password = ""
      schema-generate = "CREATE_DROP"
      dialect = "H2"
    }
    bar {
      url = "jdbc:h2:mem:dbTenantBar"
      driverClassName = "org.h2.Driver"
      username = "sa"
      password = ""
      schema-generate = "CREATE_DROP"
      dialect = "H2"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "micronaut": {
    "data": {
      "multi-tenancy": {
        "mode": "DATASOURCE"
      }
    },
    "multitenancy": {
      "tenantresolver": {
        "httpheader": {
          "enabled": true
        }
      }
    }
  },
  "datasources": {
    "foo": {
      "url": "jdbc:h2:mem:dbTenantFoo",
      "driverClassName": "org.h2.Driver",
      "username": "sa",
      "password": "",
      "schema-generate": "CREATE_DROP",
      "dialect": "H2"
    },
    "bar": {
      "url": "jdbc:h2:mem:dbTenantBar",
      "driverClassName": "org.h2.Driver",
      "username": "sa",
      "password": "",
      "schema-generate": "CREATE_DROP",
      "dialect": "H2"
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following HTTP clients will access a different tenant datasource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Header(name = "tenantId", value = "foo")
@Client("/books")
interface FooBookClient extends BookClient {
}

@Header(name = "tenantId", value = "bar")
@Client("/books")
interface BarBookClient extends BookClient {
}</code></pre>
</div>
</div>

<h2 id="schemamode"><a class="anchor" href="#schemamode"></a>3.7.3 Schema Mode</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/shared/multitenancy/schemamode.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The SCHEMA mode uses a single datasource and set the active schema based on the tenant resolved.</p>
</div>
<div class="openblock">
<div class="title">Example of the configuration with one datasource that will be used to switch schema based on the tenancy</div>
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">micronaut.data.multi-tenancy.mode=SCHEMA
micronaut.multitenancy.tenantresolver.httpheader.enabled=true
datasources.default.url=jdbc:h2:mem:db
datasources.default.driverClassName=org.h2.Driver
datasources.default.username=sa
datasources.default.password=
datasources.default.dialect=H2
datasources.default.schema-generate=CREATE_DROP
datasources.default.schema-generate-names[0]=foo
datasources.default.schema-generate-names[1]=bar</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
  data:
    multi-tenancy:
      mode: SCHEMA
  multitenancy:
    tenantresolver:
      httpheader:
        enabled: true

datasources:
  default:
    url: jdbc:h2:mem:db
    driverClassName: org.h2.Driver
    username: sa
    password: ''
    dialect: H2
    schema-generate: CREATE_DROP
    schema-generate-names:
      - foo
      - bar</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[micronaut]
  [micronaut.data]
    [micronaut.data.multi-tenancy]
      mode="SCHEMA"
  [micronaut.multitenancy]
    [micronaut.multitenancy.tenantresolver]
      [micronaut.multitenancy.tenantresolver.httpheader]
        enabled=true
[datasources]
  [datasources.default]
    url="jdbc:h2:mem:db"
    driverClassName="org.h2.Driver"
    username="sa"
    password=""
    dialect="H2"
    schema-generate="CREATE_DROP"
    schema-generate-names=[
      "foo",
      "bar"
    ]</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">micronaut {
  data {
    multiTenancy {
      mode = "SCHEMA"
    }
  }
  multitenancy {
    tenantresolver {
      httpheader {
        enabled = true
      }
    }
  }
}
datasources {
  'default' {
    url = "jdbc:h2:mem:db"
    driverClassName = "org.h2.Driver"
    username = "sa"
    password = ""
    dialect = "H2"
    schemaGenerate = "CREATE_DROP"
    schemaGenerateNames = ["foo", "bar"]
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  micronaut {
    data {
      multi-tenancy {
        mode = "SCHEMA"
      }
    }
    multitenancy {
      tenantresolver {
        httpheader {
          enabled = true
        }
      }
    }
  }
  datasources {
    default {
      url = "jdbc:h2:mem:db"
      driverClassName = "org.h2.Driver"
      username = "sa"
      password = ""
      dialect = "H2"
      schema-generate = "CREATE_DROP"
      schema-generate-names = ["foo", "bar"]
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "micronaut": {
    "data": {
      "multi-tenancy": {
        "mode": "SCHEMA"
      }
    },
    "multitenancy": {
      "tenantresolver": {
        "httpheader": {
          "enabled": true
        }
      }
    }
  },
  "datasources": {
    "default": {
      "url": "jdbc:h2:mem:db",
      "driverClassName": "org.h2.Driver",
      "username": "sa",
      "password": "",
      "dialect": "H2",
      "schema-generate": "CREATE_DROP",
      "schema-generate-names": ["foo", "bar"]
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can use property <code>schema-generate-names</code> to specify multiple schemas to be created and initialized for testing.
</td>
</tr>
</table>
</div>

<h1 id="hibernate"><a class="anchor" href="#hibernate"></a>4 Micronaut Data JPA Hibernate</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data JPA adds a support to have repositories with compile-time generated queries, JPA Criteria and a transaction management.</p>
</div>

<h2 id="hibernateJpaAnnotations"><a class="anchor" href="#hibernateJpaAnnotations"></a>4.1 JPA Annotations</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate/hibernateJpaAnnotations.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data JPA as of version 4.0.0 supports Hibernate 6 while earlier versions support Hibernate 5. You can use <code>javax.persistence</code> annotations such as <code>javax.persistence.Entity</code> to map your entities.</p>
</div>
<div class="paragraph">
<p>For Hibernate 6 Micronaut Data JPA supports <code>jakarta.persistence</code> annotations such as <code>jakarta.persistence.Entity</code> to map your entities.</p>
</div>

<h2 id="hibernateQuickStart"><a class="anchor" href="#hibernateQuickStart"></a>4.2 Quick Start</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate/hibernateQuickStart.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The quickest way to get started is to create a new Micronaut application with <a href="https://micronaut.io/launch/">Micronaut Launch</a> and choose the <code>data-jpa</code>, a database driver, pooling and a database migration framework features.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also find a great guide on building Micronaut Data JPA applications including sample code in a variety of languages in the Micronaut Guide: <a href="https://guides.micronaut.io/latest/micronaut-jpa-hibernate.html">Access a Database with Micronaut Data JPA</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Clicking on one of the links in the table below will take you to <a href="https://micronaut.io/launch/">Micronaut Launch</a> with the appropriate options already pre-configured with your selected language and build tool:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Creating an application with Micronaut Launch</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Gradle</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Maven</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Java</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jpa&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=JAVA&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jpa&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=JAVA&amp;build=MAVEN">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kotlin</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jpa&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=KOTLIN&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jpa&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=KOTLIN&amp;build=MAVEN">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Groovy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jpa&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=GROOVY&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jpa&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=GROOVY&amp;build=MAVEN">Open</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Creating an application with the CLI</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># For Maven add: --build maven
$ mn create-app --lang java example --features data-jpa,flyway,mysql,jdbc-hikari</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or via <code>curl</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating an application with <code>curl</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># For Maven add to the URL: &amp;build=maven
$ curl https://launch.micronaut.io/demo.zip?lang=java&amp;features=data-jpa,flyway,mysql,jdbc-hikari -o demo.zip &amp;&amp; unzip demo.zip -d demo &amp;&amp; cd demo</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When working with JDBC drivers it&#8217;s required to add a JDBC Connection Pool Module (Hikari, Tomcat JDBC or DBCP ) from the Micronaut SQL project.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use Micronaut SQL project documentation for more information regarding configuring <a href="https://micronaut-projects.github.io/micronaut-sql/latest/guide/index.html#hibernate">Hibernate</a>, <a href="https://micronaut-projects.github.io/micronaut-sql/latest/guide/index.html#jdbc">JDBC and pooling</a>.</p>
</div>
<div class="paragraph">
<p>You need to configure the data source in the application configuration file. For example for H2:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">datasources.default.url=jdbc:h2:mem:devDb
datasources.default.driverClassName=org.h2.Driver
datasources.default.username=sa
datasources.default.password=
datasources.default.schema-generate=CREATE_DROP
datasources.default.dialect=H2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">datasources:
  default:
    url: jdbc:h2:mem:devDb
    driverClassName: org.h2.Driver
    username: sa
    password: ''
    schema-generate: CREATE_DROP
    dialect: H2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[datasources]
  [datasources.default]
    url="jdbc:h2:mem:devDb"
    driverClassName="org.h2.Driver"
    username="sa"
    password=""
    schema-generate="CREATE_DROP"
    dialect="H2"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">datasources {
  'default' {
    url = "jdbc:h2:mem:devDb"
    driverClassName = "org.h2.Driver"
    username = "sa"
    password = ""
    schemaGenerate = "CREATE_DROP"
    dialect = "H2"
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  datasources {
    default {
      url = "jdbc:h2:mem:devDb"
      driverClassName = "org.h2.Driver"
      username = "sa"
      password = ""
      schema-generate = "CREATE_DROP"
      dialect = "H2"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "datasources": {
    "default": {
      "url": "jdbc:h2:mem:devDb",
      "driverClassName": "org.h2.Driver",
      "username": "sa",
      "password": "",
      "schema-generate": "CREATE_DROP",
      "dialect": "H2"
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And add the following configuration in the application configuration file.</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">jpa.default.entity-scan.packages=example.domain</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">jpa:
  default:
    entity-scan:
        packages: 'example.domain'</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[jpa]
  [jpa.default]
    [jpa.default.entity-scan]
      packages="example.domain"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">jpa {
  'default' {
    entityScan {
      packages = "example.domain"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  jpa {
    default {
      entity-scan {
        packages = "example.domain"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "jpa": {
    "default": {
      "entity-scan": {
        "packages": "example.domain"
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Where <code>jpa.default.entity-scan.packages</code> references the root package where your <code>@Entity</code> classes are located.</p>
</div>
<div class="paragraph">
<p>And ensure the implementation is configured correctly.</p>
</div>
<div class="paragraph">
<p>You can then define an <code>@Entity</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.serde.annotation.Serdeable;

import jakarta.persistence.*;

@Serdeable
@Entity
public class Book {
    @Id
    @GeneratedValue
    private Long id;
    private String title;
    private int pages;

    public Book(String title, int pages) {
        this.title = title;
        this.pages = pages;
    }

    public Book() {
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public int getPages() {
        return pages;
    }

    public void setPages(int pages) {
        this.pages = pages;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import jakarta.persistence.Entity
import jakarta.persistence.GeneratedValue
import jakarta.persistence.Id

@Entity
class Book {
    @Id
    @GeneratedValue
    Long id
    String title
    int pages

    Book(String title, int pages) {
        this.title = title
        this.pages = pages
    }

    Book() {
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.Entity
import jakarta.persistence.GeneratedValue
import jakarta.persistence.Id

@Entity
data class Book(@Id
                @GeneratedValue
                var id: Long,
                var title: String,
                var pages: Int = 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Followed by an interface that extends from <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a></p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.context.annotation.Parameter;
import io.micronaut.data.annotation.Id;
import io.micronaut.data.annotation.ParameterExpression;
import io.micronaut.data.annotation.Query;
import io.micronaut.data.annotation.QueryHint;
import io.micronaut.data.annotation.Repository;
import io.micronaut.data.model.Page;
import io.micronaut.data.model.Pageable;
import io.micronaut.data.model.Slice;
import io.micronaut.data.repository.CrudRepository;

import java.util.List;

@Repository // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    Book find(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.context.annotation.Executable
import io.micronaut.context.annotation.Parameter
import io.micronaut.data.annotation.*
import io.micronaut.data.model.*
import io.micronaut.data.repository.CrudRepository

@Repository // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    @Executable
    Book find(String title)
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.context.annotation.Executable
import io.micronaut.context.annotation.Parameter
import io.micronaut.data.annotation.*
import io.micronaut.data.model.*
import io.micronaut.data.repository.CrudRepository

@Repository // <b class="conum">(1)</b>
interface BookRepository : CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    @Executable
    fun find(title: String): Book
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The interface is annotated with <a href="../api/io/micronaut/data/annotation/Repository.html">@Repository</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>CrudRepository</code> interface take 2 generic arguments, the entity type (in this case <code>Book</code>) and the ID type (in this case <code>Long</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now perform CRUD (Create, Read, Update, Delete) operations on the entity. The implementation of <code>example.BookRepository</code> is created at compilation time. To obtain a reference to it simply inject the bean:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
BookRepository bookRepository;</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Inject BookRepository bookRepository</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Inject
lateinit var bookRepository: BookRepository</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_saving_an_instance_create">Saving an Instance (Create)</h3>
<div class="paragraph">
<p>To save an instance use the <code>save</code> method of the <code>CrudRepository</code> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book book = new Book();
book.setTitle("The Stand");
book.setPages(1000);
bookRepository.save(book);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Book book = new Book(title:"The Stand", pages:1000)
bookRepository.save(book)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">var book = Book(0,"The Stand", 1000)
bookRepository.save(book)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_an_instance_read">Retrieving an Instance (Read)</h3>
<div class="paragraph">
<p>To read a book back use <code>findById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">book = bookRepository.findById(id).orElse(null);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">book = bookRepository.findById(id).orElse(null)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">book = bookRepository.findById(id).orElse(null)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_an_instance_update">Updating an Instance (Update)</h3>
<div class="paragraph">
<p>To update an instance use <code>save</code> again:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">book.setTitle("Changed");
bookRepository.save(book);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">book.title = "Changed"
bookRepository.save(book)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">book.title = "Changed"
bookRepository.save(book)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For partial entity updates, custom update method like this can be used:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QueryHint(name = "jakarta.persistence.FlushModeType", value = "AUTO")
void updatePages(@Id Long id, @Parameter("pages") int pages);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@QueryHint(name = "jakarta.persistence.FlushModeType", value = "AUTO")
void updatePages(@Id Long id, @Parameter("pages") int pages)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@QueryHint(name = "jakarta.persistence.FlushModeType", value = "AUTO")
fun updatePages(@Id id: Long?, @Parameter("pages") pages: Int)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, in order for update to be propagated in the current session you can add <code>QueryHint</code> annotation to force session flush.</p>
</div>
<div class="paragraph">
<p>For Hibernate 6 instead of <code>javax.persistence.FlushModeType</code> need to use <code>jakarta.persistence.FlushModeType</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_an_instance_delete">Deleting an Instance (Delete)</h3>
<div class="paragraph">
<p>To delete an instance use <code>deleteById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.deleteById(id);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.deleteById(id)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.deleteById(id)</code></pre>
</div>
</div>
</div>

<h2 id="hibernateLogging"><a class="anchor" href="#hibernateLogging"></a>4.3 Logging SQL with Micronaut Data JPA Hibernate</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate/hibernateLogging.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>You can log your queries by setting <code>jpa.default.properties.hibernate.show_sql</code> and <code>jpa.default.properties.hibernate.format_sql</code> to <code>true</code> in your application&#8217;s configuration.</p>
</div>

<h2 id="hibernateJoinQueries"><a class="anchor" href="#hibernateJoinQueries"></a>4.4 Join queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate/hibernateJoinQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To optimize your queries you may need to alter joins to fetch exactly the data you need in the result set.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If a <code>LazyInitializationException</code> occurs this is not a bug in Micronaut Data or Hibernate, but instead an indication that you should alter your query joins to fetch the associated data you need to implement your use case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider a <code>Product</code> entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.persistence.*;

@Entity
class Product {

    @Id
    @GeneratedValue
    private Long id;
    private String name;
    @ManyToOne(optional = false, fetch = FetchType.LAZY)
    private Manufacturer manufacturer;

    public Product(String name, Manufacturer manufacturer) {
        this.name = name;
        this.manufacturer = manufacturer;
    }

    public Product() {
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Manufacturer getManufacturer() {
        return manufacturer;
    }

    public void setManufacturer(Manufacturer manufacturer) {
        this.manufacturer = manufacturer;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import jakarta.persistence.*

@Entity
class Product {

    @Id
    @GeneratedValue
    Long id
    String name
    @ManyToOne(optional = false, fetch = FetchType.LAZY)
    Manufacturer manufacturer

    Product(String name, Manufacturer manufacturer) {
        this.name = name
        this.manufacturer = manufacturer
    }

    Product() {
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">import jakarta.persistence.*

@Entity
data class Product(

    @Id
    @GeneratedValue
    var id: Long?,
    var name: String,
    @ManyToOne(optional = false, fetch = FetchType.LAZY)
    var manufacturer: Manufacturer
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That has an association to a <code>Manufacturer</code> entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.configuration.hibernate.jpa.proxy.GenerateProxy;
import org.hibernate.annotations.BatchSize;

import jakarta.persistence.*;

@Entity
@GenerateProxy
@BatchSize(size = 10)
public class Manufacturer {
    @Id
    @GeneratedValue
    private Long id;
    private String name;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import jakarta.persistence.*

@Entity
class Manufacturer {

    @Id
    @GeneratedValue
    Long id
    String name
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.*

@Entity
data class Manufacturer(
    @Id
    @GeneratedValue
    var id: Long?,
    var name: String
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case when you read each <code>Product</code> from the database an additional select is required to retrieve the <code>Manufacturer</code> for each <code>Product</code>. This leads to <code>N + 1</code> queries.</p>
</div>
<div class="paragraph">
<p>To resolve this you can use the <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation on your repository interface to specify that a <code>JOIN FETCH</code> should be executed to retrieve the associated <code>Manufacturer</code>.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Repository
public interface ProductRepository extends CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Join(value = "manufacturer", type = Join.Type.FETCH) // <b class="conum">(1)</b>
    List&lt;Product&gt; list();
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Repository
abstract class ProductRepository implements CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Join(value = "manufacturer", type = Join.Type.FETCH) // <b class="conum">(1)</b>
    abstract List&lt;Product&gt; list()
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Repository
interface ProductRepository : CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Join(value = "manufacturer", type = Join.Type.FETCH) // <b class="conum">(1)</b>
    fun list(): List&lt;Product&gt;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> is used to indicate a <code>JOIN FETCH</code> clause should be included.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation is repeatable and hence can be specified multiple times for different associations. In addition, the <code>type</code> member of the annotation can be used to specify the join type, for example <code>LEFT</code>, <code>INNER</code> or <code>RIGHT</code>.</p>
</div>
<div class="sect2">
<h3 id="_jpa_2_1_entity_graphs">JPA 2.1 Entity Graphs</h3>
<div class="paragraph">
<p>A JPA-specific alternative to specifying the joins to a query is to use JPA 2.1 entity graphs. With entity graphs you defer to the JPA implementation to pick the appropriate join type to use:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
@EntityGraph(attributePaths = {"manufacturer", "title"}) // <b class="conum">(1)</b>
List&lt;Product&gt; findAll();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@EntityGraph(attributePaths = ["manufacturer", "title"]) // <b class="conum">(1)</b>
abstract List&lt;Product&gt; findAll()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EntityGraph(attributePaths = ["manufacturer", "title"]) // <b class="conum">(1)</b>
override fun findAll(): List&lt;Product&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>attributePaths</code> member is used to specify the paths to include in the Entity graph.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_tests">Tests</h3>
<div class="paragraph">
<p>Please note that in tests using join collections, to make sure joins are consistently fetched the test might need to be made non-transactional using <code>@MicronautTest(transactional = false)</code>.</p>
</div>
</div>

<h2 id="hibernateExplicitQueries"><a class="anchor" href="#hibernateExplicitQueries"></a>4.5 Explicit queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate/hibernateExplicitQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>If you want to have more control over the query generated at the compile-time then you can use the <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation to specify an explicit query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query("FROM Book b WHERE b.title = :t ORDER BY b.title")
List&lt;Book&gt; listBooks(String t);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query("FROM Book b WHERE b.title = :t ORDER BY b.title")
List&lt;Book&gt; listBooks(String t)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query("FROM Book b WHERE b.title = :t ORDER BY b.title")
fun listBooks(t: String): List&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You specify named parameters using colon (<code>:</code>) followed by the name and these must match a parameter specified to the method otherwise a compilation error will occur, use backslash <code>\:</code> to escape the colon that is not a parameter specification.</p>
</div>
<div class="paragraph">
<p>Note that if the method returns a <a href="../api/io/micronaut/data/model/Page.html">Page</a> for pagination then you must additionally specify a query that performs the equivalent count using the <code>countQuery</code> member of the <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation.</p>
</div>

<h2 id="hibernateNativeQueries"><a class="anchor" href="#hibernateNativeQueries"></a>4.6 Native queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate/hibernateNativeQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>When using Micronaut Data with JPA you can execute native SQL queries by setting <code>nativeQuery</code> to true in the <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query(value = "select * from books b where b.title like :title limit 5",
       nativeQuery = true)
List&lt;Book&gt; findNativeBooks(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query(value = "select * from books b where b.title like :title limit 5",
        nativeQuery = true)
List&lt;Book&gt; findNativeBooks(String title)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query(value = "select * from books b where b.title like :title limit 5", nativeQuery = true)
fun findNativeBooks(title: String): List&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will execute the raw SQL against the database.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For <a href="#pagination">Pagination</a> queries that return a <a href="../api/io/micronaut/data/model/Page.html">Page</a> you also need to specify a native <code>countQuery</code>.
</td>
</tr>
</table>
</div>

<h2 id="hibernateProcedures"><a class="anchor" href="#hibernateProcedures"></a>4.7 Procedures</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate/hibernateProcedures.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>It&#8217;s possible to execute a stored procedure using the JPA provider:</p>
</div>
<div class="paragraph">
<p>Repository with procedure methods:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Repository
public interface ProductRepository extends CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Procedure(named = "calculateSum")
    long calculateSum(Long productId); // <b class="conum">(1)</b>

    @Procedure("calculateSumInternal")
    long calculateSumCustom(Long productId); // <b class="conum">(2)</b>
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Repository
abstract class ProductRepository implements CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Procedure(named = "calculateSum")
    abstract long calculateSum(Long productId);

    @Procedure("calculateSumInternal")
    abstract long calculateSumCustom(Long productId);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Repository
interface ProductRepository : CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Procedure(named = "calculateSum")
    fun calculateSum(productId: Long): Long

    @Procedure("calculateSumInternal")
    fun calculateSumCustom(productId: Long): Long
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An entity with named procedures defined:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.persistence.*;

@NamedStoredProcedureQuery(name = "calculateSum",
    procedureName = "calculateSumInternal",
    parameters = {
        @StoredProcedureParameter(name = "productId", mode = ParameterMode.IN, type = Long.class),
        @StoredProcedureParameter(name = "result", mode = ParameterMode.OUT, type = Long.class)
    }
)
@Entity
class Product {</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">import jakarta.persistence.*

@NamedStoredProcedureQuery(name = "calculateSum",
        procedureName = "calculateSumInternal",
        parameters = [
            @StoredProcedureParameter(name = "productId", mode = ParameterMode.IN, type = Long.class),
            @StoredProcedureParameter(name = "result", mode = ParameterMode.OUT, type = Long.class)
        ]
)
@Entity
class Product {</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">import jakarta.persistence.*

@NamedStoredProcedureQuery(
    name = "calculateSum",
    procedureName = "calculateSumInternal",
    parameters = [StoredProcedureParameter(
        name = "productId",
        mode = ParameterMode.IN,
        type = Long::class
    ), StoredProcedureParameter(name = "result", mode = ParameterMode.OUT, type = Long::class)]
)
@Entity
data class Product(</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The definition is referencing the named stored procedure defined in <code>Product</code> entity</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The definition is referencing the native database procedure name</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The output parameter, if present, is defined as the last output parameter of the procedure
</td>
</tr>
</table>
</div>

<h2 id="hibernateSpecifications"><a class="anchor" href="#hibernateSpecifications"></a>4.8 JPA specifications</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernate/hibernateSpecifications.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Based on the <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#specifications">same concept as Spring Data</a>, when you need to create queries dynamically by composing JPA criteria then you can implement the <a href="../api/io/micronaut/data/jpa/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface which provides multiple methods that receive an instance of <a href="../api/io/micronaut/data/jpa/repository/criteria/Specification.html">Specification</a> which can be used in combination with existing repository interfaces.</p>
</div>
<div class="paragraph">
<p>The <a href="../api/io/micronaut/data/jpa/repository/criteria/Specification.html">Specification</a> interface represents a simple Criteria-based API entry point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface Specification&lt;T&gt; {

    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root,
                          @NonNull CriteriaQuery&lt;?&gt; query,
                          @NonNull CriteriaBuilder criteriaBuilder);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example implementation demonstrates custom entity filtering using specifications:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    public static Specification&lt;Product&gt; nameEquals(String name) {
        return (root, query, criteriaBuilder)
                -&gt; criteriaBuilder.equal(root.get("name"), name);
    }

    public static Specification&lt;Product&gt; nameEqualsCaseInsensitive(String name) {
        return (root, query, criteriaBuilder)
                -&gt; criteriaBuilder.equal(criteriaBuilder.lower(root.get("name")), name.toLowerCase());
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">static class Specifications {

    static Specification&lt;Product&gt; nameEquals(String name) {
        return (root, query, criteriaBuilder)
                -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static Specification&lt;Product&gt; nameEqualsCaseInsensitive(String name) {
        return (root, query, criteriaBuilder)
                -&gt; criteriaBuilder.equal(criteriaBuilder.lower(root.get("name")), name.toLowerCase());
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {

    fun nameEquals(name: String) = Specification&lt;Product&gt; { root, _, criteriaBuilder -&gt;
        criteriaBuilder.equal(root.get&lt;String&gt;("name"), name)
    }

    fun nameEqualsCaseInsensitive(name: String) = Specification&lt;Product&gt; { root, _, criteriaBuilder -&gt;
        criteriaBuilder.equal(criteriaBuilder.lower(root.get("name")), name.toLowerCase())
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can create default methods in your repository class and provide dynamic implementation with a combination of multiple specifications:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Repository
public interface ProductRepository extends CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {

    @Transactional
    default List&lt;Product&gt; findByName(String name, boolean caseInsensitive, boolean includeBlank) {
        Specification&lt;Product&gt; specification;
        if (caseInsensitive) {
            specification = Specifications.nameEqualsCaseInsensitive(name);
        } else {
            specification = Specifications.nameEquals(name);
        }
        if (includeBlank) {
            specification = specification.or(Specifications.nameEquals(""));
        }
        return findAll(specification);
    }

    class Specifications {

        public static Specification&lt;Product&gt; nameEquals(String name) {
            return (root, query, criteriaBuilder)
                    -&gt; criteriaBuilder.equal(root.get("name"), name);
        }

        public static Specification&lt;Product&gt; nameEqualsCaseInsensitive(String name) {
            return (root, query, criteriaBuilder)
                    -&gt; criteriaBuilder.equal(criteriaBuilder.lower(root.get("name")), name.toLowerCase());
        }
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Repository
abstract class ProductRepository implements CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {

    @Transactional
    List&lt;Product&gt; findByName(String name, boolean caseInsensitive, boolean includeBlank) {
        Specification&lt;Product&gt; specification
        if (caseInsensitive) {
            specification = Specifications.nameEqualsCaseInsensitive(name)
        } else {
            specification = Specifications.nameEquals(name)
        }
        if (includeBlank) {
            specification = specification | Specifications.nameEquals("")
        }
        return findAll(specification)
    }

    static class Specifications {

        static Specification&lt;Product&gt; nameEquals(String name) {
            return (root, query, criteriaBuilder)
                    -&gt; criteriaBuilder.equal(root.get("name"), name)
        }

        static Specification&lt;Product&gt; nameEqualsCaseInsensitive(String name) {
            return (root, query, criteriaBuilder)
                    -&gt; criteriaBuilder.equal(criteriaBuilder.lower(root.get("name")), name.toLowerCase());
        }
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Repository
interface ProductRepository : CrudRepository&lt;Product, Long&gt;, JpaSpecificationExecutor&lt;Product&gt; {

    @Transactional
    fun findByName(name: String, caseInsensitive: Boolean, includeBlank: Boolean): List&lt;Product&gt; {
        var specification = if (caseInsensitive) {
            Specifications.nameEqualsCaseInsensitive(name)
        } else {
            Specifications.nameEquals(name)
        }
        if (includeBlank) {
            specification = specification.or(Specifications.nameEquals(""))
        }
        return findAll(specification)
    }

    object Specifications {

        fun nameEquals(name: String) = Specification&lt;Product&gt; { root, _, criteriaBuilder -&gt;
            check(criteriaBuilder.javaClass.getName().startsWith("org.hibernate"))
            criteriaBuilder.equal(root.get&lt;String&gt;("name"), name)
        }

        fun nameEqualsCaseInsensitive(name: String) = Specification&lt;Product&gt; { root, _, criteriaBuilder -&gt;
            criteriaBuilder.equal(criteriaBuilder.lower(root.get("name")), name.toLowerCase())
        }
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Micronaut Data, the preferred way is to have build-time generated queries. It&#8217;s recommended to use Criteria-based API only for queries that need to be generated dynamically at the runtime.
</td>
</tr>
</table>
</div>

<h1 id="hibernateReactive"><a class="anchor" href="#hibernateReactive"></a>5 Micronaut Data Hibernate Reactive</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/hibernateReactive.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Hibernate Reactive brings reactive to the traditional JPA.</p>
</div>
<div class="paragraph">
<p>By using Hibernate Reactive in combination with Micronaut Data you can use the same features as repositories, JPA criteria etc. but in a reactive way.</p>
</div>
<div class="paragraph">
<p>For more information about Hibernate Reactive refer to <a href="https://hibernate.org/reactive/documentation/">the official documentation</a>.</p>
</div>
<div class="paragraph">
<p>Include Hibernate reactive Micronaut Data support:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-hibernate-reactive")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-hibernate-reactive&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hibernate Reactive in Micronaut Data requires Hibernate 6
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration differs from the ordinary <a href="#hibernateQuickStart">Hibernate quick start</a> since Hibernate Reactive does not use traditional JDBC drivers but instead custom drivers provided by the <a href="https://vertx.io/docs/#databases">Vertx project</a>. You  need to select an appropriate driver for your database:</p>
</div>
<div class="paragraph">
<p>For MySQL:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.vertx:vertx-mysql-client")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.vertx&lt;/groupId&gt;
    &lt;artifactId&gt;vertx-mysql-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>For Postgres:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.vertx:vertx-pg-client")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.vertx&lt;/groupId&gt;
    &lt;artifactId&gt;vertx-pg-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>For Microsoft SQLServer:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.vertx:vertx-mssql-client")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.vertx&lt;/groupId&gt;
    &lt;artifactId&gt;vertx-mssql-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>For Oracle:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.vertx:vertx-oracle-client")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.vertx&lt;/groupId&gt;
    &lt;artifactId&gt;vertx-oracle-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>And configure it based on <a href="https://micronaut-projects.github.io/micronaut-sql/latest/guide/index.html#hibernate">Micronaut SQL Hibernate Reactive support</a>.</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">jpa.default.reactive=true
jpa.default.properties.hibernate.hbm2ddl.auto=create-drop
jpa.default.properties.hibernate.show_sql=true
jpa.default.properties.hibernate.connection.url=jdbc:mysql://localhost:3307/my_db
jpa.default.properties.hibernate.connection.username=myUser
jpa.default.properties.hibernate.connection.password=myPassword</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">jpa:
  default:
    reactive: true
    properties:
      hibernate:
        hbm2ddl:
          auto: create-drop
        show_sql: true
        connection:
          url: jdbc:mysql://localhost:3307/my_db
          username: myUser
          password: myPassword</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[jpa]
  [jpa.default]
    reactive=true
    [jpa.default.properties]
      [jpa.default.properties.hibernate]
        show_sql=true
        [jpa.default.properties.hibernate.hbm2ddl]
          auto="create-drop"
        [jpa.default.properties.hibernate.connection]
          url="jdbc:mysql://localhost:3307/my_db"
          username="myUser"
          password="myPassword"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">jpa {
  'default' {
    reactive = true
    properties {
      hibernate {
        hbm2ddl {
          auto = "create-drop"
        }
        show_sql = true
        connection {
          url = "jdbc:mysql://localhost:3307/my_db"
          username = "myUser"
          password = "myPassword"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  jpa {
    default {
      reactive = true
      properties {
        hibernate {
          hbm2ddl {
            auto = "create-drop"
          }
          show_sql = true
          connection {
            url = "jdbc:mysql://localhost:3307/my_db"
            username = "myUser"
            password = "myPassword"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "jpa": {
    "default": {
      "reactive": true,
      "properties": {
        "hibernate": {
          "hbm2ddl": {
            "auto": "create-drop"
          },
          "show_sql": true,
          "connection": {
            "url": "jdbc:mysql://localhost:3307/my_db",
            "username": "myUser",
            "password": "myPassword"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Hibernate reactive is non-blocking that repository interfaces and classes you define extend one of the reactive repositories:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Builtin Reactive Repository Interfaces</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Interface</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactiveStreamsCrudRepository.html">ReactiveStreamsCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and adds CRUD methods that return <a href="https://www.reactive-streams.org/reactive-streams-1.0.3-javadoc/org/reactivestreams/Publisher.html">Publisher</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactorCrudRepository.html">ReactorCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/ReactiveStreamsCrudRepository.html">ReactiveStreamsCrudRepository</a> and is using Reactor return types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/RxJavaCrudRepository.html">RxJavaCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and adds CRUD methods that return RxJava 2 types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/kotlin/CoroutineCrudRepository.html">CoroutineCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and is using Kotlin coroutines for reactive CRUD operations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/jpa/reactive/ReactiveStreamsJpaSpecificationExecutor.html">ReactiveStreamsJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reactive JPA Criteria executor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/jpa/reactive/ReactorJpaSpecificationExecutor.html">ReactorJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reactive JPA Criteria executor that exposes methods using Reactor <code>Flux</code>/<code>Mono</code> classes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following is an example Hibernate Reactive repository:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Repository // <b class="conum">(1)</b>
interface BookRepository extends ReactorCrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>

    Mono&lt;Book&gt; find(String title);

    Mono&lt;BookDTO&gt; findOne(String title);

    Flux&lt;Book&gt; findByPagesGreaterThan(int pageCount, Pageable pageable);

    Mono&lt;Page&lt;Book&gt;&gt; findByTitleLike(String title, Pageable pageable);

    Mono&lt;Slice&lt;Book&gt;&gt; list(Pageable pageable);

    @Transactional
    default Mono&lt;Void&gt; findByIdAndUpdate(Long id, Consumer&lt;Book&gt; bookConsumer) {
        return findById(id).map(book -&gt; {
            bookConsumer.accept(book);
            return book;
        }).then();
    }

    @Override
    Mono&lt;Book&gt; save(Book entity);

    @Override
    Mono&lt;Book&gt; update(Book newBook);

    Mono&lt;Void&gt; update(@Id Long id, int pages);

    @Override
    Mono&lt;Long&gt; deleteAll();

    Mono&lt;Void&gt; delete(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Repository // <b class="conum">(1)</b>
abstract class BookRepository implements ReactorCrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>

    abstract Mono&lt;Book&gt; find(String title);

    abstract Mono&lt;Page&lt;Book&gt;&gt; findByTitleLike(String title, Pageable pageable);

    abstract Mono&lt;BookDTO&gt; findOne(String title);

    abstract Flux&lt;Book&gt; findByPagesGreaterThan(int pageCount, Pageable pageable);

    abstract Mono&lt;Slice&lt;Book&gt;&gt; list(Pageable pageable);

    abstract Mono&lt;Book&gt; save(Book entity);

    @Transactional
    Mono&lt;Void&gt; findByIdAndUpdate(Long id, Consumer&lt;Book&gt; bookConsumer) {
        return findById(id).map(book -&gt; {
            bookConsumer.accept(book)
            return book
        }).then()
    }

    abstract Mono&lt;Book&gt; update(Book newBook);

    abstract Mono&lt;Void&gt; update(@Id Long id, int pages);

    @Override
    abstract Mono&lt;Long&gt; deleteAll();

    abstract Mono&lt;Void&gt; delete(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Repository // <b class="conum">(1)</b>
interface BookRepository : CoroutineCrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>

    suspend fun find(title: String): Book

    suspend fun findOne(title: String): BookDTO

    suspend fun findByPagesGreaterThan(pageCount: Int, pageable: Pageable): List&lt;Book&gt;

    suspend fun findByTitleLike(title: String, pageable: Pageable): Page&lt;Book&gt;

    suspend fun list(pageable: Pageable): Slice&lt;Book&gt;

    suspend fun save(entity: Book): Book

    @Query("INSERT INTO Book(title, pages) VALUES (:title, :pages)")
    suspend fun insert(title: String, pages: Int)

    @Transactional
    suspend fun findByIdAndUpdate(id: Long, bookConsumer: Consumer&lt;Book?&gt;) {
        bookConsumer.accept(findById(id))
    }

    suspend fun update(newBook: Book): Book

    suspend fun update(@Id id: Long?, pages: Int)

    suspend fun delete(title: String)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The interface is annotated with <a href="../api/io/micronaut/data/annotation/Repository.html">@Repository</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>ReactorCrudRepository</code> interface take 2 generic arguments, the entity type (in this case <code>Book</code>) and the ID type (in this case <code>Long</code>)</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_saving_an_instance_create">Saving an Instance (Create)</h3>
<div class="paragraph">
<p>To save an instance use the <code>save</code> method of the <code>ReactorCrudRepository</code> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book book = new Book();
book.setTitle("The Stand");
book.setPages(1000);
bookRepository.save(book).block();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Book book = new Book(title:"The Stand", pages:1000)
bookRepository.save(book).block()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">var book = Book(0, "The Stand", 1000)
bookRepository.save(book)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_an_instance_read">Retrieving an Instance (Read)</h3>
<div class="paragraph">
<p>To read a book back use <code>findById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">book = bookRepository.findById(id).block();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">book = bookRepository.findById(id).block()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">book = bookRepository.findById(id)!!</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_an_instance_update">Updating an Instance (Update)</h3>
<div class="paragraph">
<p>To update an instance we use a custom method to do an update in a transaction:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.findByIdAndUpdate(id, foundBook -&gt; {
    foundBook.setTitle("Changed");
}).block();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.findByIdAndUpdate(id) {
    it.title = "Changed"
}.block()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.findByIdAndUpdate(id) {
    it!!.title = "Changed"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_an_instance_delete">Deleting an Instance (Delete)</h3>
<div class="paragraph">
<p>To delete an instance use <code>deleteById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.deleteById(id).block();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.deleteById(id).block()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.deleteById(id)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The examples are using <code>block</code> to retrieve the result, in your application you should never block the reactive repository as it can lead to performance problems, and it might not be supported by the backing implementation.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
See the guide for <a href="https://guides.micronaut.io/latest/micronaut-data-hibernate-reactive.html">Access a Database with Micronaut Data and Hibernate Reactive</a> to learn more.
</td>
</tr>
</table>
</div>
</div>

<h1 id="dbc"><a class="anchor" href="#dbc"></a>6 Micronaut Data JDBC and R2DBC</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data JDBC / R2DBC is an implementation that pre-computes native SQL queries (given a particular database dialect) and provides a repository implementation that is a simple data mapper between a native result set and an entity.</p>
</div>
<div class="paragraph">
<p>Micronaut Data JDBC / R2DBC supports all the features of Micronaut Data for JPA including <a href="#criteria">dynamic finders</a>, <a href="#pagination">pagination</a>, <a href="#projections">projections</a>, <a href="#dto">Data Transfer Objects (DTO)</a>, <a href="#dataUpdates">Batch Updates</a>, <a href="#optimisticLocking">Optimistic locking</a> and so on.</p>
</div>
<div class="paragraph">
<p>However, Micronaut Data JDBC / R2DBC is not an Object Relational Mapping (ORM) implementation and does not and will not include any of the following concepts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lazy Loading or Proxying of Associations</p>
</li>
<li>
<p>Dirty Checking</p>
</li>
<li>
<p>Persistence Contexts / Sessions</p>
</li>
<li>
<p>First Level Caching and Entity Proxies</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Micronaut Data JDBC / R2DBC is designed for users who prefer a lower-level experience and working directly with SQL.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Micronaut Data JDBC / R2DBC is useful for implementing the majority of the simple SQL queries that exist in a typical application and does not include any runtime query building DSLs. For more complex queries Micronaut Data JDBC / R2DBC can be paired with one of the many great existing Java SQL DSLs out there like <a href="https://www.jooq.org">JOOQ</a>, <a href="http://www.querydsl.com">QueryDSL</a>, <a href="https://github.com/requery/requery">Requery</a> or even JPA.
</td>
</tr>
</table>
</div>

<h2 id="jdbc"><a class="anchor" href="#jdbc"></a>6.1 JDBC</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/jdbc.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data JDBC is designed for users who prefer a lower-level experience and working directly with SQL.</p>
</div>
<div class="paragraph">
<p>Following sections contains JDBC specific configuration and documentation.</p>
</div>

<h2 id="jdbcQuickStart"><a class="anchor" href="#jdbcQuickStart"></a>6.1.1 Quick Start</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/jdbc/jdbcQuickStart.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The quickest way to get started is to create a new Micronaut application with <a href="https://micronaut.io/launch/">Micronaut Launch</a> and choose the <code>data-jdbc</code>, a database driver and a database migration framework features. This can also be done via CLI.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also find a great guide on building Micronaut Data JDBC applications including sample code in a variety of languages in the Micronaut Guide: <a href="https://guides.micronaut.io/latest/micronaut-data-jdbc-repository.html">Access a Database with Micronaut Data JDBC</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Clicking on one of the links in the table below will take you to <a href="https://micronaut.io/launch/">Micronaut Launch</a> with the appropriate options already pre-configured with your selected language and build tool:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Creating a JDBC application with Micronaut Launch</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Gradle</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Maven</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Java</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=JAVA&amp;build=GRADLE" class="external">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=JAVA&amp;build=MAVEN" class="external">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kotlin</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=KOTLIN&amp;build=GRADLE" class="external">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=KOTLIN&amp;build=MAVEN" class="external">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Groovy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=GROOVY&amp;build=GRADLE" class="external">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-jdbc&amp;features=flyway&amp;features=mysql&amp;features=jdbc-hikari&amp;lang=GROOVY&amp;build=MAVEN" class="external">Open</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Creating an application with the CLI</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># For Maven add: --build maven
$ mn create-app --lang java example --features data-jdbc,flyway,mysql,jdbc-hikari</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or via <code>curl</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating an application with <code>curl</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># For Maven add to the URL: &amp;build=maven
$ curl https://launch.micronaut.io/demo.zip?lang=java&amp;features=data-jdbc,flyway,mysql,jdbc-hikari -o demo.zip &amp;&amp; unzip demo.zip -d demo &amp;&amp; cd demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated application will have a compile-scoped dependency on the <code>micronaut-data-jdbc</code> module and will use MySQL since we passed the <code>mysql</code> feature adding dependency on the JDBC driver for MySQL:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-jdbc")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>You should also ensure you have the JDBC driver and connection pool dependencies configured:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">runtimeOnly(<span class="hljs-string">"io.micronaut.sql:micronaut-jdbc-hikari")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.sql&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-jdbc-hikari&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>The annotation processor needs to have the Micronaut Data processor dependency properly setup to enable compile-time generation and evaluation:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">annotationProcessor(<span class="hljs-string">"io.micronaut.data:micronaut-data-processor")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;annotationProcessorPaths&gt;
    &lt;path&gt;
        &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
        &lt;artifactId&gt;micronaut-data-processor&lt;/artifactId&gt;
    &lt;/path&gt;
&lt;/annotationProcessorPaths&gt;</code></pre>
</div>
</div></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For Kotlin, add the <code>micronaut-data-processor</code> dependency in <a href="https://docs.micronaut.io/4.4.3/guide/#kaptOrKsp">kapt or ksp scope</a>, and for Groovy add <code>micronaut-data-processor</code> in compileOnly scope.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next up you need to configure at least one data source. The following snippet from the application configuration file is an example of configuring the default JDBC data source:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">datasources.default.url=jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER
datasources.default.driverClassName=org.h2.Driver
datasources.default.username=sa
datasources.default.password=
datasources.default.schema-generate=CREATE_DROP
datasources.default.dialect=H2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">datasources:
  default:
    url: jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER
    driverClassName: org.h2.Driver
    username: sa
    password: ''
    schema-generate: CREATE_DROP
    dialect: H2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[datasources]
  [datasources.default]
    url="jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER"
    driverClassName="org.h2.Driver"
    username="sa"
    password=""
    schema-generate="CREATE_DROP"
    dialect="H2"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">datasources {
  'default' {
    url = "jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER"
    driverClassName = "org.h2.Driver"
    username = "sa"
    password = ""
    schemaGenerate = "CREATE_DROP"
    dialect = "H2"
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  datasources {
    default {
      url = "jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER"
      driverClassName = "org.h2.Driver"
      username = "sa"
      password = ""
      schema-generate = "CREATE_DROP"
      dialect = "H2"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "datasources": {
    "default": {
      "url": "jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER",
      "driverClassName": "org.h2.Driver",
      "username": "sa",
      "password": "",
      "schema-generate": "CREATE_DROP",
      "dialect": "H2"
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>schema-generate</code> setting is only useful for demos and testing trivial examples, for production usage it is recommended you pair Micronaut Data with a SQL migration tool such as <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/index.html">Flyway</a> or <a href="https://micronaut-projects.github.io/micronaut-liquibase/latest/guide/index.html">Liquibase</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To retrieve objects from the database you need to define a class annotated with <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a>. Note that this is a meta annotation and in fact if you prefer you can use JPA annotations (only a subset are supported, more on that later). If you wish to use JPA annotations include the following <code>compileOnly</code> scoped dependency:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">compileOnly(<span class="hljs-string">"jakarta.persistence:jakarta.persistence-api")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;jakarta.persistence&lt;/groupId&gt;
    &lt;artifactId&gt;jakarta.persistence-api&lt;/artifactId&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>To use JPA annotations in the <code>javax.persistence</code> package use:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">compileOnly(<span class="hljs-string">"jakarta.persistence:jakarta.persistence-api")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;jakarta.persistence&lt;/groupId&gt;
    &lt;artifactId&gt;jakarta.persistence-api&lt;/artifactId&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you want to use JPA annotations in your entities with Micronaut Data JDBC, we strongly recommend you use <code>jakarta.persistence</code> annotations.  Micronaut Data will remove support for <code>javax.persistence</code> annotations in the future.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As above since only the annotations are used the dependency can be included only for compilation and not at runtime, so you don&#8217;t drag along the rest of the API, reducing your JAR file size.</p>
</div>
<div class="paragraph">
<p>You can then define an <code>@Entity</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import jakarta.persistence.*;

@Entity
public class Book {
    @Id
    @GeneratedValue
    private Long id;
    private String title;
    private int pages;

    public Book(String title, int pages) {
        this.title = title;
        this.pages = pages;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public int getPages() {
        return pages;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import jakarta.persistence.*

@Entity
class Book {
    @Id
    @GeneratedValue
    Long id
    private String title
    private int pages

    Book(String title, int pages) {
        this.title = title
        this.pages = pages
    }

    String getTitle() {
        return title
    }

    int getPages() {
        return pages
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.Entity
import jakarta.persistence.GeneratedValue
import jakarta.persistence.Id

@Entity
data class Book(@Id
                @GeneratedValue
                var id: Long,
                var title: String,
                var pages: Int = 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Followed by an interface that extends from <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a></p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.NonNull;
import io.micronaut.data.annotation.*;
import io.micronaut.data.annotation.sql.Procedure;
import io.micronaut.data.jdbc.annotation.JdbcRepository;
import io.micronaut.data.model.*;
import io.micronaut.data.model.query.builder.sql.Dialect;
import io.micronaut.data.repository.CrudRepository;
import java.util.List;


@JdbcRepository(dialect = Dialect.H2)        // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    Book find(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.NonNull
import io.micronaut.data.annotation.*
import io.micronaut.data.annotation.sql.Procedure
import io.micronaut.data.jdbc.annotation.JdbcRepository
import io.micronaut.data.model.*
import io.micronaut.data.model.query.builder.sql.Dialect
import io.micronaut.data.repository.CrudRepository
import java.util.List


@JdbcRepository(dialect = Dialect.H2)        // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    Book find(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.context.annotation.Executable
import io.micronaut.core.annotation.NonNull
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.Query
import io.micronaut.data.annotation.sql.Procedure
import io.micronaut.data.jdbc.annotation.JdbcRepository
import io.micronaut.data.model.*
import io.micronaut.data.model.query.builder.sql.Dialect
import io.micronaut.data.repository.CrudRepository
import jakarta.transaction.Transactional

@JdbcRepository(dialect = Dialect.H2) // <b class="conum">(1)</b>
interface BookRepository : CrudRepository&lt;Book, Long&gt; { // <b class="conum">(2)</b>
    @Executable
    fun find(title: String): Book
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The interface is annotated with <a href="../api/io/micronaut/data/jdbc/annotation/JdbcRepository.html">@JdbcRepository</a> and specifies a dialect of <code>H2</code> used to generate queries</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>CrudRepository</code> interface take 2 generic arguments, the entity type (in this case <code>Book</code>) and the ID type (in this case <code>Long</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now perform CRUD (Create, Read, Update, Delete) operations on the entity. The implementation of <code>example.BookRepository</code> is created at compilation time. To obtain a reference to it simply inject the bean:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject BookRepository bookRepository;</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Inject @Shared BookRepository bookRepository</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Inject
lateinit var bookRepository: BookRepository</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_saving_an_instance_create">Saving an Instance (Create)</h3>
<div class="paragraph">
<p>To save an instance use the <code>save</code> method of the <code>CrudRepository</code> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book book = new Book("The Stand", 1000);
bookRepository.save(book);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Book book = new Book("The Stand", 1000)
bookRepository.save(book)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">var book = Book(0,"The Stand", 1000)
bookRepository.save(book)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Unlike the JPA implementation there is no dirty checking so <code>save</code> always performs a SQL <code>INSERT</code>. For batch updates use an <code>update</code> method (see following section).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_an_instance_read">Retrieving an Instance (Read)</h3>
<div class="paragraph">
<p>To read a book back use <code>findById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">book = bookRepository.findById(id).orElse(null);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">book = bookRepository.findById(id).orElse(null)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">book = bookRepository.findById(id).orElse(null)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_an_instance_update">Updating an Instance (Update)</h3>
<div class="paragraph">
<p>With Micronaut Data JDBC, you must manually implement an <code>update</code> method since the JDBC implementation doesn&#8217;t include any dirty checking or persistence session notion. So you have to define explicit update methods for updates in your repository. For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void update(@Id Long id, int pages);

void update(@Id Long id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void update(@Id Long id, int pages);

void update(@Id Long id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun update(@Id id: Long?, pages: Int)

fun update(@Id id: Long?, title: String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which can then be called like so:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.update(book.getId(), "Changed");</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.update(book.getId(), "Changed")</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.update(book.id, "Changed")</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_an_instance_delete">Deleting an Instance (Delete)</h3>
<div class="paragraph">
<p>To delete an instance use <code>deleteById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.deleteById(id);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.deleteById(id)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.deleteById(id)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations you have implemented your first Micronaut Data JDBC repository! Read on to find out more.</p>
</div>
</div>

<h2 id="jdbcConfiguration"><a class="anchor" href="#jdbcConfiguration"></a>6.1.2 Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/jdbc/jdbcConfiguration.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect2">
<h3 id="_jdbc_driver">JDBC driver</h3>
<div class="paragraph">
<p>Micronaut Data JDBC requires that an appropriate <code>java.sql.DataSource</code> bean is configured.</p>
</div>
<div class="paragraph">
<p>You can either do this manually or use the <a href="https://micronaut-projects.github.io/micronaut-sql/latest/guide/#jdbc">Micronaut JDBC</a> module which provides out-of-the-box support for configuring connection pooling with either Tomcat JDBC, Hikari, Commons DBCP or Oracle UCP.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sql_logging">SQL Logging</h3>
<div class="paragraph">
<p>You can enable SQL logging by enabling trace logging for the <code>io.micronaut.data.query</code> logger. For example in <code>logback.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">Enabling SQL Query Logging</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;logger name="io.micronaut.data.query" level="trace" /&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_schema">Creating the Schema</h3>
<div class="paragraph">
<p>To create the database schema it is recommended you pair Micronaut Data with a SQL migration tool such as <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/index.html">Flyway</a> or <a href="https://micronaut-projects.github.io/micronaut-liquibase/latest/guide/index.html">Liquibase</a>.</p>
</div>
<div class="paragraph">
<p>SQL migration tools provide more complete support for creating and evolving your schema across a range of databases.</p>
</div>
<div class="paragraph">
<p>If you want to quickly test out Micronaut Data then you can set the <code>schema-generate</code> option of the data source to <code>create-drop</code> as well as the appropriate schema name:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most of the database migration tools use JDBC driver to make DB changes. If you use R2DBC you would need to separately configure JDBC data source.
</td>
</tr>
</table>
</div>
<div class="openblock">
<div class="title">Using <code>schema-generate</code></div>
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">datasources.default.url=jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER
datasources.default.driverClassName=org.h2.Driver
datasources.default.username=sa
datasources.default.password=
datasources.default.schema-generate=CREATE_DROP
datasources.default.dialect=H2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">datasources:
  default:
    url: jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER
    driverClassName: org.h2.Driver
    username: sa
    password: ''
    schema-generate: CREATE_DROP
    dialect: H2</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[datasources]
  [datasources.default]
    url="jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER"
    driverClassName="org.h2.Driver"
    username="sa"
    password=""
    schema-generate="CREATE_DROP"
    dialect="H2"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">datasources {
  'default' {
    url = "jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER"
    driverClassName = "org.h2.Driver"
    username = "sa"
    password = ""
    schemaGenerate = "CREATE_DROP"
    dialect = "H2"
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  datasources {
    default {
      url = "jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER"
      driverClassName = "org.h2.Driver"
      username = "sa"
      password = ""
      schema-generate = "CREATE_DROP"
      dialect = "H2"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "datasources": {
    "default": {
      "url": "jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE;NON_KEYWORDS=USER",
      "driverClassName": "org.h2.Driver",
      "username": "sa",
      "password": "",
      "schema-generate": "CREATE_DROP",
      "dialect": "H2"
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>schema-generate</code> option is currently only recommended for simple applications, testing and demos and is not considered production-ready. The dialect set in configuration is the dialect that will be used to generate the schema.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_the_dialect">Setting the Dialect</h3>
<div class="paragraph">
<p>As seen in the configuration above you should also configure the dialect. Although queries are precomputed in the repository some cases (like pagination) still require the dialect to specify. The following table summarizes the supported dialects:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Supported JDBC / R2DBC Dialects</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Dialect</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#H2">H2</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The H2 database (typically used for in-memory testing)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#MYSQL">MYSQL</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL 5.5 or above</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#POSTGRES">POSTGRES</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Postgres 9.5 or above</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#SQL_SERVER">SQL_SERVER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL Server 2012 or above</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#ORACLE">ORACLE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oracle 12c or above</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The dialect setting in configuration does <strong>not</strong> replace the need to ensure the correct dialect is set at the repository. If the dialect is H2 in configuration, the repository should have <code>@JdbcRepository(dialect = Dialect.H2)</code> / <code>@R2dbcRepository(dialect = Dialect.H2)</code>. Because repositories are computed at compile time, the configuration value is not known at that time.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
See the guide for <a href="https://guides.micronaut.io/latest/micronaut-data-jdbc-repository.html">Access a Database with Micronaut Data JDBC</a> to learn more.
</td>
</tr>
</table>
</div>
</div>

<h2 id="r2dbc"><a class="anchor" href="#r2dbc"></a>6.2 R2DBC</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/r2dbc.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data R2DBC is designed for users who prefer a lower-level experience and working directly with SQL and wish to build non-blocking, reactive applications.</p>
</div>
<div class="paragraph">
<p>Following sections contains R2DBC specific configuration and documentation.</p>
</div>

<h2 id="r2dbcQuickStart"><a class="anchor" href="#r2dbcQuickStart"></a>6.2.1 Quick Start</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/r2dbc/r2dbcQuickStart.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The quickest way to get started is to create a new Micronaut application with <a href="https://micronaut.io/launch/">Micronaut Launch</a> and <code>data-r2dbc</code>, a database driver and a database migration framework features. This can also be done via CLI.</p>
</div>
<div class="paragraph">
<p>Clicking on one of the links in the table below will take you to <a href="https://micronaut.io/launch/">Micronaut Launch</a> with the appropriate options already pre-configured with your selected language and build tool:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Creating a R2DBC application with Micronaut Launch</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Gradle</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Maven</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Java</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-r2dbc&amp;features=mysql&amp;lang=JAVA&amp;build=GRADLE" class="external">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-r2dbc&amp;features=mysql&amp;lang=JAVA&amp;build=MAVEN" class="external">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kotlin</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-r2dbc&amp;features=mysql&amp;lang=KOTLIN&amp;build=GRADLE" class="external">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-r2dbc&amp;features=mysql&amp;lang=KOTLIN&amp;build=MAVEN" class="external">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Groovy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-r2dbc&amp;features=mysql&amp;lang=GROOVY&amp;build=GRADLE" class="external">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-r2dbc&amp;features=mysql&amp;lang=GROOVY&amp;build=MAVEN" class="external">Open</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Creating an application with the CLI</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># For Maven add: --build maven
$ mn create-app --lang java example --features data-r2dbc,flyway,mysql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or via <code>curl</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating an application with <code>curl</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># For Maven add to the URL: &amp;build=maven
$ curl https://launch.micronaut.io/demo.zip?lang=java&amp;features=data-r2dbc,flyway,mysql -o demo.zip &amp;&amp; unzip demo.zip -d demo &amp;&amp; cd demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated application will use MySQL since we passed the <code>mysql</code> feature adding dependency on the R2DBC driver for MySQL:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">runtimeOnly(<span class="hljs-string">"dev.miku:r2dbc-mysql")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;dev.miku&lt;/groupId&gt;
    &lt;artifactId&gt;r2dbc-mysql&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>And for flyway the JDBC driver:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">runtimeOnly(<span class="hljs-string">"mysql:mysql-connector-java")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To create configurations for other drivers you can select the appropriate feature: <code>oracle</code>, <code>postgres</code>, <code>sqlserver</code>, <code>h2</code> or <code>mariadb</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now define a SQL script that creates your initial schema in <code>src/main/resources/db/migration</code>. For example:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>V1__create-schema.sql</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE book(id SERIAL NOT NULL PRIMARY KEY, title VARCHAR(255), pages INT, author_id BIGINT NOT NULL);
CREATE TABLE author(id SERIAL NOT NULL PRIMARY KEY, name VARCHAR(255));</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now configure your application to connect to the database using the application configuration file under <code>src/main/resources</code>:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">flyway.datasources.default.enabled=true
datasources.default.url=jdbc:mysql://localhost:3306/mydatabase
r2dbc.datasources.default.url=r2dbc:mysql:///mydatabase</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">flyway:
  datasources:
    default:
      enabled: true
datasources:
  default:
    url: jdbc:mysql://localhost:3306/mydatabase
r2dbc:
  datasources:
    default: # <b class="conum">(3)</b>
      url: r2dbc:mysql:///mydatabase</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[flyway]
  [flyway.datasources]
    [flyway.datasources.default]
      enabled=true
[datasources]
  [datasources.default]
    url="jdbc:mysql://localhost:3306/mydatabase"
[r2dbc]
  [r2dbc.datasources]
    [r2dbc.datasources.default]
      url="r2dbc:mysql:///mydatabase"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">flyway {
  datasources {
    'default' {
      enabled = true
    }
  }
}
datasources {
  'default' {
    url = "jdbc:mysql://localhost:3306/mydatabase"
  }
}
r2dbc {
  datasources {
    'default' {
      url = "r2dbc:mysql:///mydatabase"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  flyway {
    datasources {
      default {
        enabled = true
      }
    }
  }
  datasources {
    default {
      url = "jdbc:mysql://localhost:3306/mydatabase"
    }
  }
  r2dbc {
    datasources {
      default {
        url = "r2dbc:mysql:///mydatabase"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "flyway": {
    "datasources": {
      "default": {
        "enabled": true
      }
    }
  },
  "datasources": {
    "default": {
      "url": "jdbc:mysql://localhost:3306/mydatabase"
    }
  },
  "r2dbc": {
    "datasources": {
      "default": {
        "url": "r2dbc:mysql:///mydatabase"
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>enabled</code> setting ensures the Flyway schema migration is applied. See <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/index.html">Micronaut Flyway</a> for more information.</p>
</li>
<li>
<p>The Flyway configuration needs a JDBC datasource. <code>datasources.defaul.url</code> configures one. See <a href="#dbcConfiguration">datasource configuration</a> for more information.</p>
</li>
<li>
<p><code>r2dbc.datasources.default.url</code> is used to configure the default R2DBC <code>ConnectionFactory</code></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The R2DBC <code>ConnectionFactory</code> object can be injected anywhere in your code with dependency injection.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now define a <code>@MappedEntity</code> that maps to the <code>author</code> table defined in the schema:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.*;
import io.micronaut.serde.annotation.Serdeable;

@Serdeable
@MappedEntity
public class Author {
    @GeneratedValue
    @Id
    private Long id;
    private final String name;

    public Author(String name) {
        this.name = name;
    }

    public String getName() {
        return name;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.*
import io.micronaut.serde.annotation.Serdeable

@Serdeable
@MappedEntity
class Author {
    @GeneratedValue
    @Id
    Long id
    final String name

    Author(String name) {
        this.name = name
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import io.micronaut.serde.annotation.Serdeable

@Serdeable
@MappedEntity
data class Author(val name: String) {
    @GeneratedValue
    @Id
    var id: Long? = null
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And a repository interface to access the database that extends from <code>ReactiveStreamsRepository</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.NonNull;
import io.micronaut.data.model.query.builder.sql.Dialect;
import io.micronaut.data.r2dbc.annotation.R2dbcRepository;
import io.micronaut.data.repository.reactive.ReactiveStreamsCrudRepository;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import jakarta.validation.constraints.NotNull;

@R2dbcRepository(dialect = Dialect.POSTGRES) // <b class="conum">(1)</b>
public interface AuthorRepository extends ReactiveStreamsCrudRepository&lt;Author, Long&gt; {
    @NonNull
    @Override
    Mono&lt;Author&gt; findById(@NonNull @NotNull Long aLong); // <b class="conum">(2)</b>

    @NonNull
    @Override
    Flux&lt;Author&gt; findAll();
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.NonNull
import io.micronaut.data.model.query.builder.sql.Dialect
import io.micronaut.data.r2dbc.annotation.R2dbcRepository
import io.micronaut.data.repository.reactive.ReactiveStreamsCrudRepository
import reactor.core.publisher.Flux
import reactor.core.publisher.Mono

import jakarta.validation.constraints.NotNull

@R2dbcRepository(dialect = Dialect.POSTGRES) // <b class="conum">(1)</b>
interface AuthorRepository extends ReactiveStreamsCrudRepository&lt;Author, Long&gt; {
    @NonNull
    @Override
    Mono&lt;Author&gt; findById(@NonNull @NotNull Long aLong) // <b class="conum">(2)</b>

    @NonNull
    @Override
    Flux&lt;Author&gt; findAll()
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.model.query.builder.sql.Dialect
import io.micronaut.data.r2dbc.annotation.R2dbcRepository
import io.micronaut.data.repository.reactive.ReactiveStreamsCrudRepository
import reactor.core.publisher.Flux
import reactor.core.publisher.Mono
import jakarta.validation.constraints.NotNull

@R2dbcRepository(dialect = Dialect.MYSQL) // <b class="conum">(1)</b>
interface AuthorRepository : ReactiveStreamsCrudRepository&lt;Author, Long&gt; {
    override fun findById(id: @NotNull Long): Mono&lt;Author&gt; // <b class="conum">(2)</b>
    override fun findAll(): Flux&lt;Author&gt;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="../api/io/micronaut/data/r2dbc/annotation/R2dbcRepository.html">@R2dbcRepository</a> annotation can be used to specify the datasource and dialect</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can override methods from the super interface to specialize the default <a href="https://www.reactive-streams.org/reactive-streams-1.0.3-javadoc/org/reactivestreams/Publisher.html">Publisher</a> return type with a concrete implementation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now inject this interface into controllers and use it to perform R2DBC queries:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Controller("/authors")
public class AuthorController {
    private final AuthorRepository repository;

    public AuthorController(AuthorRepository repository) {
        this.repository = repository;
    }

    @Get
    Flux&lt;Author&gt; all() { // <b class="conum">(1)</b>
        return repository.findAll();
    }

    @Get("/id")
    Mono&lt;Author&gt; get(Long id) { // <b class="conum">(2)</b>
        return repository.findById(id);
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import reactor.core.publisher.Flux
import reactor.core.publisher.Mono

@Controller("/authors")
class AuthorController {
    private final AuthorRepository repository

    AuthorController(AuthorRepository repository) {
        this.repository = repository
    }

    @Get
    Flux&lt;Author&gt; all() { // <b class="conum">(1)</b>
        return repository.findAll()
    }

    @Get("/id")
    Mono&lt;Author&gt; get(Long id) { // <b class="conum">(2)</b>
        return repository.findById(id)
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import reactor.core.publisher.Flux
import reactor.core.publisher.Mono

@Controller("/authors")
class AuthorController(private val repository: AuthorRepository) {
    @Get
    fun all(): Flux&lt;Author&gt; { // <b class="conum">(1)</b>
        return repository.findAll()
    }

    @Get("/id")
    fun get(id: Long): Mono&lt;Author&gt; { // <b class="conum">(2)</b>
        return repository.findById(id)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>By returning a reactive type that emits many items you can stream data (either <a href="http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/Flowable.html">Flowable</a> or <code>Flux</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By returning a reactive type that emits a single item you return the entire response (either <a href="http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/Single.html">Single</a> or <code>Mono</code>)</td>
</tr>
</table>
</div>

<h2 id="r2dbcConfiguration"><a class="anchor" href="#r2dbcConfiguration"></a>6.2.2 Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/r2dbc/r2dbcConfiguration.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect2">
<h3 id="_r2dbc_driver">R2DBC driver</h3>
<div class="paragraph">
<p>Micronaut Data R2DBC requires driver configuration using <a href="https://micronaut-projects.github.io/micronaut-r2dbc/latest/guide/#jdbc">Micronaut R2DBC</a></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. The following drivers are available as of this writing.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Database</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Dependency</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The H2 database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.r2dbc:r2dbc-h2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dev.miku:r2dbc-mysql</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MariaDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.mariadb:r2dbc-mariadb</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Postgres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.postgresql:r2dbc-postgresql</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.r2dbc:r2dbc-mssql</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oracle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.oracle.database.r2dbc:oracle-r2dbc</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_sql_logging">SQL Logging</h3>
<div class="paragraph">
<p>You can enable SQL logging by enabling trace logging for the <code>io.micronaut.data.query</code> logger. For example in <code>logback.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">Enabling SQL Query Logging</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;logger name="io.micronaut.data.query" level="trace" /&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_schema">Creating the Schema</h3>
<div class="paragraph">
<p>To create the database schema it is recommended you pair Micronaut Data with a SQL migration tool such as <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/index.html">Flyway</a> or <a href="https://micronaut-projects.github.io/micronaut-liquibase/latest/guide/index.html">Liquibase</a>.</p>
</div>
<div class="paragraph">
<p>SQL migration tools provide more complete support for creating and evolving your schema across a range of databases.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most of the database migration tools use JDBC driver to make DB changes. Therefore, it is likely that you will in addition to the R2DBC driver need to include a <a href="https://micronaut-projects.github.io/micronaut-sql/latest/guide/#jdbc">JDBC driver module</a> for the schema migration to work.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to quickly test out Micronaut Data R2DBC then you can set the <code>schema-generate</code> option of the data source to <code>create-drop</code> as well as the appropriate schema name:</p>
</div>
<div class="openblock">
<div class="title">Using <code>schema-generate</code></div>
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">micronaut.application.name=example
r2dbc.datasources.default.db-type=postgresql
r2dbc.datasources.default.schema-generate=CREATE_DROP
r2dbc.datasources.default.dialect=POSTGRES
datasources.default.db-type=postgresql
datasources.default.schema-generate=CREATE_DROP
datasources.default.dialect=POSTGRES</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
  application:
    name: example

r2dbc:
  datasources:
    default:
      db-type: postgresql
      schema-generate: CREATE_DROP
      dialect: POSTGRES
datasources:
  default:
    db-type: postgresql
    schema-generate: CREATE_DROP
    dialect: POSTGRES</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[micronaut]
  [micronaut.application]
    name="example"
[r2dbc]
  [r2dbc.datasources]
    [r2dbc.datasources.default]
      db-type="postgresql"
      schema-generate="CREATE_DROP"
      dialect="POSTGRES"
[datasources]
  [datasources.default]
    db-type="postgresql"
    schema-generate="CREATE_DROP"
    dialect="POSTGRES"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">micronaut {
  application {
    name = "example"
  }
}
r2dbc {
  datasources {
    'default' {
      dbType = "postgresql"
      schemaGenerate = "CREATE_DROP"
      dialect = "POSTGRES"
    }
  }
}
datasources {
  'default' {
    dbType = "postgresql"
    schemaGenerate = "CREATE_DROP"
    dialect = "POSTGRES"
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  micronaut {
    application {
      name = "example"
    }
  }
  r2dbc {
    datasources {
      default {
        db-type = "postgresql"
        schema-generate = "CREATE_DROP"
        dialect = "POSTGRES"
      }
    }
  }
  datasources {
    default {
      db-type = "postgresql"
      schema-generate = "CREATE_DROP"
      dialect = "POSTGRES"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "micronaut": {
    "application": {
      "name": "example"
    }
  },
  "r2dbc": {
    "datasources": {
      "default": {
        "db-type": "postgresql",
        "schema-generate": "CREATE_DROP",
        "dialect": "POSTGRES"
      }
    }
  },
  "datasources": {
    "default": {
      "db-type": "postgresql",
      "schema-generate": "CREATE_DROP",
      "dialect": "POSTGRES"
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>schema-generate</code> option is currently only recommended for simple applications, testing and demos and is not considered production-ready. The dialect set in configuration is the dialect that will be used to generate the schema.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_the_dialect">Setting the Dialect</h3>
<div class="paragraph">
<p>As seen in the configuration above you should also configure the dialect. Although queries are precomputed in the repository some cases (like pagination) still require the dialect to specify. The following table summarizes the supported dialects:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Supported JDBC / R2DBC Dialects</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Dialect</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#H2">H2</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The H2 database (typically used for in-memory testing)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#MYSQL">MYSQL</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL 5.5 or above</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#POSTGRES">POSTGRES</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Postgres 9.5 or above</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#SQL_SERVER">SQL_SERVER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL Server 2012 or above</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/model/query/builder/sql/Dialect.html#ORACLE">ORACLE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oracle 12c or above</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The dialect setting in configuration does <strong>not</strong> replace the need to ensure the correct dialect is set at the repository. If the dialect is H2 in configuration, the repository should have <code>@R2dbcRepository(dialect = Dialect.H2)</code>. Because repositories are computed at compile time, the configuration value is not known at that time.
</td>
</tr>
</table>
</div>
</div>

<h2 id="r2querying"><a class="anchor" href="#r2querying"></a>6.2.3 Reactive repositories</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/r2dbc/r2querying.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The following table summarizes the reactive repository interfaces that come with Micronaut Data and are recommended to be used with R2DBC:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Builtin Reactive Repository Interfaces</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Interface</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactiveStreamsCrudRepository.html">ReactiveStreamsCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and adds CRUD methods that return <a href="https://www.reactive-streams.org/reactive-streams-1.0.3-javadoc/org/reactivestreams/Publisher.html">Publisher</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactorCrudRepository.html">ReactorCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/ReactiveStreamsCrudRepository.html">ReactiveStreamsCrudRepository</a> and is using Reactor return types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/RxJavaCrudRepository.html">RxJavaCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and adds CRUD methods that return RxJava 2 types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/kotlin/CoroutineCrudRepository.html">CoroutineCrudRepository</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extends <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> and is using Kotlin coroutines for reactive CRUD operations</p></td>
</tr>
</tbody>
</table>

<h2 id="r2transactionManagement"><a class="anchor" href="#r2transactionManagement"></a>6.2.4 Transactions</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/r2dbc/r2transactionManagement.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data R2DBC features Reactive transaction management support whereby you can declare <code>jakarta.transaction.Transactional</code> on your methods and a reactive transaction will be initiated, for example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import reactor.core.publisher.Mono;

import jakarta.inject.Singleton;
import jakarta.transaction.Transactional;
import java.util.Arrays;

@Singleton
public class AuthorService {
    private final AuthorRepository authorRepository;
    private final BookRepository bookRepository;

    public AuthorService(AuthorRepository authorRepository, BookRepository bookRepository) { // <b class="conum">(1)</b>
        this.authorRepository = authorRepository;
        this.bookRepository = bookRepository;
    }

    @Transactional // <b class="conum">(2)</b>
    Mono&lt;Void&gt; setupData() {
        return Mono.from(authorRepository.save(new Author("Stephen King")))
                .flatMapMany((author -&gt; bookRepository.saveAll(Arrays.asList(
                        new Book("The Stand", 1000, author),
                        new Book("The Shining", 400, author)
                ))))
                .then(Mono.from(authorRepository.save(new Author("James Patterson"))))
                .flatMapMany((author -&gt;
                        bookRepository.save(new Book("Along Came a Spider", 300, author))
                )).then();
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import reactor.core.publisher.Mono

import jakarta.inject.Singleton
import jakarta.transaction.Transactional

@Singleton
class AuthorService {
    private final AuthorRepository authorRepository
    private final BookRepository bookRepository

    AuthorService(AuthorRepository authorRepository, BookRepository bookRepository) { // <b class="conum">(1)</b>
        this.authorRepository = authorRepository
        this.bookRepository = bookRepository
    }

    @Transactional // <b class="conum">(2)</b>
    Mono&lt;Void&gt; setupData() {
        return Mono.from(authorRepository.save(new Author("Stephen King")))
                .flatMapMany((author -&gt; bookRepository.saveAll([
                        new Book("The Stand", 1000, author),
                        new Book("The Shining", 400, author)
                ])))
                .then(Mono.from(authorRepository.save(new Author("James Patterson"))))
                .flatMapMany((author -&gt;
                        bookRepository.save(new Book("Along Came a Spider", 300, author))
                )).then()
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import reactor.core.publisher.Mono
import jakarta.inject.Singleton
import jakarta.transaction.Transactional

@Singleton
open class AuthorService(
        private val authorRepository: AuthorRepository,
        private val bookRepository: BookReactiveRepository) { // <b class="conum">(1)</b>

    @Transactional // <b class="conum">(2)</b>
    open fun setupData(): Mono&lt;Void&gt; {
        return Mono.from(authorRepository.save(Author("Stephen King")))
                .flatMapMany { author: Author -&gt;
                    bookRepository.saveAll(listOf(
                            Book("The Stand", 1000, author),
                            Book("The Shining", 400, author)
                    ))
                }
                .then(Mono.from(authorRepository.save(Author("James Patterson"))))
                .flatMapMany { author: Author -&gt;
                    bookRepository.save(Book("Along Came a Spider", 300, author))
                }.then()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Supporting repositories are injected</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>@Transactional</code> is used to declare a transaction</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This same declarative logic can be done programmatically as well by injecting the <a href="../api/io/micronaut/data/r2dbc/operations/R2dbcOperations.html">R2dbcOperations</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Flux.from(operations.withTransaction(status -&gt;
    Flux.from(authorRepository.save(new Author("Stephen King")))
            .flatMap((author -&gt; bookRepository.saveAll(Arrays.asList(
                    new Book("The Stand", 1000, author),
                    new Book("The Shining", 400, author)
            ))))
    .thenMany(Flux.from(authorRepository.save(new Author("James Patterson"))))
        .flatMap((author -&gt;
                bookRepository.save(new Book("Along Came a Spider", 300, author))
    )).then()
)).collectList().block();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Flux.from(operations.withTransaction(status -&gt;
        Flux.from(authorRepository.save(new Author("Stephen King")))
                .flatMap((author -&gt; bookRepository.saveAll([
                        new Book("The Stand", 1000, author),
                        new Book("The Shining", 400, author)
                ])))
                .thenMany(Flux.from(authorRepository.save(new Author("James Patterson"))))
                .flatMap((author -&gt;
                        bookRepository.save(new Book("Along Came a Spider", 300, author))
                )).then()
)).collectList().block()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">Flux.from(operations.withTransaction {
    Flux.from(authorRepository.save(Author("Stephen King")))
            .flatMap { author: Author -&gt;
                bookRepository.saveAll(listOf(
                        Book("The Stand", 1000, author),
                        Book("The Shining", 400, author)
                ))
            }
            .thenMany(Flux.from(authorRepository.save(Author("James Patterson"))))
            .flatMap { author: Author -&gt; bookRepository.save(Book("Along Came a Spider", 300, author)) }.then()
}).collectList().block()</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above case the <code>withTransaction</code> method is used to initiate a transaction.</p>
</div>
<div class="paragraph">
<p>Note however, that transaction management is possibly one of the most challenging areas to get right in reactive programming since you need to propagate the transaction across the reactive flow.</p>
</div>
<div class="paragraph">
<p>Most R2DBC drivers are implemented in <a href="https://projectreactor.io/">Project Reactor</a> which has the ability to <a href="https://projectreactor.io/docs/core/release/reference/#context">propagate a context</a> across reactive operators and Micronaut Data R2DBC will populate this context and ensure the transaction is re-used if it is found within it.</p>
</div>
<div class="paragraph">
<p>However, it is still pretty easy for the context to be lost since different libraries that implement Reactive Streams don&#8217;t propagate contexts between each other so if you include RxJava or any other reactive operator library it is likely the context will be lost.</p>
</div>
<div class="paragraph">
<p>To ensure this doesn&#8217;t happen it is recommended that you annotate write operations that participate within a transaction as <code>MANDATORY</code> which ensures it is not possible to run these methods without a surrounding transaction present so that if the transaction is somehow lost within the reactive flow it doesn&#8217;t cause operations to be run in separate transactions:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@NonNull
@Override
@Transactional(Transactional.TxType.MANDATORY)
&lt;S extends Book&gt; Publisher&lt;S&gt; save(@NonNull @Valid @NotNull S entity);

@NonNull
@Override
@Transactional(Transactional.TxType.MANDATORY)
&lt;S extends Book&gt; Publisher&lt;S&gt; saveAll(@NonNull @Valid @NotNull Iterable&lt;S&gt; entities);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@NonNull
@Override
@Transactional(Transactional.TxType.MANDATORY)
&lt;S extends Book&gt; Publisher&lt;S&gt; save(@NonNull @Valid @NotNull S entity);

@NonNull
@Override
@Transactional(Transactional.TxType.MANDATORY)
&lt;S extends Book&gt; Publisher&lt;S&gt; saveAll(@NonNull @Valid @NotNull Iterable&lt;S&gt; entities);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Transactional(Transactional.TxType.MANDATORY)
override suspend fun &lt;S : Book&gt; save(entity: S): S

@Transactional(Transactional.TxType.MANDATORY)
override fun &lt;S : Book&gt; saveAll(entities: Iterable&lt;S&gt;): Flow&lt;S&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the transaction is somehow lost during the reactive flow there are a couple of ways you can solve the problem. One way is to use the <code>withTransaction</code> method of the <a href="../api/io/micronaut/data/r2dbc/operations/R2dbcOperations.html">R2dbcOperations</a> interface to obtain the current <code>ReactiveTransactionStatus</code>, you can then pass this instance into another execution of the <code>withTransaction</code> method or pass it directly as the last argument to any method declared on the repository itself.</p>
</div>
<div class="paragraph">
<p>An example of the former approach is presented below, using RxJava 2 this time which will cause propagation loss:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Flux.from(operations.withTransaction(status -&gt; // <b class="conum">(1)</b>
        Flux.from(authorRepository.save(new Author("Michael Crichton")))
                .flatMap((author -&gt; operations.withTransaction(status, (s) -&gt; // <b class="conum">(2)</b>
                        bookRepository.saveAll(Arrays.asList(
                                new Book("Jurassic Park", 300, author),
                                new Book("Disclosure", 400, author)
                        )))))
)).collectList().block();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Flux.from(operations.withTransaction(status -&gt; // <b class="conum">(1)</b>
        Flux.from(authorRepository.save(new Author("Michael Crichton")))
                .flatMap((author -&gt; operations.withTransaction(status, (s) -&gt; // <b class="conum">(2)</b>
                        bookRepository.saveAll([
                                new Book("Jurassic Park", 300, author),
                                new Book("Disclosure", 400, author)
                        ]))))
)).collectList().block()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">Flux.from(operations.withTransaction { status: ReactiveTransactionStatus&lt;Connection&gt; -&gt;  // <b class="conum">(1)</b>
    Flux.from(authorRepository.save(Author("Michael Crichton")))
            .flatMap { author: Author -&gt;
                operations.withTransaction(status) {   // <b class="conum">(2)</b>
                    bookRepository.saveAll(listOf(
                            Book("Jurassic Park", 300, author),
                            Book("Disclosure", 400, author)
                    ))
                }
            }
}).collectList().block()</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An outer <code>withTransaction</code> call starts the transaction</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>An inner call ensures the existing transaction is propagated</td>
</tr>
</table>
</div>

<h2 id="r2entityEvents"><a class="anchor" href="#r2entityEvents"></a>6.2.5 Reactive Entity Events</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/r2dbc/r2entityEvents.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data R2DBC supports persistence events introduced in Micronaut Data 2.3 and above however it should be noted that these should not block and should only perform operations that don&#8217;t incur any network I/O and if they do a new thread should execute this logic.</p>
</div>
<div class="paragraph">
<p>Note that persistence events are most commonly used to pre-populate database properties prior to performing an insert (for example encoding a password etc.) these types of operations typically don&#8217;t involve blocking I/O and are safe to perform.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
See the guide for <a href="https://guides.micronaut.io/latest/micronaut-data-r2dbc-repository.html">Access a Database with Micronaut Data R2DBC</a> to learn more.
</td>
</tr>
</table>
</div>

<h2 id="dbcRepositories"><a class="anchor" href="#dbcRepositories"></a>6.3 Repositories</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcRepositories.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As seen in the <a href="#jdbcQuickStart">Quick Start</a> JDBC / R2DBC repositories in Micronaut Data are defined as interfaces that are annotated with the <a href="../api/io/micronaut/data/jdbc/annotation/JdbcRepository.html">@JdbcRepository</a> annotation, <a href="../api/io/micronaut/data/r2dbc/annotation/R2dbcRepository.html">@R2dbcRepository</a> accordingly.</p>
</div>
<div class="paragraph">
<p>In a multiple datasource scenario, the <a href="../api/io/micronaut/data/annotation/Repository.html">@Repository</a> and <a href="../api/io/micronaut/transaction/annotation/Transactional.html">@Transactional</a> annotations can be used to specify the datasource configuration to use. By default, Micronaut Data will look for the default datasource.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@JdbcRepository(dialect = Dialect.ORACLE, dataSource = "inventoryDataSource") <i class="conum" data-value="1"></i><b>(1)</b>
@io.micronaut.transaction.annotation.Transactional("inventoryDataSource") <i class="conum" data-value="2"></i><b>(2)</b>
public interface PhoneRepository extends CrudRepository&lt;Phone, Integer&gt; {
    Optional&lt;Phone&gt; findByAssetId(@NotNull Integer assetId);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>@JdbcRepository with a specific dialect and data source configuration 'inventoryDataSource'</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>@Transactional annotation, pointing to the data source configuration 'inventoryDataSource'</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The entity to treat as the root entity for the purposes of querying is established either from the method signature or from the generic type parameter specified to the <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> interface.</p>
</div>
<div class="paragraph">
<p>If no root entity can be established then a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>The same interfaces supported by the JPA implementation are supported by JDBC.</p>
</div>
<div class="paragraph">
<p>Note that because queries are computed at compilation time the <code>dialect</code> you use must be specified on the repository.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is recommended you test against your target dialect. The <a href="https://www.testcontainers.org">Test Containers</a> project is a great solution for this. If you must test against another dialect (like H2) then you can define a subinterface that <code>@Replaces</code> the repository with a different dialect for the scope of testing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that in addition to interfaces you can also define repositories as abstract classes:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.jdbc.annotation.JdbcRepository;
import io.micronaut.data.jdbc.runtime.JdbcOperations;
import io.micronaut.data.model.query.builder.sql.Dialect;
import io.micronaut.data.repository.CrudRepository;

import jakarta.transaction.Transactional;
import java.sql.ResultSet;
import java.util.List;
import java.util.stream.Collectors;

@JdbcRepository(dialect = Dialect.H2)
public abstract class AbstractBookRepository implements CrudRepository&lt;Book, Long&gt; {

    private final JdbcOperations jdbcOperations;

    public AbstractBookRepository(JdbcOperations jdbcOperations) {
        this.jdbcOperations = jdbcOperations;
    }

    @Transactional
    public List&lt;Book&gt; findByTitle(String title) {
        String sql = "SELECT * FROM Book AS book WHERE book.title = ?";
        return jdbcOperations.prepareStatement(sql, statement -&gt; {
            statement.setString(1, title);
            ResultSet resultSet = statement.executeQuery();
            return jdbcOperations.entityStream(resultSet, Book.class).toList();
        });
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.jdbc.annotation.JdbcRepository
import io.micronaut.data.jdbc.runtime.JdbcOperations
import io.micronaut.data.model.query.builder.sql.Dialect
import io.micronaut.data.repository.CrudRepository

import jakarta.transaction.Transactional
import java.sql.ResultSet
import java.util.stream.Collectors

@JdbcRepository(dialect = Dialect.H2)
abstract class AbstractBookRepository implements CrudRepository&lt;Book, Long&gt; {

    private final JdbcOperations jdbcOperations

    AbstractBookRepository(JdbcOperations jdbcOperations) {
        this.jdbcOperations = jdbcOperations
    }

    @Transactional
    List&lt;Book&gt; findByTitle(String title) {
        String sql = "SELECT * FROM Book AS book WHERE book.title = ?"
        return jdbcOperations.prepareStatement(sql,  { statement -&gt;
            statement.setString(1, title)
            ResultSet resultSet = statement.executeQuery()
            return jdbcOperations.entityStream(resultSet, Book.class)
                    .toList()
        })
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.Repository
import io.micronaut.data.jdbc.runtime.JdbcOperations
import io.micronaut.data.repository.CrudRepository

import jakarta.transaction.Transactional
import kotlin.streams.toList

@Repository
abstract class AbstractBookRepository(private val jdbcOperations: JdbcOperations) : CrudRepository&lt;Book, Long&gt; {

    @Transactional
    open fun findByTitle(title: String): List&lt;Book&gt; {
        val sql = "SELECT * FROM Book AS book WHERE book.title = ?"
        return jdbcOperations.prepareStatement(sql) { statement -&gt;
            statement.setString(1, title)
            val resultSet = statement.executeQuery()
            jdbcOperations.entityStream(resultSet, Book::class.java)
                    .toList()
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the above example, using abstract classes can be useful as it allows you to combine custom code that performs your own SQL queries.</p>
</div>
<div class="paragraph">
<p>The example above uses the <a href="../api/io/micronaut/data/jdbc/runtime/JdbcOperations.html">JdbcOperations</a> interface which simplifies executing JDBC queries within the context of transactions.</p>
</div>
<div class="paragraph">
<p>You can also integrate whichever other tool you wish to use to handle more complex queries, such as QueryDSL, JOOQ, Spring JdbcTemplate etc.</p>
</div>
<div class="paragraph">
<p>For example, to use <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html">Spring JdbcTemplate</a>, add the following dependencies:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-jdbc")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-spring-jdbc")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-spring-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>The following code illustrates an example that integrates a <code>JdbcTemplate</code> instance as part of a <a href="../api/io/micronaut/data/jdbc/annotation/JdbcRepository.html">JdbcRepository</a>.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@JdbcRepository(dialect = Dialect.H2)
public abstract class AbstractBookRepository implements CrudRepository&lt;@Valid Book, @NotNull Long&gt; {

    private final JdbcTemplate jdbcTemplate;

    public AbstractBookRepository(DataSource dataSource) { // <b class="conum">(1)</b>
        this.jdbcTemplate = new JdbcTemplate(DelegatingDataSource.unwrapDataSource(dataSource)); //<b class="conum">(2)</b>
    }

    @Transactional
    public List&lt;Book&gt; findByTitle(@NonNull @NotNull String title) {
        return jdbcTemplate.queryForList("SELECT * FROM Book AS book WHERE book.title = ?", title) // <b class="conum">(3)</b>
            .stream()
            .map(m -&gt; new Book((Long) m.get("id"), (String) m.get("title"), (Integer) m.get("pages")))
            .toList();
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@JdbcRepository(dialect = Dialect.H2)
abstract class AbstractBookRepository implements CrudRepository&lt;@Valid Book, @NotNull Long&gt; {

    private final JdbcTemplate jdbcTemplate;

    AbstractBookRepository(DataSource dataSource) { // <b class="conum">(1)</b>
        this.jdbcTemplate = new JdbcTemplate(DelegatingDataSource.unwrapDataSource(dataSource)); //<b class="conum">(2)</b>
    }

    @Transactional
    List&lt;Book&gt; findByTitle(@NonNull @NotNull String title) {
        return jdbcTemplate.queryForList('SELECT * FROM Book AS book WHERE book.title = ?', title) // <b class="conum">(3)</b>
            .collect(m -&gt; new Book(m.id as Long, m.title as String, m.pages as Integer))
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@JdbcRepository(dialect = Dialect.H2)
abstract class AbstractBookRepository(dataSource: DataSource) : CrudRepository&lt;@Valid Book, Long&gt; { // <b class="conum">(1)</b>

    private val jdbcTemplate: JdbcTemplate = JdbcTemplate(DelegatingDataSource.unwrapDataSource(dataSource)) //<b class="conum">(2)</b>

    @Transactional
    open fun findByTitle(title: String) = jdbcTemplate
        .queryForList("SELECT * FROM Book AS book WHERE book.title = ?", title) // <b class="conum">(3)</b>
        .map { m -&gt; Book(m["id"] as Long, m["title"] as String, m["pages"] as Int) }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject the <code>java.sql.DataSource</code> configured by the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instantiate a <code>JdbcTemplate</code> object using the injected <code>DataSource</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Now the <code>JdbcTemplate</code> API can be used to implement repository methods.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition, the transaction manager for Spring JDBC needs to be set in application configuration.</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">datasources.default.transaction-manager=springJdbc</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">datasources:
  default:
    transaction-manager: springJdbc</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[datasources]
  [datasources.default]
    transaction-manager="springJdbc"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">datasources {
  'default' {
    transactionManager = "springJdbc"
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  datasources {
    default {
      transaction-manager = "springJdbc"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "datasources": {
    "default": {
      "transaction-manager": "springJdbc"
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>

<h2 id="sqlInserts"><a class="anchor" href="#sqlInserts"></a>6.3.1 Accessing data</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcRepositories/sqlInserts.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Unlike JPA/Hibernate, Micronaut Data JDBC / R2DBC is stateless and has no notion of a persistence session that requires state management.</p>
</div>
<div class="paragraph">
<p>Since there is no session, features like dirty checking are not supported. This has implications when defining repository methods for inserts and updates.</p>
</div>
<div class="paragraph">
<p>By default, when saving an entity with a method like <code>save(MyEntity)</code> a SQL <code>INSERT</code> is always performed since Micronaut Data has no way to know whether the entity is associated to a particular session.</p>
</div>
<div class="paragraph">
<p>If you wish to update an entity you should instead either use <code>update(MyEntity)</code> or even better define an appropriate <code>update</code> method to update only the data you want to update, for example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void update(@Id Long id, int pages);

void update(@Id Long id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void update(@Id Long id, int pages);

void update(@Id Long id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun update(@Id id: Long?, pages: Int)

fun update(@Id id: Long?, title: String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>By being explicit in defining the method as an update method Micronaut Data knows to execute an <code>UPDATE</code>.</p>
</div>

<h2 id="optimisticLocking"><a class="anchor" href="#optimisticLocking"></a>6.3.2 Optimistic locking</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcRepositories/optimisticLocking.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Optimistic locking is a strategy where you note the actual record state&#8217;s version and modify the record only when the version is the same.</p>
</div>
<div class="paragraph">
<p>To enable optimistic locking for your entity add <a href="../api/io/micronaut/data/annotation/Version.html">@Version</a> annotated field with one of the types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Integer</code></p>
</li>
<li>
<p><code>java.lang.Long</code></p>
</li>
<li>
<p><code>java.lang.Short</code></p>
</li>
<li>
<p>Date-time type extending <code>java.time.Temporal</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The field is going to be incremented (for number types) or replaced (for date types) on an update operation.</p>
</div>
<div class="paragraph">
<p>Micronaut Data will generate <code>UPDATE</code>/<code>DELETE</code> SQL queries with a version match: <code>&#8230;&#8203; WHERE rec.version = :currentVersion &#8230;&#8203;</code> and if the update/delete doesn&#8217;t produce any result <a href="../api/io/micronaut/data/exceptions/OptimisticLockException.html">OptimisticLockException</a> will be thrown.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Student {

    @Id
    @GeneratedValue
    private Long id;
    @Version
    private Long version;</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Entity
class Student {

    @Id
    @GeneratedValue
    Long id
    @Version
    Long version</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Entity
data class Student(
        @Id @GeneratedValue
        var id: Long?,
        @Version
        val version: Long,</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s possible to use <a href="../api/io/micronaut/data/annotation/Version.html">@Version</a> in a partial update or a delete method, in this case the version needs to match the version of the stored record.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Repository
public interface StudentRepository extends CrudRepository&lt;Student, Long&gt; {

    void update(@Id Long id, @Version Long version, String name);

    void delete(@Id Long id, @Version Long version);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Repository
interface StudentRepository extends CrudRepository&lt;Student, Long&gt; {

    void update(@Id Long id, @Version Long version, String name)

    void delete(@Id Long id, @Version Long version)
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Repository
interface StudentRepository : CrudRepository&lt;Student, Long&gt; {

    fun update(@Id id: Long, @Version version: Long, name: String)

    fun delete(@Id id: Long, @Version version: Long)

}</code></pre>
</div>
</div>

<h2 id="pessimisticLocking"><a class="anchor" href="#pessimisticLocking"></a>6.3.3 Pessimistic Locking</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcRepositories/pessimisticLocking.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Pessimistic locking is supported through the use of <code>find*ForUpdate</code> methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@JdbcRepository(dialect = Dialect.POSTGRES)
public interface AccountBalanceRepository extends CrudRepository&lt;AccountBalance, Long&gt; {

    AccountBalance findByIdForUpdate(Long id); <i class="conum" data-value="1"></i><b>(1)</b>

    @Transactional <i class="conum" data-value="2"></i><b>(2)</b>
    void addToBalance(Long id, BigInteger amount) {
        AccountBalance accountBalance = findByIdForUpdate(id); <i class="conum" data-value="3"></i><b>(3)</b>
        accountBalance.addAmount(amount);
        update(accountBalance); <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>ForUpdate</code> suffix indicates that the selected record should be locked.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Both read and write operations are wrapped in a single transaction.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A locking read is performed, preventing other queries from accessing the record.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The record is updated safely.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All <code>find</code> methods can be declared as <code>ForUpdate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@JdbcRepository(dialect = Dialect.POSTGRES)
public interface BookRepository extends CrudRepository&lt;Book, Long&gt; {

    @Join("author")
    Optional&lt;Book&gt; findByIdForUpdate(Long id);

    List&lt;Book&gt; findAllOrderByTotalPagesForUpdate();

    List&lt;Book&gt; findByTitleForUpdate(String title);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The queries generated for these methods make use of the <code>FOR UPDATE</code> SQL clause or the <code>UPDLOCK</code> and <code>ROWLOCK</code> query hints in the case of SQL Server.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The semantics of the <code>FOR UPDATE</code> clause may vary depending on the database. Make sure to check the relevant documentation for your engine.
</td>
</tr>
</table>
</div>

<h2 id="dbcCriteriaSpecifications"><a class="anchor" href="#dbcCriteriaSpecifications"></a>6.4 Repositories with Criteria API</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcCriteriaSpecifications.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In some cases, you need to build a query programmatically and at the runtime; for that, Micronaut Data implements a subset of Jakarta Persistence Criteria API 3.0, which can be used for Micronaut Data JDBC and R2DBC features. To utilize this feature add the following dependency:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"jakarta.persistence:jakarta.persistence-api")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;jakarta.persistence&lt;/groupId&gt;
    &lt;artifactId&gt;jakarta.persistence-api&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>To implement queries that cannot be defined at the compile-time Micronaut Data introduces <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> repository interface that can be used to extend your repository interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@JdbcRepository(dialect = Dialect.H2)
public interface PersonRepository extends CrudRepository&lt;Person, Long&gt;, JpaSpecificationExecutor&lt;Person&gt; {
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@JdbcRepository(dialect = Dialect.H2)
interface PersonRepository extends CrudRepository&lt;Person, Long&gt;, JpaSpecificationExecutor&lt;Person&gt; {
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@JdbcRepository(dialect = Dialect.H2)
interface PersonRepository : CrudRepository&lt;Person, Long&gt;, JpaSpecificationExecutor&lt;Person&gt; {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each method expects a "specification" which is a functional interface with a set of Criteria API objects intended to build a query programmatically.</p>
</div>
<div class="paragraph">
<p>Micronaut Criteria API currently implements only a subset of the API. Most of it is internally used to create queries with predicates and projections.</p>
</div>
<div class="paragraph">
<p>Currently, not supported JPA Criteria API features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Joins with custom <code>ON</code> expressions and typed join methods like <code>joinSet</code> etc</p>
</li>
<li>
<p>Sub-queries</p>
</li>
<li>
<p>Collection operations: <code>isMember</code> etc</p>
</li>
<li>
<p>Custom or tuple result type</p>
</li>
<li>
<p>Transformation expressions like concat, substring etc.</p>
</li>
<li>
<p>Cases and functions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More information about Jakarta Persistence Criteria API 3.0 you can find at the <a href="https://jakarta.ee/specifications/persistence/3.0/jakarta-persistence-spec-3.0.html#a6925">official API specification</a></p>
</div>

<h2 id="criteriaExecuteQuery"><a class="anchor" href="#criteriaExecuteQuery"></a>6.4.1 Querying</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcCriteriaSpecifications/criteriaExecuteQuery.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To find an entity or multiple entities you can use one of the following methods from <a href="../api/io/micronaut/data/jpa/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Optional&lt;Person&gt; findOne(PredicateSpecification&lt;Person&gt; spec);

Optional&lt;Person&gt; findOne(QuerySpecification&lt;Person&gt; spec);

List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec);

List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec);

List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Sort sort);

List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Sort sort);

Page&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Pageable pageable);

Page&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Pageable pageable);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Optional&lt;Person&gt; findOne(PredicateSpecification&lt;Person&gt; spec)

Optional&lt;Person&gt; findOne(QuerySpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Sort sort)

List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Sort sort)

Page&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Pageable pageable)

Page&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Pageable pageable)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findOne(spec: PredicateSpecification&lt;Person&gt;?): Optional&lt;Person&gt;

fun findOne(spec: QuerySpecification&lt;Person&gt;?): Optional&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?): List&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?): List&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?, sort: Sort): List&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?, sort: Sort): List&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?, pageable: Pageable): Page&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?, pageable: Pageable): Page&lt;Person&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there are two variations of <code>findOne</code>/<code>findAll</code> methods.</p>
</div>
<div class="paragraph">
<p>First method is expecting <a href="../api/io/micronaut/data/repository/criteria/PredicateSpecification.html">PredicateSpecification</a> which is a simple specification interface that can be implemented to return a predicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface PredicateSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="3"></i><b>(3)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This interface can also be used for update and delete methods, and it provides <code>or</code> and <code>and</code> methods for combining multiple predicates.</p>
</div>
<div class="paragraph">
<p>The second interface is intended only for query criteria because it includes <code>jakarta.persistence.criteria.CriteriaQuery</code> as a parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface QuerySpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaQuery&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria query instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For implementing counting queries following methods can be used:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long count(PredicateSpecification&lt;Person&gt; spec);

long count(QuerySpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long count(PredicateSpecification&lt;Person&gt; spec)

long count(QuerySpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun count(spec: PredicateSpecification&lt;Person&gt;?): Long

fun count(spec: QuerySpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define criteria specification methods that will help you to create a query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(Person_.name), name);
    }

    static PredicateSpecification&lt;Person&gt; longNameEquals(String longName) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(Person_.longName), longName);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get(Person_.age), age);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {

    fun nameEquals(name: String?) = PredicateSpecification&lt;Person&gt; { root, criteriaBuilder -&gt;
        criteriaBuilder.equal(root.get&lt;Any&gt;("name"), name)
    }

    fun ageIsLessThan(age: Int) = PredicateSpecification&lt;Person&gt; { root, criteriaBuilder -&gt;
        criteriaBuilder.lessThan(root.get("age"), age)
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can combine them for <code>find</code> or <code>count</code> queries:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Person denis = personRepository.findOne(nameEquals("Denis")).orElse(null);

Person josh = personRepository.findOne(longNameEquals("Josh PM")).orElse(null);

long countAgeLess30 = personRepository.count(ageIsLessThan(30));

long countAgeLess20 = personRepository.count(ageIsLessThan(20));

long countAgeLess30NotDenis = personRepository.count(ageIsLessThan(30).and(not(nameEquals("Denis"))));

List&lt;Person&gt; people = personRepository.findAll(where(nameEquals("Denis").or(nameEquals("Josh"))));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Person denis = personRepository.findOne(nameEquals("Denis")).orElse(null)

long countAgeLess30 = personRepository.count(ageIsLessThan(30))

long countAgeLess20 = personRepository.count(ageIsLessThan(20))

long countAgeLess30NotDenis = personRepository.count(ageIsLessThan(30) &amp; not(nameEquals("Denis")))

List&lt;Person&gt; people = personRepository.findAll(where(nameEquals("Denis") | nameEquals("Josh")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val denis: Person? = personRepository.findOne(nameEquals("Denis")).orElse(null)

val countAgeLess30: Long = personRepository.count(ageIsLessThan(30))

val countAgeLess20: Long = personRepository.count(ageIsLessThan(20))

val countAgeLess30NotDenis: Long = personRepository.count(ageIsLessThan(30).and(not(nameEquals("Denis"))))

val people = personRepository.findAll(PredicateSpecification.where(nameEquals("Denis").or(nameEquals("Josh"))))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The examples use compile-known values, and in this case, it would be better to create custom repository methods which would come with compile-time generates queries and eliminate runtime overhead.
It&#8217;s recommended to use criteria only for dynamic queries where the query structure is not known at the build-time.
</td>
</tr>
</table>
</div>

<h2 id="criteriaExecuteUpdate"><a class="anchor" href="#criteriaExecuteUpdate"></a>6.4.2 Updating</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcCriteriaSpecifications/criteriaExecuteUpdate.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To implement the update you can use following method from <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long updateAll(UpdateSpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long updateAll(UpdateSpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun updateAll(spec: UpdateSpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is expecting <a href="../api/io/micronaut/data/repository/criteria/UpdateSpecification.html">UpdateSpecification</a> which is a variation of specification interface that includes access to <code>jakarta.persistence.criteria.CriteriaUpdate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface UpdateSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaUpdate&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria update instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Updating specific properties can be done using <code>jakarta.persistence.criteria.CriteriaUpdate</code> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">query.set(root.get(Person_.name), newName);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">query.set(root.get("name"), newName)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">query.set(root.get("name"), newName)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define criteria specification methods including update specification that will help you to create an update query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(Person_.name), name);
    }

    static PredicateSpecification&lt;Person&gt; longNameEquals(String longName) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(Person_.longName), longName);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get(Person_.age), age);
    }

    static UpdateSpecification&lt;Person&gt; setNewName(String newName) {
        return (root, query, criteriaBuilder) -&gt; {
            query.set(root.get(Person_.name), newName);
            return null;
        };
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

    static UpdateSpecification&lt;Person&gt; setNewName(String newName) {
        return (root, query, criteriaBuilder) -&gt; {
            query.set(root.get("name"), newName)
            null
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {

    fun nameEquals(name: String?) = PredicateSpecification&lt;Person&gt; { root, criteriaBuilder -&gt;
        criteriaBuilder.equal(root.get&lt;Any&gt;("name"), name)
    }

    fun ageIsLessThan(age: Int) = PredicateSpecification&lt;Person&gt; { root, criteriaBuilder -&gt;
        criteriaBuilder.lessThan(root.get("age"), age)
    }

    fun setNewName(newName: String) = UpdateSpecification&lt;Person&gt; { root, query, criteriaBuilder -&gt;
        query.set(root.get("name"), newName)
        null
    }

    fun nameInList(names: List&lt;String&gt;) = where&lt;Person&gt; {
        root[Person::name] inList names
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use the update specification combined with predicate specifications:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long recordsUpdated = personRepository.updateAll(setNewName("Steven").where(nameEquals("Denis")));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long recordsUpdated = personRepository.updateAll(setNewName("Steven").where(nameEquals("Denis")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val recordsUpdated = personRepository.updateAll(setNewName("Steven").where(nameEquals("Denis")))</code></pre>
</div>
</div>

<h2 id="criteriaExecuteDelete"><a class="anchor" href="#criteriaExecuteDelete"></a>6.4.3 Deleting</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcCriteriaSpecifications/criteriaExecuteDelete.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To delete an entity or multiple entities you can use one of the following methods from <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long deleteAll(PredicateSpecification&lt;Person&gt; spec);

long deleteAll(DeleteSpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long deleteAll(PredicateSpecification&lt;Person&gt; spec)

long deleteAll(DeleteSpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun deleteAll(spec: PredicateSpecification&lt;Person&gt;?): Long

fun deleteAll(spec: DeleteSpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>As it is for querying, <code>deleteAll</code> methods also come in two variations.</p>
</div>
<div class="paragraph">
<p>First method is expecting <a href="../api/io/micronaut/data/repository/criteria/PredicateSpecification.html">PredicateSpecification</a> which is the same interface described in <a href="#criteriaExecuteQuery">Querying</a> section</p>
</div>
<div class="paragraph">
<p>The second method comes with <a href="../api/io/micronaut/data/repository/DeleteSpecification.html">DeleteSpecification</a> and is intended only for delete criteria because it includes access to <code>jakarta.persistence.criteria.CriteriaDelete</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface DeleteSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaDelete&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria delete instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For deleting you can reuse the same predicates as for querying and updating:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(Person_.name), name);
    }

    static PredicateSpecification&lt;Person&gt; longNameEquals(String longName) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(Person_.longName), longName);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get(Person_.age), age);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {

    fun nameEquals(name: String?) = PredicateSpecification&lt;Person&gt; { root, criteriaBuilder -&gt;
        criteriaBuilder.equal(root.get&lt;Any&gt;("name"), name)
    }

    fun ageIsLessThan(age: Int) = PredicateSpecification&lt;Person&gt; { root, criteriaBuilder -&gt;
        criteriaBuilder.lessThan(root.get("age"), age)
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simply pass the predicate specification to the <code>deleteAll</code> method:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long recordsDeleted = personRepository.deleteAll(where(nameEquals("Denis")));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long recordsDeleted = personRepository.deleteAll(where(nameEquals("Denis")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val recordsDeleted = personRepository.deleteAll(PredicateSpecification.where(nameEquals("Denis")))</code></pre>
</div>
</div>

<h2 id="otherRepositoryVariations"><a class="anchor" href="#otherRepositoryVariations"></a>6.4.4 Other repository variations</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcCriteriaSpecifications/otherRepositoryVariations.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data includes different variations of specification executor interface intended to be used with async or reactive repositories.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Builtin Variations of <code>JpaSpecificationExecutor</code> repository interface</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Interface</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default interface for querying, deleting and updating data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/async/AsyncJpaSpecificationExecutor.html">AsyncJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The async version of the specifications repository</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactiveStreamsJpaSpecificationExecutor.html">ReactiveStreamsJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The reactive streams - <code>Publisher&lt;&gt;</code> version of the specifications repository</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactorJpaSpecificationExecutor.html">ReactorJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Reactor version of the specifications repository</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/kotlin/CoroutineJpaSpecificationExecutor.html">CoroutineJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kotlin version of the interface that is using coroutines</p></td>
</tr>
</tbody>
</table>

<h2 id="typeSafeJava"><a class="anchor" href="#typeSafeJava"></a>6.4.5 Type-Safe Java queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcCriteriaSpecifications/typeSafeJava.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Jakarta Persistence Criteria API supports type-safe queries by using static metamodel that are generated at compilation time.</p>
</div>
<div class="paragraph">
<p>The metamodel generator will generate a corresponding metamodel class with an underscore suffix letter e.g. an entity <code>MyEntity</code> will have a corresponding metamodel entity generated with a name <code>MyEntity_</code> and it will be in the same package as the original entity. Every field in the newly generated entity will correspond to the entity&#8217;s property and can be used as a property reference.</p>
</div>
<div class="paragraph">
<p>Example from the <a href="https://jakarta.ee/specifications/persistence/3.0/jakarta-persistence-spec-3.0.html#a10643">official API specification</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CriteriaBuilder cb = ...
CriteriaQuery&lt;String&gt; q = cb.createQuery(String.class);
Root&lt;Customer&gt; customer = q.from(Customer.class);
Join&lt;Customer, Order&gt; order = customer.join(Customer_.orders);
Join&lt;Order, Item&gt; item = order.join(Order_.lineItems);
q.select(customer.get(Customer_.name))
.where(cb.equal(item.get(Item_.product).get(Product_.productType), "printer"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that as of this writing you cannot use Micronaut Data annotations (those found in the io.micronaut.data.annotation package) to generate static JPA metadata, the only supported way is to use Jakarta Persistence annotations (located in the <code>jakarta.persistence</code> package) in combination with Hibernate JPA Static Metamodel Generator which will generate the metamodel even if at runtime you do not actually use Hibernate, but instead use Micronaut Data JDBC.</p>
</div>
<div class="paragraph">
<p>To configure the metamodel generator simply add the following dependency to the annotation processor classpath:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">annotationProcessor(<span class="hljs-string">"org.hibernate.orm:hibernate-jpamodelgen")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;annotationProcessorPaths&gt;
    &lt;path&gt;
        &lt;groupId&gt;org.hibernate.orm&lt;/groupId&gt;
        &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;
    &lt;/path&gt;
&lt;/annotationProcessorPaths&gt;</code></pre>
</div>
</div></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Hibernate 6 version of <code>hibernate-jpamodelgen-jakarta</code> is required because prior versions of Hibernate are still using the <code>javax.persistence</code> package.
For Kotlin, add the dependency in <a href="https://docs.micronaut.io/4.4.3/guide/#kaptOrKsp">kapt or ksp scope</a>, and for Groovy add it in compileOnly scope.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And we need to include the generated classes on the Java classpath to have them accessible:</p>
</div>
<div class="paragraph">
<p>Example for Gradle builds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">sourceSets {
    generated {
        java {
            srcDirs = ["$build/generated/java"]
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything is correctly set up you should be able to see the generated metamodel classes in the IDE code completion and be able to use them:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
    return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(Person_.name), name);
}

static PredicateSpecification&lt;Person&gt; longNameEquals(String longName) {
    return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(Person_.longName), longName);
}

static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
    return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get(Person_.age), age);
}

static UpdateSpecification&lt;Person&gt; setNewName(String newName) {
    return (root, query, criteriaBuilder) -&gt; {
        query.set(root.get(Person_.name), newName);
        return null;
    };
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy"></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin"></code></pre>
</div>
</div>
<hr>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static PredicateSpecification&lt;Product&gt; manufacturerNameEquals(String name) {
    return (root, cb) -&gt; cb.equal(root.join(Product_.manufacturer).get(Manufacturer_.name), name);
}

static PredicateSpecification&lt;Product&gt; joined() {
    return (root, cb) -&gt; {
        root.join("manufacturer");
        return null;
    };
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy"></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin"></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More information about the static metamodel can be found in the <a href="https://jakarta.ee/specifications/persistence/3.0/jakarta-persistence-spec-3.0.html#a6933">official specification</a>
</td>
</tr>
</table>
</div>

<h2 id="sqlMapping"><a class="anchor" href="#sqlMapping"></a>6.5 Mapping Entities</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As mentioned in the <a href="#jdbcQuickStart">Quick Start</a> section, if you need to customize how entities map to the table and column names of the database you can use JPA annotations to do so or Micronaut Data&#8217;s own annotations in the <code>io.micronaut.data.annotation</code> package.</p>
</div>
<div class="paragraph">
<p>An important aspect of Micronaut Data JDBC / R2DBC is that regardless whether you use JPA annotations or Micronaut Data annotations the entity classes must be compiled with Micronaut Data.</p>
</div>
<div class="paragraph">
<p>This is because Micronaut Data pre-computes the persistence model (the relationships between entities, the class/property name to table/column name mappings) at compilation time, which is one of the reasons Micronaut Data JDBC can start up so fast.</p>
</div>
<div class="paragraph">
<p>An example of mapping with Micronaut Data annotations can be seen below:</p>
</div>
<div class="listingblock">
<div class="title">Micronaut Data Annotation Mapping Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/*
 * Copyright 2017-2020 original authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.micronaut.data.tck.entities;

import io.micronaut.data.annotation.AutoPopulated;
import io.micronaut.data.annotation.Id;
import io.micronaut.data.annotation.MappedEntity;
import io.micronaut.data.annotation.Relation;

import java.util.Set;
import java.util.UUID;

@MappedEntity
public class Country {

    @Id
    @AutoPopulated
    private UUID uuid;
    private String name;

    @Relation(value = Relation.Kind.ONE_TO_MANY, mappedBy = "country")
    private Set&lt;CountryRegion&gt; regions;

    public Country(String name) {
        this.name = name;
    }

    public String getName() {
        return name;
    }

    public UUID getUuid() {
        return uuid;
    }

    public void setUuid(UUID uuid) {
        this.uuid = uuid;
    }

    public Set&lt;CountryRegion&gt; getRegions() {
        return regions;
    }

    public void setRegions(Set&lt;CountryRegion&gt; regions) {
        this.regions = regions;
    }
}</code></pre>
</div>
</div>

<h2 id="sqlAnnotations"><a class="anchor" href="#sqlAnnotations"></a>6.5.1 SQL Annotations</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlAnnotations.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The following table summarizes the different annotations and what they enable. If you are familiar with and prefer the JPA annotations then feel free to skip to the next section:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Micronaut Data Annotations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Annotation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/AutoPopulated.html">@AutoPopulated</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Meta annotation for a value that should be auto-populated by Micronaut Data (such as time stamps and UUIDs)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/DateCreated.html">@DateCreated</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows assigning a data created value (such as a <code>java.time.Instant</code>) prior to an insert</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/DateUpdated.html">@DateUpdated</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows assigning a last updated value (such as a <code>java.time.Instant</code>) prior to an insert or an update</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Embeddable.html">@Embeddable</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies that the bean is embeddable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/EmbeddedId.html">@EmbeddedId</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies an embedded ID of an entity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/GeneratedValue.html">@GeneratedValue</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies that the property value is generated by the database and not included in inserts</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/jdbc/annotation/JoinTable.html">@JoinTable</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a join table association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/jdbc/annotation/JoinColumn.html">@JoinColumn</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a join column mapping</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Id.html">@Id</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the ID of an entity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the entity is mapped to the database. If your table name differs from the entity name, pass the name as the <code>value</code>. For example: <code>@MappedEntity( value = "TABLE_NAME" )</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/MappedProperty.html">@MappedProperty</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to customize the column name, definition and data type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Relation.html">@Relation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to specify a relationship (one-to-one, one-to-many, etc.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Transient.html">@Transient</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to specify a property is transient</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/TypeDef.html">@TypeDef</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to specify the property&#8217;s data type and custom converter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Version.html">@Version</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the version field of an entity, enables optimistic locking</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In the case of using JPA only a subset of annotations are supported including the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Basic: <code>@Table</code> <code>@Id</code> <code>@Version</code> <code>@Column</code> <code>@Transient</code> <code>@Enumerated</code></p>
</li>
<li>
<p>Embedded definition:  <code>@Embedded</code> <code>@EmbeddedId</code> <code>@Embeddable</code></p>
</li>
<li>
<p>Relationship mapping: <code>@OneToMany</code> <code>@OneToOne</code> <code>@ManyToOne</code> <code>@ManyToMany</code></p>
</li>
<li>
<p>Join specification: <code>@JoinTable</code> <code>@JoinColumn</code></p>
</li>
<li>
<p>Type converters: <code>@Convert</code> <code>@Converter</code> and <code>AttributeConverter</code> interface</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Micronaut Data supports both <code>javax.persistence</code> and <code>jakarta.persistence</code> packages.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again Micronaut Data JDBC / R2DBC is not an ORM, but instead a simple data mapper so many of the concepts in JPA simply don&#8217;t apply, however for users familiar with these annotations it is handy being able to use them.</p>
</div>

<h2 id="sqlExpandableQueries"><a class="anchor" href="#sqlExpandableQueries"></a>6.5.2 Expandable queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlExpandableQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In some cases, the query needs to be expanded to accommodate all the parameter&#8217;s values. The query with a parameter which is a collection or an array: <code>WHERE value IN (?)</code> would be expanded to: <code>WHERE value IN (?, ?, ?, ?)</code></p>
</div>
<div class="paragraph">
<p>Micronaut Data will store additional information about the query at the build-time if one of the parameters is expandable, that eliminates the need to parse the query at runtime.</p>
</div>
<div class="paragraph">
<p>By default, all parameters of a type that extends <code>java.lang.Iterable</code> are automatically expandable. You can mark a parameter as expandable by annotating it with <a href="../api/io/micronaut/data/annotation/Expandable.html">@Expandable</a>, for example, you might want to do it if the parameter is an array.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s better to use the array type if your targeted database supports it. For example, in Postgres you can use <code>WHERE value = ANY (:myValues)</code> where <code>myValues</code> is of type <code>@TypeDef(type = DataType.STRING_ARRAY)</code>.
</td>
</tr>
</table>
</div>

<h2 id="sqlIdGenerator"><a class="anchor" href="#sqlIdGenerator"></a>6.5.3 ID Generation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlIdGenerator.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The default ID generation expects the database to populate a value for the ID such as an <code>IDENTITY</code> column.</p>
</div>
<div class="paragraph">
<p>You can remove the <code>@GeneratedValue</code> annotation and in this case the expectation is that you will assign an ID before calling <code>save()</code>.</p>
</div>
<div class="paragraph">
<p>If you wish to use sequences for the ID you should invoke the SQL that generates the sequence value and assign it prior to calling <code>save()</code>.</p>
</div>
<div class="paragraph">
<p>Automatically assigned UUIDs are also supported by adding a property annotated with <code>@Id</code> and <code>@AutoPopulated</code>.</p>
</div>

<h2 id="sqlCompositeId"><a class="anchor" href="#sqlCompositeId"></a>6.5.4 Composite Primary Keys</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlCompositeId.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Composite primary keys can be defined using either JPA or Micronaut Data annotations. A composite ID requires an additional class to represent the key. The class should define fields that correspond to the columns making up the composite key. For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import jakarta.persistence.Embeddable;
import java.util.Objects;

@Embeddable
public class ProjectId {
    private final int departmentId;
    private final int projectId;

    public ProjectId(int departmentId, int projectId) {
        this.departmentId = departmentId;
        this.projectId = projectId;
    }

    public int getDepartmentId() {
        return departmentId;
    }

    public int getProjectId() {
        return projectId;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        }
        if (o == null || getClass() != o.getClass()) {
            return false;
        }
        ProjectId projectId1 = (ProjectId) o;
        return departmentId == projectId1.departmentId &amp;&amp;
                projectId == projectId1.projectId;
    }

    @Override
    public int hashCode() {
        return Objects.hash(departmentId, projectId);
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.EqualsAndHashCode
import jakarta.persistence.Embeddable

@EqualsAndHashCode
@Embeddable
class ProjectId {
    final int departmentId
    final int projectId

    ProjectId(int departmentId, int projectId) {
        this.departmentId = departmentId
        this.projectId = projectId
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.Embeddable

@Embeddable
data class ProjectId(val departmentId: Int, val projectId: Int)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is recommended that the ID class be immutable and implement <code>equals</code>/<code>hashCode</code>.
TIP: When using Java, be sure to define getters for the fields making up your composite key.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can then declare the <code>id</code> property of the entity using either JPA&#8217;s <code>@EmbeddedId</code> or <a href="../api/io/micronaut/data/annotation/EmbeddedId.html">@EmbeddedId</a>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import jakarta.persistence.EmbeddedId;
import jakarta.persistence.Entity;

@Entity
public class Project {
    @EmbeddedId
    private ProjectId projectId;
    private String name;

    public Project(ProjectId projectId, String name) {
        this.projectId = projectId;
        this.name = name;
    }

    public ProjectId getProjectId() {
        return projectId;
    }

    public String getName() {
        return name;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import jakarta.persistence.EmbeddedId
import jakarta.persistence.Entity

@Entity
class Project {
    @EmbeddedId
    private ProjectId projectId
    private String name

    Project(ProjectId projectId, String name) {
        this.projectId = projectId
        this.name = name
    }

    ProjectId getProjectId() {
        return projectId
    }

    String getName() {
        return name
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.EmbeddedId
import jakarta.persistence.Entity

@Entity
class Project(
    @EmbeddedId val projectId: ProjectId,
    val name: String
)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To alter the column mappings for the ID, you may use the <code>@Column</code> annotation on the fields within the <code>ProjectId</code> class
</td>
</tr>
</table>
</div>

<h2 id="sqlConstructorArguments"><a class="anchor" href="#sqlConstructorArguments"></a>6.5.5 Constructor Arguments</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlConstructorArguments.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data JDBC / R2DBC also allows the definition of immutable objects using constructor arguments instead of getters/setters. If you define multiple constructors then the one used to create the object from the database should be annotated with <code>io.micronaut.core.annotation.Creator</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.Creator;

import jakarta.persistence.*;

@Entity
public class Manufacturer {
    @Id
    @GeneratedValue
    private Long id;
    private String name;

    @Creator
    public Manufacturer(String name) {
        this.name = name;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.Creator

import jakarta.persistence.*

@Entity
class Manufacturer {
    @Id
    @GeneratedValue
    Long id
    final String name

    @Creator
    Manufacturer(String name) {
        this.name = name
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.*

@Entity
data class Manufacturer(
    @Id
    @GeneratedValue
    var id: Long?,
    val name: String
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the example above, the <code>ID</code> of the object should however include a setter since this has to be assigned from the database generated value.</p>
</div>

<h2 id="sqlNaming"><a class="anchor" href="#sqlNaming"></a>6.5.6 SQL Naming Strategies</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlNaming.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The default naming strategy when converting camel case class and property names to database tables and columns is to use underscore separated lower case. In other words <code>FooBar</code> becomes <code>foo_bar</code>.</p>
</div>
<div class="paragraph">
<p>If this is not satisfactory then you can customize this by setting the <code>namingStrategy</code> member of the <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a> annotation on the entity:</p>
</div>
<div class="listingblock">
<div class="title">Micronaut Data Naming Strategy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity(namingStrategy = NamingStrategies.Raw.class)
public class CountryRegion {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Few important things to note. Since Micronaut Data pre-computes the table and column name mappings at compilation time the specified <a href="../api/io/micronaut/data/model/naming/NamingStrategy.html">NamingStrategy</a> implementation must be on the annotation processor classpath (<code>annotationProcessor</code> scope for Java or <code>kapt</code> for Kotlin).</p>
</div>
<div class="paragraph">
<p>If running project in native image, custom naming strategy needs to have <code>io.micronaut.core.annotation.TypeHint(CustomNamingStrategy.class)</code> annotation where custom naming strategy class is <code>CustomNamingStrategy</code>.</p>
</div>
<div class="paragraph">
<p>In addition, if you don&#8217;t want to repeat the above annotation definition on every entity it is handy to define a meta-annotation where the above annotation definition is applied to another annotation that you add to your class.</p>
</div>
<div class="sect2">
<h3 id="_escaping_tablecolumn_name_identifiers">Escaping Table/Column Name Identifiers</h3>
<div class="paragraph">
<p>In some cases it may be necessary to escape table and/or column names if characters are used within the names that are invalid without the presence of escaping.</p>
</div>
<div class="paragraph">
<p>In this case you should set the <code>escape</code> member of the <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a> annotation to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity(escape=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Micronaut Data will generate SQL statements that escape table and column names within queries using the escape character that is appropriate for the configured SQL dialect.</p>
</div>
</div>
<div class="sect2">
<h3 id="_overriding_default_query_alias">Overriding default query alias</h3>
<div class="paragraph">
<p>The default query alias is the table name followed by an underscore. If you want to change it, specify it in the <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity(alias="my_table_")</code></pre>
</div>
</div>
</div>

<h2 id="sqlAssociationMapping"><a class="anchor" href="#sqlAssociationMapping"></a>6.5.7 Association Mapping</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlAssociationMapping.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To specify a relation between two entities you need to use <a href="../api/io/micronaut/data/annotation/Relation.html">@Relation</a> annotation. The relation kind is specified using enum <a href="../api/io/micronaut/data/annotation/Relation.Kind.html">@Kind</a> <code>value</code> attribute which is similar to JPA relations annotation names (<code>@OneToMany</code>, <code>@OneToOne</code> etc.)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Micronaut Data supported relations:</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kind</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.ONE_TO_MANY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One-To-Many association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.ONE_TO_ONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One-To-One association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.MANY_TO_MANY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Many-To-Many association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.MANY_TO_ONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Many-To-One association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.EMBEDDED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedded association</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Use 'mappedBy' to specify inverse property that this relation is mapped by.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Micronaut Data supported association cascade types:</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cascade.PERSIST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associated entity or entities are going to be persisted when owning entity is saved</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cascade.UPDATE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associated entity or entities are going to be updated when owning entity is updated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cascade.NONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Default) No operation is cascaded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cascade.ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All (<code>Cascade.PERSIST</code> and <code>Cascade.UPDATE</code>) operations are cascaded</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can use JPA&#8217;s equivalent annotations <a href="../api/io/micronaut/data/jdbc/annotation/JoinTable.html">@JoinTable</a> and <a href="../api/io/micronaut/data/jdbc/annotation/JoinColumn.html">@JoinColumn</a> to specify more complex mapping definition.
</td>
</tr>
</table>
</div>

<h2 id="sqlAssociationFetching"><a class="anchor" href="#sqlAssociationFetching"></a>6.5.8 Association Fetching</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlAssociationFetching.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data is a simple data mapper, hence it will not fetch any associations for you using techniques like lazy loading of entity proxies for single-ended associations.</p>
</div>
<div class="paragraph">
<p>You must instead specify ahead of time what data you want to fetch. You cannot map an association as being eager or lazy. The reason for this design choice is simple, even in the JPA world accessing lazy associations or lazy initialization collections is considered bad practice due to the N+1 query issue and the recommendation is always to write an optimized join query.</p>
</div>
<div class="paragraph">
<p>Micronaut Data JDBC / R2DBC takes this a step further by simply not supporting those features considered bad practice anyway. However, it does impact how you may model an association. For example, if you define an association in a constructor argument such as the following entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import jakarta.persistence.*;

@Entity
public class Product {

    @Id
    @GeneratedValue
    private Long id;
    private String name;
    @ManyToOne
    private Manufacturer manufacturer;

    public Product(String name, Manufacturer manufacturer) {
        this.name = name;
        this.manufacturer = manufacturer;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public Manufacturer getManufacturer() {
        return manufacturer;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import jakarta.persistence.*

@Entity
class Product {

    @Id
    @GeneratedValue
    Long id
    private String name
    @ManyToOne
    private Manufacturer manufacturer

    Product(String name, Manufacturer manufacturer) {
        this.name = name
        this.manufacturer = manufacturer
    }

    String getName() {
        return name
    }

    Manufacturer getManufacturer() {
        return manufacturer
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.*

@Entity
data class Product(
    @Id
    @GeneratedValue
    var id: Long?,
    var name: String,
    @ManyToOne
    var manufacturer: Manufacturer?
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then attempt to read the <code>Product</code> entity back without specifying a join an exception will occur since the <code>manufacturer</code> association is not <code>Nullable</code>.</p>
</div>
<div class="paragraph">
<p>There are few ways around this, one way is to declare at the repository level to always fetch <code>manufacturer</code>, another is declared the <code>@Nullable</code> annotation on the <code>manufacturer</code> argument to allow it to be declared <code>null</code> (or in Kotlin add <code>?</code> to the end of the constructor argument name). Which approach you choose is dependent on the design of the application.</p>
</div>
<div class="paragraph">
<p>The following section provides more coverage on handling joins.</p>
</div>

<h2 id="columnTransformer"><a class="anchor" href="#columnTransformer"></a>6.5.9 Using @ColumnTransformer</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/columnTransformer.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Inspired by the similar annotation in Hibernate, you can apply a transformation when either reading or writing a column from or to the database using the <a href="../api/io/micronaut/data/jdbc/annotation/ColumnTransformer.html">@ColumnTransformer</a> annotation.</p>
</div>
<div class="paragraph">
<p>This feature can be used to encrypt/decrypt values or invoke any arbitrary database function. To define a read transformation use the <code>read</code> member. For example:</p>
</div>
<div class="listingblock">
<div class="title">Applying a read transformation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ColumnTransformer(read = "UPPER(@.name)")
private String name;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>@</code> is a query alias placeholder and will be replaced with one if the query specifies it. Example: <code>"UPPER(@.name)</code> is going to become <code>UPPER(project_.name).</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To apply a write transformation you should use the <code>write</code> member and include exactly one <code>?</code> placeholder:</p>
</div>
<div class="listingblock">
<div class="title">Apply a write transformation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ColumnTransformer(write = "UPPER(?)")
private String name;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this any place any <code>INSERT</code> or <code>UPDATE</code> statement generated will include the above <code>write</code> entry.</p>
</div>

<h2 id="mappedPropertyAlias"><a class="anchor" href="#mappedPropertyAlias"></a>6.5.10 Using @MappedProperty alias</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/mappedPropertyAlias.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>If there is a need to return column name in the result set as custom name, there is <code>alias</code> property in the <a href="../api/io/micronaut/data/annotation/MappedProperty.html">@MappedProperty</a> annotation.</p>
</div>
<div class="paragraph">
<p>It can be useful, for example, in legacy columns that might be too long for the query result (when combined with table aliases can exceed max column length).</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.Id;
import io.micronaut.data.annotation.MappedProperty;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;


@Entity
public class Person {
    @Id
    @GeneratedValue
    private Long id;
    private String name;
    private int age;
    @MappedProperty(value = "long_name_column_legacy_system", alias = "long_name")
    private String longName;

    public Person() {
    }

    public Person(String name, int age, String longName) {
        this(null, name, age, longName);
    }

    public Person(Long id, String name, int age, String longName) {
        this.id = id;
        this.name = name;
        this.age = age;
        this.longName = longName;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getLongName() {
        return longName;
    }

    public void setLongName(String longName) {
        this.longName = longName;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.Id
import jakarta.persistence.Entity
import jakarta.persistence.GeneratedValue


@Entity
class Person {
    @Id
    @GeneratedValue
    private Long id
    private String name
    private int age

    Person() {
    }

    Person(String name, int age) {
        this(null, name, age)
    }

    Person(Long id, String name, int age) {
        this.id = id
        this.name = name
        this.age = age
    }

    Long getId() {
        return id
    }

    void setId(Long id) {
        this.id = id
    }

    String getName() {
        return name
    }

    void setName(String name) {
        this.name = name
    }

    int getAge() {
        return age
    }

    void setAge(int age) {
        this.age = age
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.Id
import jakarta.persistence.Entity
import jakarta.persistence.GeneratedValue

@Entity
class Person {
    @Id
    @GeneratedValue
    var id: Long? = null
    var name: String? = null
    var age = 0

    constructor(name: String?, age: Int) : this(null, name, age) {}
    constructor(id: Long?, name: String?, age: Int) {
        this.id = id
        this.name = name
        this.age = age
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, original column name <code>long_name_column_legacy_system</code> will be returned in a result from the database as <code>long_name</code>.
When <code>alias</code> property is set then be careful when writing custom or native queries to return field as indicated in <code>alias</code> value.</p>
</div>
<div class="paragraph">
<p>Setting <code>alias</code> in MappedProperty on assocations does not have an effect as it makes sense only on fields/columns mappings.</p>
</div>

<h2 id="sqlJsonType"><a class="anchor" href="#sqlJsonType"></a>6.5.11 JSON Column Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlJsonType.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>You can declare a field of a class as a JSON type using the <a href="../api/io/micronaut/data/annotation/TypeDef.html">@TypeDef</a> annotation as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@TypeDef(type = DataType.JSON)
private Map&lt;String, String&gt; data;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above will map to a column called <code>data</code>. Depending on the underling database the column type will be adjusted. For example for Postgres which features native JSON support the column type will be <code>JSONB</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To allow JSON to be serialized and deserialized in entity properties you must have Jackson and the <code>micronaut-runtime</code> module your classpath.
</td>
</tr>
</table>
</div>

<h2 id="sqlJsonView"><a class="anchor" href="#sqlJsonView"></a>6.5.12 JSON View</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/sqlMapping/sqlJsonView.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Since Micronaut Data 4.0 and Oracle23c database, an entity can be mapped to an JSON VIEW as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@JsonView("CONTACT_VIEW")
public class ContactView</code></pre>
</div>
</div>
<div class="paragraph">
<p>where "CONTACT_VIEW" is actual name of duality json view object in the database. It is currently supported only by the Oracle database, since version 23c.
More about Oracle JSON VIEW can be read here <a href="https://docs.oracle.com/en/database/oracle/oracle-database/23/jsnvu/overview-json-relational-duality-views.html" class="bare">https://docs.oracle.com/en/database/oracle/oracle-database/23/jsnvu/overview-json-relational-duality-views.html</a>.</p>
</div>
<div class="paragraph">
<p>Essentially, json view will be treated like mapped entity and will return JSON structure from the database and be mapped to java entity. All CRUD operations can be
performed against json view mapped entities.</p>
</div>
<div class="paragraph">
<p>Limitations</p>
</div>
<div class="ulist">
<ul>
<li>
<p>During schema creation, json view mapped entities are skipped, and it is expected for users to create them manually or via migration scripts.</p>
</li>
</ul>
</div>

<h2 id="javaRecords"><a class="anchor" href="#javaRecords"></a>6.5.13 Support for Java 16 Records</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/javaRecords.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Since 2.3.0, Micronaut Data JDBC / R2DBC has support for using Java 16 records to model entities.</p>
</div>
<div class="paragraph">
<p>The following record class demonstrates this capability:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.Nullable;
import io.micronaut.data.annotation.*;
import java.util.Date;

@MappedEntity // <b class="conum">(1)</b>
record Book(
        @Id @GeneratedValue @Nullable Long id, // <b class="conum">(2)</b>
        @DateCreated @Nullable Date dateCreated,
        String title,
        int pages) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a> annotation is used on the record</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The database identifier is annotated with <a href="../api/io/micronaut/data/annotation/Id.html">@Id</a> and <a href="../api/io/micronaut/data/annotation/GeneratedValue.html">@GeneratedValue</a> plus marked as <code>@Nullable</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since records are immutable constructor arguments that are generated values need to be marked as <code>@Nullable</code> and you should pass <code>null</code> for those arguments. The following presents an example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book book = new Book(null,null, "The Stand", 1000);
book = bookRepository.save(book);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to note that the returned instance is not the same as the instance passed to the <code>save</code> method. When a write operation is performed Micronaut Data will use a copy-constructor approach to populate the database identifier and return a new instance from the <code>save</code> method.</p>
</div>

<h2 id="kotlinData"><a class="anchor" href="#kotlinData"></a>6.5.14 Support for Kotlin immutable data classes</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/kotlinData.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data JDBC / R2DBC supports using immutable Kotlin data classes as model entities.
The implementation is the same as for Java 16 records: to modify an entity a copy-constructor will be used and every modification means a new entity instance.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/Student.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import io.micronaut.data.annotation.Relation

@MappedEntity
data class Student(
        @field:Id @GeneratedValue
        val id: Long?,
        val name: String,
        @Relation(value = Relation.Kind.MANY_TO_MANY, cascade = [Relation.Cascade.PERSIST])
        val courses: List&lt;Course&gt;,
        @Relation(value = Relation.Kind.ONE_TO_MANY, mappedBy = "student")
        val ratings: List&lt;CourseRating&gt;
) {
    constructor(name: String, items: List&lt;Course&gt;) : this(null, name, items, emptyList())
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Generated values and relations that cannot be created during the entity initialization should be declared as nullable.
</td>
</tr>
</table>
</div>

<h2 id="dbcDataTypes"><a class="anchor" href="#dbcDataTypes"></a>6.6 Data Types</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcDataTypes.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data JDBC / R2DBC supports most common Java data types. The following properties types are supported by default:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All primitive types and their wrappers (<code>int</code>, <code>java.lang.Integer</code> etc.)</p>
</li>
<li>
<p><code>CharSequence</code>, <code>String</code> etc.</p>
</li>
<li>
<p>Date types like <code>java.util.Date</code>, <code>java.time.LocalDate</code> etc.</p>
</li>
<li>
<p>Enum types (by name only)</p>
</li>
<li>
<p>Entity References. In the case of <code>@ManyToOne</code> the foreign key column name is computed to be the name of the association plus a suffix of <code>_id</code>. You can alter this with either <code>@Column(name="..")</code> or by providing a <code>NamingStrategy.mappedName(..)</code> implementation.</p>
</li>
<li>
<p>Collections of Entity. In the case of <code>@OneToMany</code> and if <code>mappedBy</code> is specified then it is expected that the inverse property exists defining the column, otherwise a join table mapping is created.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you wish to define a custom data type then you can do so by defining a class that is annotated with <a href="../api/io/micronaut/data/annotation/TypeDef.html">@TypeDef</a>.</p>
</div>

<h2 id="dbcAttributeConverter"><a class="anchor" href="#dbcAttributeConverter"></a>6.7 Using Attribute Converter</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcAttributeConverter.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>There are cases where you would like to represent the attribute differently in the database than in the entity.</p>
</div>
<div class="paragraph">
<p>Consider the following example entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import jakarta.persistence.*;

@Entity
public class Sale {

    @ManyToOne
    private final Product product;
    private final Quantity quantity;

    @Id
    @GeneratedValue
    private Long id;

    public Sale(Product product, Quantity quantity) {
        this.product = product;
        this.quantity = quantity;
    }

    public Product getProduct() {
        return product;
    }

    public Quantity getQuantity() {
        return quantity;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import jakarta.persistence.Id
import jakarta.persistence.Entity
import jakarta.persistence.ManyToOne
import jakarta.persistence.GeneratedValue

@Entity
class Sale {

    @ManyToOne
    final Product product

    final Quantity quantity

    @Id
    @GeneratedValue
    Long id

    Sale(Product product, Quantity quantity) {
        this.product = product
        this.quantity = quantity
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.*

@Entity
data class Sale(
    @Id
    @GeneratedValue
    var id: Long?,
    @ManyToOne
    val product: Product,
    val quantity: Quantity
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Sale</code> class has a reference to a type <code>Quantity</code>. The <code>Quantity</code> type is defined as:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.TypeDef;
import io.micronaut.data.model.DataType;

@TypeDef(type = DataType.INTEGER, converter = QuantityAttributeConverter.class)
public class Quantity {

    private final int amount;

    private Quantity(int amount) {
        this.amount = amount;
    }

    public int getAmount() {
        return amount;
    }

    public static Quantity valueOf(int amount) {
        return new Quantity(amount);
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.Immutable
import io.micronaut.data.annotation.TypeDef
import io.micronaut.data.model.DataType

@TypeDef(type = DataType.INTEGER, converter = QuantityAttributeConverter.class)
@Immutable
class Quantity {
    int amount
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.TypeDef
import io.micronaut.data.model.DataType

@TypeDef(type = DataType.INTEGER, converter = QuantityAttributeConverter::class)
data class Quantity(val amount: Int)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see <code>@TypeDef</code> is used to define the <code>Quantity</code> type as an <code>INTEGER</code> using the <a href="../api/io/micronaut/data/model/DataType.html">DataType</a> enum.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you cannot declare <code>@TypeDef</code> directly on the type then you can declare it on the field where the type is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The last step is to add custom attribute conversion so that Micronaut Data knows how to read and write the type from an <code>Integer</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.convert.ConversionContext;
import io.micronaut.data.model.runtime.convert.AttributeConverter;
import jakarta.inject.Singleton;

@Singleton // <b class="conum">(1)</b>
public class QuantityAttributeConverter implements AttributeConverter&lt;Quantity, Integer&gt; {

    @Override // <b class="conum">(2)</b>
    public Integer convertToPersistedValue(Quantity quantity, ConversionContext context) {
        return quantity == null ? null : quantity.getAmount();
    }

    @Override // <b class="conum">(3)</b>
    public Quantity convertToEntityValue(Integer value, ConversionContext context) {
        return value == null ? null : Quantity.valueOf(value);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.CompileStatic
import io.micronaut.core.convert.ConversionContext
import io.micronaut.data.model.runtime.convert.AttributeConverter
import jakarta.inject.Singleton

@Singleton // <b class="conum">(1)</b>
@CompileStatic
class QuantityAttributeConverter implements AttributeConverter&lt;Quantity, Integer&gt; {

    @Override // <b class="conum">(2)</b>
    Integer convertToPersistedValue(Quantity quantity, ConversionContext context) {
        return quantity == null ? null : quantity.getAmount()
    }

    @Override // <b class="conum">(3)</b>
    Quantity convertToEntityValue(Integer value, ConversionContext context) {
        return value == null ? null : new Quantity(value)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.core.convert.ConversionContext
import io.micronaut.data.model.runtime.convert.AttributeConverter
import jakarta.inject.Singleton

@Singleton // <b class="conum">(1)</b>
class QuantityAttributeConverter : AttributeConverter&lt;Quantity?, Int?&gt; {

    // <b class="conum">(2)</b>
    override fun convertToPersistedValue(quantity: Quantity?, context: ConversionContext): Int? {
        return quantity?.amount
    }

    // <b class="conum">(3)</b>
    override fun convertToEntityValue(value: Int?, context: ConversionContext): Quantity? {
        return if (value == null) null else Quantity(value)
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The attribute converter implements <a href="../api/io/micronaut/data/model/runtime/convert/AttributeConverter.html">@AttributeConverter</a> and must be a bean</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A converter from <code>Quantity</code> to <code>Integer</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A converter from <code>Integer</code> to <code>Quantity</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s possible to define the converter using <a href="../api/io/micronaut/data/annotation/MappedProperty.html">@MappedProperty</a>: <code>@MappedProperty(converter = QuantityTypeConverter.class)</code>, in this case the data type will be detected automatically.
</td>
</tr>
</table>
</div>

<h2 id="dbcJoinQueries"><a class="anchor" href="#dbcJoinQueries"></a>6.8 Join Queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcJoinQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As discussed in the previous section, Micronaut Data JDBC doesn&#8217;t support associations in the traditional ORM sense. There is no lazy loading or support for proxies.</p>
</div>
<div class="paragraph">
<p>Consider a <code>Product</code> entity from the previous section that has an association to a <code>Manufacturer</code> entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.Creator;

import jakarta.persistence.*;

@Entity
public class Manufacturer {
    @Id
    @GeneratedValue
    private Long id;
    private String name;

    @Creator
    public Manufacturer(String name) {
        this.name = name;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.Creator

import jakarta.persistence.*

@Entity
class Manufacturer {
    @Id
    @GeneratedValue
    Long id
    final String name

    @Creator
    Manufacturer(String name) {
        this.name = name
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import jakarta.persistence.*

@Entity
data class Manufacturer(
    @Id
    @GeneratedValue
    var id: Long?,
    val name: String
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Say you query for <code>Product</code> instances, what happens is that by default Micronaut Data JDBC will only query for and fetch the simple properties. In the case of single ended associations like the above Micronaut Data will only retrieve the ID and assign it if is possible (In the case of entities that require constructor arguments this is not even possible).</p>
</div>
<div class="paragraph">
<p>If you need to fetch the association too then you can use the <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation on your repository interface to specify that a <code>INNER JOIN</code> (or whichever join types is more appropriate) should be executed to retrieve the associated <code>Manufacturer</code>.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@JdbcRepository(dialect = Dialect.H2)
public interface ProductRepository extends CrudRepository&lt;Product, Long&gt; {
    @Join(value = "manufacturer", type = Join.Type.FETCH) // <b class="conum">(1)</b>
    List&lt;Product&gt; list();
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@JdbcRepository(dialect = Dialect.H2)
public interface ProductRepository extends CrudRepository&lt;Product, Long&gt; {
    @Join(value = "manufacturer", type = Join.Type.FETCH) // <b class="conum">(1)</b>
    List&lt;Product&gt; list();
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@JdbcRepository(dialect = Dialect.H2)
interface ProductRepository : CrudRepository&lt;Product, Long&gt; {
    @Join(value = "manufacturer", type = Join.Type.FETCH) // <b class="conum">(1)</b>
    fun list(): List&lt;Product&gt;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> is used to indicate a <code>INNER JOIN</code> clause should be included.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation is repeatable and hence can be specified multiple time for different associations. In addition, the <code>type</code> member of the annotation can be used to specify the join type, for example <code>LEFT</code>, <code>INNER</code> or <code>RIGHT</code>.</p>
</div>
<div class="paragraph">
<p>Finally, by default Micronaut Data will generate aliases to use for selecting columns in joins and querying. However, if at any point you experience a conflict you can specify an alias for a particular join using the <code>alias</code> member of the <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation. You can override the default entity alias using the <code>alias</code> member of the <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a> annotation.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Some databases like Oracle limit the length of alias names in SQL queries so another reason you may want to set custom aliases is to avoid exceeding the alias name length restriction in Oracle.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you need to do anything more complex than the join options Micronaut Data has to offer then you may need a native query.</p>
</div>

<h2 id="dbcNativeQueries"><a class="anchor" href="#dbcNativeQueries"></a>6.9 Explicit Queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcNativeQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>When using Micronaut Data with JDBC you can execute native SQL queries using the <a href="../api/io/micronaut/data/annotation/Query.html">@Query</a> annotation:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query("select * from book b where b.title like :title limit 5")
List&lt;Book&gt; findBooks(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query("select * from book b where b.title like :title limit 5")
List&lt;Book&gt; findBooks(String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query("select * from book b where b.title like :title limit 5")
fun findBooks(title: String): List&lt;Book&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will execute the raw SQL against the database.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For <a href="#pagination">Pagination</a> queries that return a <a href="../api/io/micronaut/data/model/Page.html">Page</a> you also need to specify a native <code>countQuery</code>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_explicit_queries_and_joins">Explicit Queries and Joins</h3>
<div class="paragraph">
<p>When writing an explicit SQL query if you specify any joins within the query you may want the resulting data bound to the returned entity. Micronaut Data will not automatically do this, instead you need to specify the associated <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Query("""
        SELECT *, m_.name as m_name, m_.id as m_id
        FROM product p
        INNER JOIN manufacturer m_ ON p.manufacturer_id = m_.id
        WHERE p.name like :name limit 5""")
    @Join(value = "manufacturer", alias = "m_")
    List&lt;Product&gt; searchProducts(String name);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">    @Query("""SELECT *, m_.name as m_name, m_.id as m_id
              FROM product p
              INNER JOIN manufacturer m_ ON p.manufacturer_id = m_.id
              WHERE p.name like :name limit 5""")
    @Join(value = "manufacturer", alias = "m_")
    List&lt;Product&gt; searchProducts(String name);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">    @Query("""SELECT *, m_.name as m_name, m_.id as m_id
                    FROM product p
                    INNER JOIN manufacturer m_ ON p.manufacturer_id = m_.id
                    WHERE p.name like :name limit 5""")
    @Join(value = "manufacturer", alias = "m_")
    fun searchProducts(name: String): List&lt;Product&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the query uses an alias called <code>m_</code> to query the <code>manufacturer</code> table via an <code>INNER JOIN</code>. Since the returned <code>Product</code> entity features a <code>manufacturer</code> association it may be nice to materialize this object as well. The <code>alias</code> member of the <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation is used to specify which alias to materialize the <code>Manufacturer</code> instance from.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is necessary to use the "logical name" of the field in the <code>@Join</code> (the name used in the <code>@Entity</code> class) and not the name used in the native query itself. In the previous example, if the name in the class were <code>myManufacturer</code>, then you would need to use <code>Join(value = "myManufacturer", alias = "m_")</code> without modifying anything on the native sql query.
</td>
</tr>
</table>
</div>
</div>

<h2 id="dbcProcedures"><a class="anchor" href="#dbcProcedures"></a>6.10 Procedures</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dbc/dbcProcedures.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data supports executing simple SQL procedures. Simply annotate a repository method with <a href="../api/io/micronaut/data/annotation/sql/Procedure.html">@Procedure</a>.
All the method parameters will be used as incoming parameters of the procedure and not-void result will be bind as an out parameter.
By default, the method name will be used as the procedure name, to customize the name it&#8217;s possible to use the <code>value</code> attribute:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Procedure
Long calculateSum(@NonNull Long bookId);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Procedure
Long calculateSum(@NonNull Long bookId);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Procedure
fun calculateSum(bookId: @NonNull Long): Long</code></pre>
</div>
</div>

<h1 id="mongo"><a class="anchor" href="#mongo"></a>7 Micronaut Data MongoDB</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data MongoDB supports most of the things that are possible to do with JPA and JDBC/R2DBC implementations, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#mongoRepositories">Repositories with compile-time generated filtering, aggregation</a> and <a href="#projections">projection</a> queries</p>
</li>
<li>
<p><a href="#mongoAssociationMapping">Entities relations and cascading</a></p>
</li>
<li>
<p><a href="#transactions">Transactions</a></p>
</li>
<li>
<p><a href="#mongoJoinQueries">Joining relations</a></p>
</li>
<li>
<p><a href="#mongoCriteriaSpecifications">JPA Criteria API</a></p>
</li>
<li>
<p><a href="#mongoAttributeConverter">Attribute converters</a></p>
</li>
<li>
<p><a href="#mongoOptimisticLocking">Optimistic locking</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The interaction between the object layer and MongoDB&#8217;s driver serialization/deserialization is implemented using <a href="https://micronaut-projects.github.io/micronaut-serialization/1.0.x/guide">Micronaut Serialization</a> and BSON support.</p>
</div>

<h2 id="mongoQuickStart"><a class="anchor" href="#mongoQuickStart"></a>7.1 Quick Start</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoQuickStart.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The quickest way to get started is to create a new Micronaut application with <a href="https://micronaut.io/launch/">Micronaut Launch</a> and choose the <code>data-mongodb</code> or <code>data-mongodb-async</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also find a great guides on building Micronaut Data MongoDB applications including sample code in a variety of languages in the Micronaut Guides: <a href="https://guides.micronaut.io/latest/micronaut-data-mongodb-synchronous.html">Access a MongoDB Database with Micronaut Data MongoDB</a> and <a href="https://guides.micronaut.io/latest/micronaut-data-mongodb-asynchronous.html">Access a MongoDB Database Asynchronously with Micronaut Data MongoDB and Reactive Streams</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Clicking on one of the links in the table below will take you to <a href="https://micronaut.io/launch/">Micronaut Launch</a> with the appropriate options already pre-configured with your selected language and build tool:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Creating a MongoDB application with Micronaut Launch</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Gradle</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Maven</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Java</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb&amp;lang=JAVA&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb&amp;lang=JAVA&amp;build=MAVEN">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kotlin</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb&amp;lang=JAVA&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb&amp;lang=JAVA&amp;build=MAVEN">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Groovy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb&amp;lang=GROOVY&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb&amp;lang=GROOVY&amp;build=MAVEN">Open</a></p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Creating a reactive MongoDB application with Micronaut Launch</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Gradle</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Maven</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Java</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb-reactive&amp;lang=JAVA&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb-reactive&amp;lang=JAVA&amp;build=MAVEN">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kotlin</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb-reactive&amp;lang=JAVA&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb-reactive&amp;lang=JAVA&amp;build=MAVEN">Open</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Groovy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb-reactive&amp;lang=GROOVY&amp;build=GRADLE">Open</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micronaut.io/launch?features=data-mongodb-reactive&amp;lang=GROOVY&amp;build=MAVEN">Open</a></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Creating an application with the CLI</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># For Maven add: --build maven
$ mn create-app --lang java example --features data-mongodb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or via <code>curl</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating an application with <code>curl</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># For Maven add to the URL: &amp;build=maven
$ curl https://launch.micronaut.io/demo.zip?lang=java&amp;features=data-mongodb -o demo.zip &amp;&amp; unzip demo.zip -d demo &amp;&amp; cd demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pre-generated applications should have everything properly setup. You can follow the manual configuration instructions for proper understanding of the dependency setup.</p>
</div>
<div class="paragraph">
<p>To get started with Micronaut Data MongoDB add the following dependency to your annotation processor path:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">annotationProcessor(<span class="hljs-string">"io.micronaut.data:micronaut-data-document-processor")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;annotationProcessorPaths&gt;
    &lt;path&gt;
        &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
        &lt;artifactId&gt;micronaut-data-document-processor&lt;/artifactId&gt;
    &lt;/path&gt;
&lt;/annotationProcessorPaths&gt;</code></pre>
</div>
</div></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For Kotlin, add the <code>micronaut-data-document-processor</code> dependency in <a href="https://docs.micronaut.io/4.4.3/guide/#kaptOrKsp">kapt or ksp scope</a>, and for Groovy add <code>micronaut-data-document-processor</code> in compileOnly scope.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You should then configure a compile-scoped dependency on the <code>micronaut-data-mongodb</code> module:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-mongodb")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-mongodb&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>And include MongoDB Sync driver:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">runtimeOnly(<span class="hljs-string">"org.mongodb:mongodb-driver-sync")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
    &lt;artifactId&gt;mongodb-driver-sync&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>Or reactive MongoDB driver:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">runtimeOnly(<span class="hljs-string">"org.mongodb:mongodb-driver-reactivestreams")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
    &lt;artifactId&gt;mongodb-driver-reactivestreams&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s not possible to use both drivers at the same time. If you have both drivers on the classpath you can use property <code>micronaut.data.mongodb.driver-type</code> and value: <code>sync</code> or <code>reactive</code> to select proper driver.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next up you need to configure at least one data source. The following snippet from the application configuration file is an example of configuring the default MongoDB data source:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">mongodb.uri=mongodb://username:password@localhost:27017/databaseName</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mongodb:
  uri: mongodb://username:password@localhost:27017/databaseName</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[mongodb]
  uri="mongodb://username:password@localhost:27017/databaseName"</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">mongodb {
  uri = "mongodb://username:password@localhost:27017/databaseName"
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  mongodb {
    uri = "mongodb://username:password@localhost:27017/databaseName"
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "mongodb": {
    "uri": "mongodb://username:password@localhost:27017/databaseName"
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If entity classes are located outside the default package then packages containing entity classes need to be configured in MongoDB Configuration:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">mongodb.uri=mongodb://username:password@localhost:27017/databaseName
mongodb.package-names[0]=com.example.domain
mongodb.package-names[1]=com.example.other</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mongodb:
  uri: mongodb://username:password@localhost:27017/databaseName
  package-names:
    - com.example.domain
    - com.example.other</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[mongodb]
  uri="mongodb://username:password@localhost:27017/databaseName"
  package-names=[
    "com.example.domain",
    "com.example.other"
  ]</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">mongodb {
  uri = "mongodb://username:password@localhost:27017/databaseName"
  packageNames = ["com.example.domain", "com.example.other"]
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  mongodb {
    uri = "mongodb://username:password@localhost:27017/databaseName"
    package-names = ["com.example.domain", "com.example.other"]
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "mongodb": {
    "uri": "mongodb://username:password@localhost:27017/databaseName",
    "package-names": ["com.example.domain", "com.example.other"]
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To retrieve objects from the database you need to define a class annotated with <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity
public class Book {
    @Id
    @GeneratedValue
    private ObjectId id;
    private String title;
    private int pages;

    public Book(String title, int pages) {
        this.title = title;
        this.pages = pages;
    }
    // ...
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MappedEntity
class Book {
    @Id
    @GeneratedValue
    private ObjectId id
    private String title
    private int pages

    Book(String title, int pages) {
        this.title = title
        this.pages = pages
    }
    //...
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MappedEntity
data class Book(@field:Id
                @GeneratedValue
                var id: ObjectId,
                var title: String,
                var pages: Int = 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Followed by an interface that extends from <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a></p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.Id;
import io.micronaut.data.model.Page;
import io.micronaut.data.model.Pageable;
import io.micronaut.data.model.Slice;
import io.micronaut.data.mongodb.annotation.MongoAggregateQuery;
import io.micronaut.data.mongodb.annotation.MongoDeleteQuery;
import io.micronaut.data.mongodb.annotation.MongoFindQuery;
import io.micronaut.data.mongodb.annotation.MongoRepository;
import io.micronaut.data.mongodb.annotation.MongoUpdateQuery;
import io.micronaut.data.repository.CrudRepository;
import org.bson.types.ObjectId;

import java.util.List;


@MongoRepository // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, ObjectId&gt; { // <b class="conum">(2)</b>
    Book find(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.Id
import io.micronaut.data.model.Page
import io.micronaut.data.model.Pageable
import io.micronaut.data.model.Slice
import io.micronaut.data.mongodb.annotation.MongoAggregateQuery
import io.micronaut.data.mongodb.annotation.MongoDeleteQuery
import io.micronaut.data.mongodb.annotation.MongoFindQuery
import io.micronaut.data.mongodb.annotation.MongoRepository
import io.micronaut.data.mongodb.annotation.MongoUpdateQuery
import io.micronaut.data.repository.CrudRepository
import org.bson.types.ObjectId

@MongoRepository // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, ObjectId&gt; { // <b class="conum">(2)</b>
    Book find(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.context.annotation.Executable
import io.micronaut.data.annotation.Id
import io.micronaut.data.model.Page
import io.micronaut.data.model.Pageable
import io.micronaut.data.model.Slice
import io.micronaut.data.mongodb.annotation.*
import io.micronaut.data.repository.CrudRepository
import org.bson.types.ObjectId

@MongoRepository // <b class="conum">(1)</b>
interface BookRepository : CrudRepository&lt;Book, ObjectId&gt; { // <b class="conum">(2)</b>
    @Executable
    fun find(title: String): Book
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The interface is annotated with <a href="../api/io/micronaut/data/annotation/MongoRepository.html">@MongoRepository</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>CrudRepository</code> interface take 2 generic arguments, the entity type (in this case <code>Book</code>) and the ID type (in this case <code>ObjectId</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now perform CRUD (Create, Read, Update, Delete) operations on the entity. The implementation of <code>example.BookRepository</code> is created at compilation time. To obtain a reference to it simply inject the bean:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject BookRepository bookRepository;</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Inject @Shared BookRepository bookRepository</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Inject
lateinit var bookRepository: BookRepository</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_saving_an_instance_create">Saving an Instance (Create)</h3>
<div class="paragraph">
<p>To save an instance use the <code>save</code> method of the <code>CrudRepository</code> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book book = new Book("The Stand", 1000);
bookRepository.save(book);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Book book = new Book("The Stand", 1000)
bookRepository.save(book)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">var book = Book(ObjectId(),"The Stand", 1000)
bookRepository.save(book)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_an_instance_read">Retrieving an Instance (Read)</h3>
<div class="paragraph">
<p>To read a book back use <code>findById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">book = bookRepository.findById(id).orElse(null);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">book = bookRepository.findById(id).orElse(null)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">book = bookRepository.findById(id).orElse(null)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_an_instance_update">Updating an Instance (Update)</h3>
<div class="paragraph">
<p>With Micronaut Data MongoDB, you must manually implement an <code>update</code> method since the MongoDB implementation doesn&#8217;t include any dirty checking or persistence session notion. So you have to define explicit update methods for updates in your repository. For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void update(@Id ObjectId id, int pages);

void update(@Id ObjectId id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void update(@Id ObjectId id, int pages);

void update(@Id ObjectId id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun update(@Id id: ObjectId, pages: Int)

fun update(@Id id: ObjectId, title: String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which can then be called like so:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.update(book.getId(), "Changed");</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.update(book.getId(), "Changed")</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.update(book.id, "Changed")</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_an_instance_delete">Deleting an Instance (Delete)</h3>
<div class="paragraph">
<p>To delete an instance use <code>deleteById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.deleteById(id);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.deleteById(id)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.deleteById(id)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations you have implemented your first Micronaut Data MongoDB repository! Read on to find out more.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Micronaut Data MongoDB supports creating collections by setting property <code>micronaut.data.mongodb.create-collections</code> to <code>true</code>. MongoDB will create them automatically except for a few cases like transactional context, where collection needs to be already present.
</td>
</tr>
</table>
</div>
</div>

<h2 id="mongoRepositories"><a class="anchor" href="#mongoRepositories"></a>7.2 Repositories</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoRepositories.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As seen in the <a href="#mongoQuickStart">Quick Start</a> MongoDB repositories in Micronaut Data are defined as interfaces that are annotated with the <a href="../api/io/micronaut/data/mongodb/annotation/MongoRepository.html">@MongoRepository</a>.</p>
</div>
<div class="paragraph">
<p>In multiple servers scenario, the <code>serverName</code> annotation property can be used to specify the datasource configuration to use. By default, Micronaut Data will look for the default server.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoRepository(serverName = "inventoryServer") <i class="conum" data-value="1"></i><b>(1)</b>
public interface PhoneRepository extends CrudRepository&lt;Phone, Integer&gt; {
    Optional&lt;Phone&gt; findByAssetId(@NotNull Integer assetId);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>@MongoRepository marking the interface to access MongoDB and pointing to the server configuration 'inventoryServer'</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The entity to treat as the root entity for the purposes of querying is established either from the method signature or from the generic type parameter specified to the <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> interface.</p>
</div>
<div class="paragraph">
<p>If no root entity can be established then a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>The same interfaces supported by the JPA implementation are supported by MongoDB.</p>
</div>
<div class="paragraph">
<p>Note that in addition to interfaces you can also define repositories as abstract classes:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.mongodb.annotation.MongoRepository;
import io.micronaut.data.repository.CrudRepository;
import org.bson.types.ObjectId;

import java.util.List;

@MongoRepository
public abstract class AbstractBookRepository implements CrudRepository&lt;Book, ObjectId&gt; {

    public abstract List&lt;Book&gt; findByTitle(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.mongodb.annotation.MongoRepository
import io.micronaut.data.repository.CrudRepository
import org.bson.types.ObjectId

@MongoRepository
abstract class AbstractBookRepository implements CrudRepository&lt;Book, ObjectId&gt; {

    abstract List&lt;Book&gt; findByTitle(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.mongodb.annotation.MongoRepository
import io.micronaut.data.repository.CrudRepository
import org.bson.types.ObjectId

@MongoRepository
abstract class AbstractBookRepository : CrudRepository&lt;Book, ObjectId&gt; {

    abstract fun findByTitle(title: String): List&lt;Book&gt;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can specify MongoDB&#8217;s database name using the repository annotation: <code>@MongoRepository(databaseName = "mydb")</code> or in the connection url: <code>mongodb://username:password@localhost:27017/mydb</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Micronaut Data MongoDB introduces one special repository interface <a href="../api/io/micronaut/data/mongodb/repository/MongoQueryExecutor.html">MongoQueryExecutor</a> (and corresponding reactive interface <a href="../api/io/micronaut/data/mongodb/repository/MongoReactiveQueryExecutor.html">MongoReactiveQueryExecutor</a>) which accepts <code>Bson</code>/<code>List&lt;Bson&gt;</code> filter/pipeline/update parameters intended to be used in combination with MongoDB DSL API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.mongodb.client.model.Filters</code></p>
</li>
<li>
<p><code>com.mongodb.client.model.Aggregates</code></p>
</li>
<li>
<p><code>com.mongodb.client.model.Updates</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specific criteria supported by Micronaut Data MongoDB that allows to filter documents by checking occurrences in list or array of strings in given field can be achieved using <code>ArrayContains</code> or <code>CollectionContains</code> criteria. Here is an example of repository method declaration which will search people which interests field (list of strings) contains given value(s):</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Person&gt; findByInterestsCollectionContains(String interest);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">List&lt;Person&gt; findByInterestsCollectionContains(String interest)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findByInterestsCollectionContains(interest: String): List&lt;Person&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Micronaut Data MongoDB supports array or list containment check for single or multiple values using <code>ArrayContains</code> or <code>CollectionContains</code> criteria.</p>
</div>

<h2 id="mongoInsertsAndUpdates"><a class="anchor" href="#mongoInsertsAndUpdates"></a>7.2.1 Accessing data</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoRepositories/mongoInsertsAndUpdates.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Unlike JPA/Hibernate, Micronaut Data MongoDB is stateless and has no notion of a persistence session that requires state management.</p>
</div>
<div class="paragraph">
<p>Since there is no session, features like dirty checking are not supported. This has implications when defining repository methods for inserts and updates.</p>
</div>
<div class="paragraph">
<p>By default, when saving an entity with a method like <code>save(MyEntity)</code> an insert is always performed since Micronaut Data has no way to know whether the entity is associated to a particular session.</p>
</div>
<div class="paragraph">
<p>If you wish to update an entity you should instead either use <code>update(MyEntity)</code> or even better define an appropriate <code>update</code> method to update only the data you want to update, for example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void update(@Id ObjectId id, int pages);

void update(@Id ObjectId id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void update(@Id ObjectId id, int pages);

void update(@Id ObjectId id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun update(@Id id: ObjectId, pages: Int)

fun update(@Id id: ObjectId, title: String)</code></pre>
</div>
</div>

<h2 id="mongoCustomQueries"><a class="anchor" href="#mongoCustomQueries"></a>7.2.2 Custom Queries and Options</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoRepositories/mongoCustomQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data MongoDB introduces a few annotations that can be used to define custom queries and modify default options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Micronaut Data MongoDB annotations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Annotation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoFindQuery.html">@MongoFindQuery</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows defining a custom find method execution with values for filtering, sorting, projection and collation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoAggregateQuery.html">@MongoAggregateQuery</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows defining a custom aggregate method execution with a value for the pipeline.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoUpdateQuery.html">@MongoUpdateQuery</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows defining a custom update method execution with values for filter, update and collation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoDeleteQuery.html">@MongoDeleteQuery</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows defining a custom update method execution with values for filter and collation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoFilter.html">@MongoFilter</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows defining a custom filter value for operations that support it. Can be used on annotation to create a predefined filter annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoSort.html">@MongoSort</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows defining a custom sort value for operations that support it. Can be used on repository class to define a default sort or to create a predefined sort annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoProjection.html">@MongoProjection</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows defining a custom projection value for operations that support it. Can be used on repository class to define a default projection or to create a predefined projection annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoCollation.html">@MongoCollation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows defining a custom collation value for operations that support it. Can be used on repository class to define a default collation or to create a predefined collation annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoAggregateOptions.html">@MongoAggregateOptions</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The aggregation operation options.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoFindOptions.html">@MongoFindOptions</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The find operation options.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoUpdateOptions.html">@MongoUpdateOptions</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The update operation options.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/mongodb/annotation/MongoDeleteOptions.html">@MongoDeleteOptions</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The delete operation options.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Custom queries for MongoDB are defined in JSON and method parameters can be references as a variable prefixed with <code>:</code>.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoFindQuery(filter = "{title:{$regex: :t}}", sort = "{title: 1}")
List&lt;Book&gt; customFind(String t);

@MongoAggregateQuery("[{$match: {name:{$regex: :t}}}, {$sort: {name: 1}}, {$project: {name: 1}}]")
List&lt;Person&gt; customAggregate(String t);

@MongoUpdateQuery(filter = "{title:{$regex: :t}}", update = "{$set:{name: 'tom'}}")
void customUpdate(String t);

@MongoDeleteQuery(filter = "{title:{$regex: :t}}", collation = "{locale:'en_US', numericOrdering:true}")
void customDelete(String t);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MongoFindQuery(filter = '{title:{$regex: :t}}', sort = '{title: 1}')
List&lt;Book&gt; customFind(String t);

@MongoAggregateQuery('[{$match: {name:{$regex: :t}}}, {$sort: {name: 1}}, {$project: {name: 1}}]')
List&lt;Person&gt; customAggregate(String t)

@MongoUpdateQuery(filter = '{title:{$regex: :t}}', update = '{$set:{name: "tom"}}')
void customUpdate(String t);

@MongoDeleteQuery(filter = '{title:{$regex: :t}}', collation = "{locale:'en_US', numericOrdering:true}")
void customDelete(String t);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MongoFindQuery(filter = "{title:{\$regex: :t}}", sort = "{title: 1}")
fun customFind(t: String): List&lt;Book&gt;

@MongoAggregateQuery("[{\$match: {name:{\$regex: :t}}}, {\$sort: {name: 1}}, {\$project: {name: 1}}]")
fun customAggregate(t: String): List&lt;Person&gt;

@MongoUpdateQuery(filter = "{title:{\$regex: :t}}", update = "{\$set:{name: 'tom'}}")
fun customUpdate(t: String)

@MongoDeleteQuery(filter = "{title:{\$regex: :t}}", collation = "{locale:'en_US', numericOrdering:true}")
fun customDelete(t: String)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only queries for the filter, pipeline and the update can reference method parameters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some annotations support to be defined on the repository, that can be used to provide the defaults for all operations that support it:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoFindOptions(allowDiskUse = true, maxTimeMS = 1000)
@MongoAggregateOptions(allowDiskUse = true, maxTimeMS = 100)
@MongoCollation("{ locale: 'en_US', numericOrdering: true}")
@MongoRepository
public interface SaleRepository extends CrudRepository&lt;Sale, ObjectId&gt; {</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MongoFindOptions(allowDiskUse = true, maxTimeMS = 1000L)
@MongoAggregateOptions(allowDiskUse = true, maxTimeMS = 100L)
@MongoCollation("{ locale: 'en_US', numericOrdering: true}")
@MongoRepository
interface SaleRepository extends CrudRepository&lt;Sale, ObjectId&gt; {</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MongoFindOptions(allowDiskUse = true, maxTimeMS = 1000)
@MongoAggregateOptions(allowDiskUse = true, maxTimeMS = 100)
@MongoCollation("{ locale: 'en_US', numericOrdering: true}")
@MongoRepository
interface SaleRepository : CrudRepository&lt;Sale, ObjectId&gt; {</code></pre>
</div>
</div>

<h2 id="mongoMapping"><a class="anchor" href="#mongoMapping"></a>7.3 Mapping Entities</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoMapping.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As mentioned in the <a href="#mongoQuickStart">Quick Start</a> section, if you need to customize how entities map to the collection and attribute names of the collection you need use Micronaut Data&#8217;s own annotations in the <code>io.micronaut.data.annotation</code> package.</p>
</div>
<div class="paragraph">
<p>An important aspect of Micronaut Data MongoDB is that the entity classes must be compiled with Micronaut Data. This is because Micronaut Data pre-computes the persistence model (the relationships between entities, the class/property name to collection/attribute name mappings) at compilation time, which is one of the reasons Micronaut Data MongoDB can start up so fast.</p>
</div>
<div class="paragraph">
<p>An example of mapping with Micronaut Data annotations can be seen below:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Micronaut Data Annotation Mapping Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity // <b class="conum">(1)</b>
public class Country {

    @Id
    private ObjectId id; // <b class="conum">(2)</b>

    @Relation(value = Relation.Kind.ONE_TO_MANY, mappedBy = "country")
    private Set&lt;CountryRegion&gt; regions; // <b class="conum">(3)</b>

    private String name; // <b class="conum">(4)</b>

    // ...
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Micronaut Data Annotation Mapping Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MappedEntity // <b class="conum">(1)</b>
class Country {

    @Id
    private ObjectId id // <b class="conum">(2)</b>

    @Relation(value = Relation.Kind.ONE_TO_MANY, mappedBy = "country")
    private Set&lt;CountryRegion&gt; regions // <b class="conum">(3)</b>

    private String name // <b class="conum">(4)</b>

    // ...
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Micronaut Data Annotation Mapping Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MappedEntity // <b class="conum">(1)</b>
data class Country(
        @field:Id
        val id: ObjectId, // <b class="conum">(2)</b>
        @Relation(value = Relation.Kind.ONE_TO_MANY, mappedBy = "country")
        val regions: Set&lt;CountryRegion&gt;, // <b class="conum">(3)</b>
        val name: String // <b class="conum">(4)</b>
        )</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is marked as a mapped entity that should be persisted in the <code>country</code> collection</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The id is defined as MongoDB&#8217;s <code>ObjectId</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>regions</code> are stored in a separate collection represented by <code>CountryRegion</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>name</code> field that should be persisted in a collection</td>
</tr>
</table>
</div>

<h2 id="mongoAnnotations"><a class="anchor" href="#mongoAnnotations"></a>7.3.1 Mapping Annotations</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoMapping/mongoAnnotations.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The following table summarizes the different annotations and what they enable. If you are familiar with and prefer the JPA annotations then feel free to skip to the next section:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Micronaut Data Annotations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Annotation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/AutoPopulated.html">@AutoPopulated</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Meta annotation for a value that should be auto-populated by Micronaut Data (such as time stamps and UUIDs)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/DateCreated.html">@DateCreated</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows assigning a data created value (such as a <code>java.time.Instant</code>) prior to an insert</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/DateUpdated.html">@DateUpdated</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows assigning a last updated value (such as a <code>java.time.Instant</code>) prior to an insert</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Embeddable.html">@Embeddable</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies that the bean is embeddable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/EmbeddedId.html">@EmbeddedId</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies an embedded ID of an entity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/GeneratedValue.html">@GeneratedValue</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies that the property value is generated by the database and not included in inserts</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/JoinTable.html">@JoinTable</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a join collection association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/JoinColumn.html">@JoinColumn</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a join attribute mapping</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Id.html">@Id</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the ID of an entity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the entity is mapped to the collection. If your collection name differs from the entity name, pass the name as the <code>value</code>. For example: <code>@MappedEntity( value = "my_collection" )</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/MappedProperty.html">@MappedProperty</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to customize the attribute name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Relation.html">@Relation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to specify a relationship (one-to-one, one-to-many, etc.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Transient.html">@Transient</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to specify a property is transient</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/annotation/Version.html">@Version</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the version field of an entity, enables optimistic locking</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Again Micronaut Data MongoDB is not an ORM, but instead a simple data mapper so many of the concepts in JPA simply don&#8217;t apply, however for users familiar with these annotations it is handy being able to use them.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Micronaut Data MongoDB doesn&#8217;t support JPA annotations
</td>
</tr>
</table>
</div>

<h2 id="mongoIdGenerator"><a class="anchor" href="#mongoIdGenerator"></a>7.3.2 ID Generation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoMapping/mongoIdGenerator.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The default ID generation for MongoDB is using <code>ObjectId</code> as an ID, there are only two supported types: the default <code>ObjectId</code> and a simple Java String which will have the hex value of the <code>ObjectId</code>.</p>
</div>
<div class="paragraph">
<p>You can remove the <code>@GeneratedValue</code> annotation and in this case the expectation is that you will assign an ID before calling <code>save()</code>.</p>
</div>
<div class="paragraph">
<p>Automatically assigned UUIDs are also supported by adding a property annotated with <code>@Id</code> and <code>@AutoPopulated</code>.</p>
</div>

<h2 id="mongoCompositeId"><a class="anchor" href="#mongoCompositeId"></a>7.3.3 Composite Primary Keys</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoMapping/mongoCompositeId.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Composite primary keys can be defined using <a href="../api/io/micronaut/data/annotation/EmbeddedId.html">@EmbeddedId</a> annotation. A composite ID requires an additional class to represent the key. The class should define fields that correspond to the collection&#8217;s attribute making up the composite key. For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.Embeddable;

import java.util.Objects;

@Embeddable
public class ProjectId {
    private final int departmentId;
    private final int projectId;

    public ProjectId(int departmentId, int projectId) {
        this.departmentId = departmentId;
        this.projectId = projectId;
    }

    public int getDepartmentId() {
        return departmentId;
    }

    public int getProjectId() {
        return projectId;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        }
        if (o == null || getClass() != o.getClass()) {
            return false;
        }
        ProjectId projectId1 = (ProjectId) o;
        return departmentId == projectId1.departmentId &amp;&amp;
                projectId == projectId1.projectId;
    }

    @Override
    public int hashCode() {
        return Objects.hash(departmentId, projectId);
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.EqualsAndHashCode
import io.micronaut.data.annotation.Embeddable

@EqualsAndHashCode
@Embeddable
class ProjectId {
    final int departmentId
    final int projectId

    ProjectId(int departmentId, int projectId) {
        this.departmentId = departmentId
        this.projectId = projectId
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.Embeddable

@Embeddable
data class ProjectId(val departmentId: Int, val projectId: Int)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is recommended that the ID class be immutable and implement <code>equals</code>/<code>hashCode</code>.
TIP: When using Java, be sure to define getters for the fields making up your composite key.
</td>
</tr>
</table>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.EmbeddedId;
import io.micronaut.data.annotation.MappedEntity;

@MappedEntity
public class Project {
    @EmbeddedId
    private ProjectId projectId;
    private String name;

    public Project(ProjectId projectId, String name) {
        this.projectId = projectId;
        this.name = name;
    }

    public ProjectId getProjectId() {
        return projectId;
    }

    public String getName() {
        return name;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.EmbeddedId
import io.micronaut.data.annotation.MappedEntity

@MappedEntity
class Project {
    @EmbeddedId
    private ProjectId projectId
    private String name

    Project(ProjectId projectId, String name) {
        this.projectId = projectId
        this.name = name
    }

    ProjectId getProjectId() {
        return projectId
    }

    String getName() {
        return name
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.EmbeddedId
import io.micronaut.data.annotation.MappedEntity

@MappedEntity
class Project(@EmbeddedId val projectId: ProjectId, val name: String)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To alter the collection&#8217;s attribute mappings for the ID, you may use the <a href="../api/io/micronaut/data/annotation/MappedProperty.html">@MappedProperty</a> annotation on the fields within the <code>ProjectId</code> class
</td>
</tr>
</table>
</div>

<h2 id="mongoConstructorArguments"><a class="anchor" href="#mongoConstructorArguments"></a>7.3.4 Constructor Arguments</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoMapping/mongoConstructorArguments.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data MongoDB also allows the definition of immutable objects using constructor arguments instead of getters/setters. If you define multiple constructors then the one used to create the object from the database should be annotated with <code>io.micronaut.core.annotation.Creator</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.Creator;
import io.micronaut.data.annotation.GeneratedValue;
import io.micronaut.data.annotation.Id;
import io.micronaut.data.annotation.MappedEntity;
import org.bson.types.ObjectId;

@MappedEntity
public class Manufacturer {
    @Id
    @GeneratedValue
    private ObjectId id;
    private String name;

    @Creator
    public Manufacturer(String name) {
        this.name = name;
    }

    public ObjectId getId() {
        return id;
    }

    public void setId(ObjectId id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.Creator
import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity

@MappedEntity
class Manufacturer {
    @Id
    @GeneratedValue
    Long id
    final String name

    @Creator
    Manufacturer(String name) {
        this.name = name
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import org.bson.types.ObjectId

@MappedEntity
data class Manufacturer(
        @field:Id
        @GeneratedValue
        var id: ObjectId?,
        val name: String
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the example above, the <code>ID</code> of the object should however include a setter since this has to be assigned from the database generated value.</p>
</div>

<h2 id="mongoNaming"><a class="anchor" href="#mongoNaming"></a>7.3.5 Naming Strategies</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoMapping/mongoNaming.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The default naming strategy when converting camel case class and property names to collection and attribute names is to use underscore separated lower case. In other words <code>FooBar</code> becomes <code>foo_bar</code>.</p>
</div>
<div class="paragraph">
<p>If this is not satisfactory then you can customize this by setting the <code>namingStrategy</code> member of the <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a> annotation on the entity:</p>
</div>
<div class="listingblock">
<div class="title">Micronaut Data Naming Strategy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity(namingStrategy = NamingStrategies.Raw.class)
public class CountryRegion {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Few important things to note. Since Micronaut Data pre-computes the collection and attribute name mappings at compilation time the specified <a href="../api/io/micronaut/data/model/naming/NamingStrategy.html">NamingStrategy</a> implementation must be on the annotation processor classpath (<code>annotationProcessor</code> scope for Java or <code>kapt</code> for Kotlin).</p>
</div>
<div class="paragraph">
<p>In addition, if you don&#8217;t want to repeat the above annotation definition on every entity it is handy to define a meta-annotation where the above annotation definition is applied to another annotation that you add to your class.</p>
</div>

<h2 id="mongoAssociationMapping"><a class="anchor" href="#mongoAssociationMapping"></a>7.3.6 Association Mapping</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoMapping/mongoAssociationMapping.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To specify a relation between two entities you need to use <a href="../api/io/micronaut/data/annotation/Relation.html">@Relation</a> annotation. The relation kind is specified using enum <a href="../api/io/micronaut/data/annotation/Relation.Kind.html">@Kind</a> <code>value</code> attribute which is similar to JPA relations annotation names (<code>@OneToMany</code>, <code>@OneToOne</code> etc.)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Micronaut Data supported relations:</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Kind</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.ONE_TO_MANY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One-To-Many association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.ONE_TO_ONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One-To-One association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.MANY_TO_MANY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Many-To-Many association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.MANY_TO_ONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Many-To-One association</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kind.EMBEDDED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedded association</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Use 'mappedBy' to specify inverse property that this relation is mapped by.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Micronaut Data supported association cascade types:</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cascade.PERSIST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associated entity or entities are going to be persisted when owning entity is saved</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cascade.UPDATE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associated entity or entities are going to be updated when owning entity is updated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cascade.NONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Default) No operation is cascaded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cascade.ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All (<code>Cascade.PERSIST</code> and <code>Cascade.UPDATE</code>) operations are cascaded</p></td>
</tr>
</tbody>
</table>

<h2 id="mongoAssociationFetching"><a class="anchor" href="#mongoAssociationFetching"></a>7.3.7 Association Fetching</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoMapping/mongoAssociationFetching.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data is a simple data mapper, hence it will not fetch any associations for you using techniques like lazy loading of entity proxies for single-ended associations.</p>
</div>
<div class="paragraph">
<p>You must instead specify ahead of time what data you want to fetch. You cannot map an association as being eager or lazy. The reason for this design choice is simple, even in the JPA world accessing lazy associations or lazy initialization collections is considered bad practice due to the N+1 query issue and the recommendation is always to write an optimized join query.</p>
</div>
<div class="paragraph">
<p>Micronaut Data MongoDB takes this a step further by simply not supporting those features considered bad practice anyway. However, it does impact how you may model an association. For example, if you define an association in a constructor argument such as the following entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.Nullable;
import io.micronaut.data.annotation.GeneratedValue;
import io.micronaut.data.annotation.Id;
import io.micronaut.data.annotation.MappedEntity;
import io.micronaut.data.annotation.Relation;
import org.bson.types.ObjectId;

@MappedEntity
public class Product {

    @Id
    @GeneratedValue
    private ObjectId id;
    private String name;
    @Nullable
    @Relation(Relation.Kind.MANY_TO_ONE)
    private Manufacturer manufacturer;

    public Product(String name, @Nullable Manufacturer manufacturer) {
        this.name = name;
        this.manufacturer = manufacturer;
    }

    public ObjectId getId() {
        return id;
    }

    public void setId(ObjectId id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public Manufacturer getManufacturer() {
        return manufacturer;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.Nullable
import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import io.micronaut.data.annotation.Relation
import org.bson.types.ObjectId

@MappedEntity
class Product {
    @Id
    @GeneratedValue
    ObjectId id
    private String name
    @Nullable
    @Relation(Relation.Kind.MANY_TO_ONE)
    private Manufacturer manufacturer

    Product(String name, Manufacturer manufacturer) {
        this.name = name
        this.manufacturer = manufacturer
    }

    String getName() {
        return name
    }

    Manufacturer getManufacturer() {
        return manufacturer
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import io.micronaut.data.annotation.Relation
import org.bson.types.ObjectId

@MappedEntity
data class Product(@field:Id @GeneratedValue
                   var id: ObjectId?,
                   var name: String,
                   @Relation(Relation.Kind.MANY_TO_ONE)
                   var manufacturer: Manufacturer?) {

    constructor(name: String, manufacturer: Manufacturer?) : this(null, name, manufacturer)

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then attempt to read the <code>Product</code> entity back without specifying a join an exception will occur since the <code>manufacturer</code> association is not <code>Nullable</code>.</p>
</div>
<div class="paragraph">
<p>There are few ways around this, one way is to declare at the repository level to always fetch <code>manufacturer</code>, another is declared the <code>@Nullable</code> annotation on the <code>manufacturer</code> argument to allow it to be declared <code>null</code> (or in Kotlin add <code>?</code> to the end of the constructor argument name). Which approach you choose is dependent on the design of the application.</p>
</div>
<div class="paragraph">
<p>The following section provides more coverage on handling joins.</p>
</div>

<h2 id="mongoJoinQueries"><a class="anchor" href="#mongoJoinQueries"></a>7.4 Join Queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoJoinQueries.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As discussed in the previous section, Micronaut Data MongoDB doesn&#8217;t support associations in the traditional ORM sense. There is no lazy loading or support for proxies.</p>
</div>
<div class="paragraph">
<p>Consider a <code>Product</code> entity from the previous section that has an association to a <code>Manufacturer</code> entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.Creator;
import io.micronaut.data.annotation.GeneratedValue;
import io.micronaut.data.annotation.Id;
import io.micronaut.data.annotation.MappedEntity;
import org.bson.types.ObjectId;

@MappedEntity
public class Manufacturer {
    @Id
    @GeneratedValue
    private ObjectId id;
    private String name;

    @Creator
    public Manufacturer(String name) {
        this.name = name;
    }

    public ObjectId getId() {
        return id;
    }

    public void setId(ObjectId id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.core.annotation.Creator
import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity

@MappedEntity
class Manufacturer {
    @Id
    @GeneratedValue
    Long id
    final String name

    @Creator
    Manufacturer(String name) {
        this.name = name
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import org.bson.types.ObjectId

@MappedEntity
data class Manufacturer(
        @field:Id
        @GeneratedValue
        var id: ObjectId?,
        val name: String
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Say you query for <code>Product</code> instances, what happens is that by default Micronaut Data MongoDB will only query for and fetch the simple properties. In the case of single ended associations like the above Micronaut Data will only retrieve the ID and assign it if is possible (In the case of entities that require constructor arguments this is not even possible).</p>
</div>
<div class="paragraph">
<p>If you need to fetch the association too then you can use the <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation on your repository interface to specify that the aggregation should be executed to with a lookup of the associated <code>Manufacturer</code>.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoRepository
public interface ProductRepository extends CrudRepository&lt;Product, ObjectId&gt; {
    @Join("manufacturer") // <b class="conum">(1)</b>
    List&lt;Product&gt; list();
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MongoRepository
public interface ProductRepository extends CrudRepository&lt;Product, ObjectId&gt; {
    @Join("manufacturer") // <b class="conum">(1)</b>
    List&lt;Product&gt; list();
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MongoRepository
interface ProductRepository : CrudRepository&lt;Product, ObjectId&gt;, JpaSpecificationExecutor&lt;Product&gt; {
    @Join("manufacturer") // <b class="conum">(1)</b>
    fun list(): List&lt;Product&gt;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List query should include joined relation <code>manufacturer</code> from a different collection</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Micronaut Data MongoDB will generate the following aggregation JSON query at the compile-time and only bind the required parameters and the runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
   {
      "$lookup":{
         "from":"cart_item",
         "localField":"_id",
         "foreignField":"cart._id",
         "as":"items"
      }
   },
   {
      "$match":{
         "_id":{
            "$eq":{
               "$oid":"61d69d67e8cb2c06b66d2e67"
            }
         }
      }
   }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a> annotation is repeatable and hence can be specified multiple time for different associations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Micronaut Data MongoDB doesn&#8217;t support different join types or a custom alias defined in <a href="../api/io/micronaut/data/annotation/Join.html">@Join</a>.
</td>
</tr>
</table>
</div>

<h2 id="mongoAttributeConverter"><a class="anchor" href="#mongoAttributeConverter"></a>7.5 Using Attribute Converter</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoAttributeConverter.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>There are cases where you would like to represent the attribute differently in the database than in the entity.</p>
</div>
<div class="paragraph">
<p>Consider the following example entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.GeneratedValue;
import io.micronaut.data.annotation.Id;
import io.micronaut.data.annotation.MappedEntity;
import io.micronaut.data.annotation.MappedProperty;
import io.micronaut.data.annotation.Relation;
import org.bson.types.ObjectId;

@MappedEntity
public class Sale {

    @Relation(Relation.Kind.MANY_TO_ONE)
    private final Product product;
    @MappedProperty(converter = QuantityAttributeConverter.class)
    private final Quantity quantity;

    @Id
    @GeneratedValue
    private ObjectId id;

    public Sale(Product product, Quantity quantity) {
        this.product = product;
        this.quantity = quantity;
    }

    public Product getProduct() {
        return product;
    }

    public Quantity getQuantity() {
        return quantity;
    }

    public ObjectId getId() {
        return id;
    }

    public void setId(ObjectId id) {
        this.id = id;
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import io.micronaut.data.annotation.Relation
import org.bson.types.ObjectId

@MappedEntity
class Sale {
    @Id
    @GeneratedValue
    ObjectId id
    @Relation(Relation.Kind.MANY_TO_ONE)
    final Product product
    final Quantity quantity

    Sale(Product product, Quantity quantity) {
        this.product = product
        this.quantity = quantity
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.*
import org.bson.types.ObjectId

@MappedEntity
data class Sale(
    @field:Id
    @GeneratedValue
    var id: ObjectId?,
    @Relation(Relation.Kind.MANY_TO_ONE)
    val product: Product,
    @MappedProperty(converter = QuantityAttributeConverter::class)
    val quantity: Quantity
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Sale</code> class has a reference to a type <code>Quantity</code>. The <code>Quantity</code> type is defined as:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

public class Quantity {

    private final int amount;

    private Quantity(int amount) {
        this.amount = amount;
    }

    public int getAmount() {
        return amount;
    }

    public static Quantity valueOf(int amount) {
        return new Quantity(amount);
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.Immutable

@Immutable
class Quantity {
    int amount
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

data class Quantity(val amount: Int)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see <code>@MappedProperty(converter = QuantityAttributeConverter.class)</code> is used to define the <code>Quantity</code> converter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Micronaut Data MongoDB doesn&#8217;t support defining the converter using <code>@TypeDef</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The last step is to add custom attribute conversion so that Micronaut Data knows how to read and write the type from an <code>Integer</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.convert.ConversionContext;
import io.micronaut.data.model.runtime.convert.AttributeConverter;
import jakarta.inject.Singleton;

@Singleton // <b class="conum">(1)</b>
public class QuantityAttributeConverter implements AttributeConverter&lt;Quantity, Integer&gt; {

    @Override // <b class="conum">(2)</b>
    public Integer convertToPersistedValue(Quantity quantity, ConversionContext context) {
        return quantity == null ? null : quantity.getAmount();
    }

    @Override // <b class="conum">(3)</b>
    public Quantity convertToEntityValue(Integer value, ConversionContext context) {
        return value == null ? null : Quantity.valueOf(value);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.CompileStatic
import io.micronaut.core.convert.ConversionContext
import io.micronaut.data.model.runtime.convert.AttributeConverter
import jakarta.inject.Singleton

@Singleton // <b class="conum">(1)</b>
@CompileStatic
class QuantityAttributeConverter implements AttributeConverter&lt;Quantity, Integer&gt; {

    @Override // <b class="conum">(2)</b>
    Integer convertToPersistedValue(Quantity quantity, ConversionContext context) {
        return quantity == null ? null : quantity.getAmount()
    }

    @Override // <b class="conum">(3)</b>
    Quantity convertToEntityValue(Integer value, ConversionContext context) {
        return value == null ? null : new Quantity(value)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.core.convert.ConversionContext
import io.micronaut.data.model.runtime.convert.AttributeConverter
import jakarta.inject.Singleton

@Singleton // <b class="conum">(1)</b>
class QuantityAttributeConverter : AttributeConverter&lt;Quantity?, Int?&gt; {

    // <b class="conum">(2)</b>
    override fun convertToPersistedValue(quantity: Quantity?, context: ConversionContext): Int? {
        return quantity?.amount
    }

    // <b class="conum">(3)</b>
    override fun convertToEntityValue(value: Int?, context: ConversionContext): Quantity? {
        return if (value == null) null else Quantity(value)
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The attribute converter implements <a href="../api/io/micronaut/data/model/runtime/convert/AttributeConverter.html">@AttributeConverter</a> and must be a bean</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A converter from <code>Quantity</code> to <code>Integer</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A converter from <code>Integer</code> to <code>Quantity</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s possible to define the converter result type using <a href="../api/io/micronaut/data/annotation/MappedProperty.html">@MappedProperty</a>: <code>@MappedProperty(converterPersistedType = Integer.class)</code>, in this case the data type will be detected automatically.
</td>
</tr>
</table>
</div>

<h2 id="mongoCriteriaSpecifications"><a class="anchor" href="#mongoCriteriaSpecifications"></a>7.6 Repositories with Criteria API</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoCriteriaSpecifications.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In some cases, you need to build a query programmatically and at the runtime; for that, Micronaut Data implements a subset of Jakarta Persistence Criteria API 3.0, which can be used for Micronaut Data MongoDB features. To utilize this feature add the following dependency:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"jakarta.persistence:jakarta.persistence-api")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;jakarta.persistence&lt;/groupId&gt;
    &lt;artifactId&gt;jakarta.persistence-api&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>To implement queries that cannot be defined at the compile-time Micronaut Data introduces <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> repository interface that can be used to extend your repository interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoRepository
public interface PersonRepository extends CrudRepository&lt;Person, ObjectId&gt;, JpaSpecificationExecutor&lt;Person&gt; {
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MongoRepository
interface PersonRepository extends CrudRepository&lt;Person, ObjectId&gt;, JpaSpecificationExecutor&lt;Person&gt; {
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MongoRepository
interface PersonRepository : CrudRepository&lt;Person, ObjectId&gt;, JpaSpecificationExecutor&lt;Person&gt; {
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each method expects a "specification" which is a functional interface with a set of Criteria API objects intended to build a query programmatically.</p>
</div>
<div class="paragraph">
<p>Micronaut Criteria API currently implements only a subset of the API. Most of it is internally used to create queries with predicates and projections.</p>
</div>
<div class="paragraph">
<p>Currently, not supported JPA Criteria API features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Joins with custom <code>ON</code> expressions and typed join methods like <code>joinSet</code> etc</p>
</li>
<li>
<p>Sub-queries</p>
</li>
<li>
<p>Collection operations: <code>isMember</code> etc</p>
</li>
<li>
<p>Custom or tuple result type</p>
</li>
<li>
<p>Transformation expressions like concat, substring etc.</p>
</li>
<li>
<p>Cases and functions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More information about Jakarta Persistence Criteria API 3.0 you can find at the <a href="https://jakarta.ee/specifications/persistence/3.0/jakarta-persistence-spec-3.0.html#a6925">official API specification</a></p>
</div>

<h2 id="mongoCriteriaExecuteQuery"><a class="anchor" href="#mongoCriteriaExecuteQuery"></a>7.6.1 Querying</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoCriteriaSpecifications/mongoCriteriaExecuteQuery.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To find an entity or multiple entities you can use one of the following methods from <a href="../api/io/micronaut/data/jpa/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
Optional&lt;Person&gt; findOne(PredicateSpecification&lt;Person&gt; spec);

@Override
Optional&lt;Person&gt; findOne(QuerySpecification&lt;Person&gt; spec);

@Override
List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec);

@Override
List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec);

@Override
List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Sort sort);

@Override
List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Sort sort);

@Override
Page&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Pageable pageable);

@Override
Page&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Pageable pageable);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Optional&lt;Person&gt; findOne(PredicateSpecification&lt;Person&gt; spec)

Optional&lt;Person&gt; findOne(QuerySpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Sort sort)

List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Sort sort)

Page&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Pageable pageable)

Page&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Pageable pageable)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findOne(spec: PredicateSpecification&lt;Person&gt;?): Optional&lt;Person&gt;

fun findOne(spec: QuerySpecification&lt;Person&gt;?): Optional&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?): List&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?): List&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?, sort: Sort): List&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?, sort: Sort): List&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?, pageable: Pageable): Page&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?, pageable: Pageable): Page&lt;Person&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there are two variations of <code>findOne</code>/<code>findAll</code> methods.</p>
</div>
<div class="paragraph">
<p>First method is expecting <a href="../api/io/micronaut/data/repository/criteria/PredicateSpecification.html">PredicateSpecification</a> which is a simple specification interface that can be implemented to return a predicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface PredicateSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="3"></i><b>(3)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This interface can also be used for update and delete methods, and it provides <code>or</code> and <code>and</code> methods for combining multiple predicates.</p>
</div>
<div class="paragraph">
<p>The second interface is intended only for query criteria because it includes <code>jakarta.persistence.criteria.CriteriaQuery</code> as a parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface QuerySpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaQuery&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria query instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For implementing counting queries following methods can be used:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
long count(PredicateSpecification&lt;Person&gt; spec);

@Override
long count(QuerySpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long count(PredicateSpecification&lt;Person&gt; spec)

long count(QuerySpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun count(spec: PredicateSpecification&lt;Person&gt;?): Long

fun count(spec: QuerySpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define criteria specification methods that will help you to create a query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {
    fun nameEquals(name: String?) = where&lt;Person&gt; { root[Person::name] eq name }

    fun ageIsLessThan(age: Int) = where&lt;Person&gt; { root[Person::age] lt age }

    fun nameInList(names: List&lt;String&gt;) = where&lt;Person&gt; { root[Person::name] inList names }

    fun nameOrAgeMatches(age: Int, name: String) = query&lt;Person&gt; {
        where {
            or {
                root[Person::name] eq name
                root[Person::age] lt age
            }
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can combine them for <code>find</code> or <code>count</code> queries:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Person denis = personRepository.findOne(nameEquals("Denis")).orElse(null);

long countAgeLess30 = personRepository.count(ageIsLessThan(30));

long countAgeLess20 = personRepository.count(ageIsLessThan(20));

long countAgeLess30NotDenis = personRepository.count(ageIsLessThan(30).and(not(nameEquals("Denis"))));

List&lt;Person&gt; people = personRepository.findAll(where(nameEquals("Denis").or(nameEquals("Josh"))));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Person denis = personRepository.findOne(nameEquals("Denis")).orElse(null)

long countAgeLess30 = personRepository.count(ageIsLessThan(30))

long countAgeLess20 = personRepository.count(ageIsLessThan(20))

long countAgeLess30NotDenis = personRepository.count(ageIsLessThan(30) &amp; not(nameEquals("Denis")))

List&lt;Person&gt; people = personRepository.findAll(where(nameEquals("Denis") | nameEquals("Josh")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val denis: Person? = personRepository.findOne(nameEquals("Denis")).orElse(null)

val countAgeLess30: Long = personRepository.count(ageIsLessThan(30))

val countAgeLess20: Long = personRepository.count(ageIsLessThan(20))

val countAgeLess30NotDenis: Long = personRepository.count(ageIsLessThan(30).and(not(nameEquals("Denis"))))

val people = personRepository.findAll(PredicateSpecification.where(nameEquals("Denis").or(nameEquals("Josh"))))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The examples use compile-known values, and in this case, it would be better to create custom repository methods which would come with compile-time generates queries and eliminate runtime overhead.
It&#8217;s recommended to use criteria only for dynamic queries where the query structure is not known at the build-time.
</td>
</tr>
</table>
</div>

<h2 id="mongoCriteriaExecuteUpdate"><a class="anchor" href="#mongoCriteriaExecuteUpdate"></a>7.6.2 Updating</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoCriteriaSpecifications/mongoCriteriaExecuteUpdate.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To implement the update you can use following method from <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
long updateAll(UpdateSpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long updateAll(UpdateSpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun updateAll(spec: UpdateSpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is expecting <a href="../api/io/micronaut/data/repository/criteria/UpdateSpecification.html">UpdateSpecification</a> which is a variation of specification interface that includes access to <code>jakarta.persistence.criteria.CriteriaUpdate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface UpdateSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaUpdate&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria update instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Updating specific properties can be done using <code>jakarta.persistence.criteria.CriteriaUpdate</code> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">query.set(root.get("name"), newName);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">query.set(root.get("name"), newName)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun updateName(newName: String, existingName: String) = update&lt;Person&gt; {
    set(Person::name, newName)
    where {
        root[Person::name] eq existingName
    }
}
    query.set(root[Person::name], newName)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define criteria specification methods including update specification that will help you to create an update query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age);
    }

    static UpdateSpecification&lt;Person&gt; setNewName(String newName) {
        return (root, query, criteriaBuilder) -&gt; {
            query.set(root.get("name"), newName);
            return null;
        };
    }

    static PredicateSpecification&lt;Person&gt; interestsContains(String interest) {
        return (root, criteriaBuilder) -&gt; ((PersistentEntityCriteriaBuilder) criteriaBuilder).arrayContains(root.get("interests"), criteriaBuilder.literal(interest));
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

    static UpdateSpecification&lt;Person&gt; setNewName(String newName) {
        return (root, query, criteriaBuilder) -&gt; {
            query.set(root.get("name"), newName)
            null
        }
    }

    static PredicateSpecification&lt;Person&gt; interestsContains(String interest) {
        return (root, criteriaBuilder) -&gt; ((PersistentEntityCriteriaBuilder) criteriaBuilder).arrayContains(root.get("interests"), criteriaBuilder.literal(interest))
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {
    fun nameEquals(name: String?) = where&lt;Person&gt; { root[Person::name] eq name }

    fun ageIsLessThan(age: Int) = where&lt;Person&gt; { root[Person::age] lt age }

    fun nameInList(names: List&lt;String&gt;) = where&lt;Person&gt; { root[Person::name] inList names }

    fun nameOrAgeMatches(age: Int, name: String) = query&lt;Person&gt; {
        where {
            or {
                root[Person::name] eq name
                root[Person::age] lt age
            }
        }
    }

    fun updateName(newName: String, existingName: String) = update&lt;Person&gt; {
        set(Person::name, newName)
        where {
            root[Person::name] eq existingName
        }
    }

    fun interestsContains(interest: String): PredicateSpecification&lt;Person&gt;? {
        return PredicateSpecification { root: Root&lt;Person&gt;, criteriaBuilder: CriteriaBuilder -&gt;
            (criteriaBuilder as PersistentEntityCriteriaBuilder).arrayContains(
                root.get&lt;Any&gt;("interests"),
                criteriaBuilder.literal(interest)
            )
        }
    }

    // Different style using the criteria builder
    fun nameEquals2(name: String?) = PredicateSpecification { root, criteriaBuilder -&gt;
        criteriaBuilder.equal(root[Person::name], name)
    }

    fun ageIsLessThan2(age: Int) = PredicateSpecification { root, criteriaBuilder -&gt;
        criteriaBuilder.lessThan(root[Person::age], age)
    }

    fun setNewName2(newName: String) = UpdateSpecification { root, query, criteriaBuilder -&gt;
        query.set(root[Person::name], newName)
        null
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use the update specification combined with predicate specifications:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long recordsUpdated = personRepository.updateAll(setNewName("Steven").where(nameEquals("Denis")));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long recordsUpdated = personRepository.updateAll(setNewName("Steven").where(nameEquals("Denis")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val recordsUpdated = personRepository.updateAll(updateName("Steven", "Denis"))</code></pre>
</div>
</div>

<h2 id="mongoCriteriaExecuteDelete"><a class="anchor" href="#mongoCriteriaExecuteDelete"></a>7.6.3 Deleting</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoCriteriaSpecifications/mongoCriteriaExecuteDelete.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To delete an entity or multiple entities you can use one of the following methods from <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
long deleteAll(PredicateSpecification&lt;Person&gt; spec);

@Override
long deleteAll(DeleteSpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long deleteAll(PredicateSpecification&lt;Person&gt; spec)

long deleteAll(DeleteSpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun deleteAll(spec: PredicateSpecification&lt;Person&gt;?): Long

fun deleteAll(spec: DeleteSpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>As it is for querying, <code>deleteAll</code> methods also come in two variations.</p>
</div>
<div class="paragraph">
<p>First method is expecting <a href="../api/io/micronaut/data/repository/criteria/PredicateSpecification.html">PredicateSpecification</a> which is the same interface described in <a href="#criteriaExecuteQuery">Querying</a> section</p>
</div>
<div class="paragraph">
<p>The second method comes with <a href="../api/io/micronaut/data/repository/DeleteSpecification.html">DeleteSpecification</a> and is intended only for delete criteria because it includes access to <code>jakarta.persistence.criteria.CriteriaDelete</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface DeleteSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaDelete&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria delete instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For deleting you can reuse the same predicates as for querying and updating:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {
    fun nameEquals(name: String?) = where&lt;Person&gt; { root[Person::name] eq name }

    fun ageIsLessThan(age: Int) = where&lt;Person&gt; { root[Person::age] lt age }

    fun nameInList(names: List&lt;String&gt;) = where&lt;Person&gt; { root[Person::name] inList names }

    fun nameOrAgeMatches(age: Int, name: String) = query&lt;Person&gt; {
        where {
            or {
                root[Person::name] eq name
                root[Person::age] lt age
            }
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simply pass the predicate specification to the <code>deleteAll</code> method:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long recordsDeleted = personRepository.deleteAll(where(nameEquals("Denis")));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long recordsDeleted = personRepository.deleteAll(where(nameEquals("Denis")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val recordsDeleted = personRepository.deleteAll(PredicateSpecification.where(nameEquals("Denis")))
val recordsDeleted = personRepository.deleteAll(where {
    root[Person::name] eq "Denis"
})
val recordsDeleted = personRepository.deleteAll(where {
    root[Person::name] eq "Denis"
})</code></pre>
</div>
</div>

<h2 id="mongoOtherRepositoryVariations"><a class="anchor" href="#mongoOtherRepositoryVariations"></a>7.6.4 Other repository variations</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoCriteriaSpecifications/mongoOtherRepositoryVariations.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data includes different variations of specification executor interface intended to be used with async or reactive repositories.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Builtin Variations of <code>JpaSpecificationExecutor</code> repository interface</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Interface</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default interface for querying, deleting and updating data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/async/AsyncJpaSpecificationExecutor.html">AsyncJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The async version of the specifications repository</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactiveStreamsJpaSpecificationExecutor.html">ReactiveStreamsJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The reactive streams - <code>Publisher&lt;&gt;</code> version of the specifications repository</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/reactive/ReactorJpaSpecificationExecutor.html">ReactorJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Reactor version of the specifications repository</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/data/repository/kotlin/CoroutineJpaSpecificationExecutor.html">CoroutineJpaSpecificationExecutor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kotlin version of the interface that is using coroutines</p></td>
</tr>
</tbody>
</table>

<h2 id="mongoOptimisticLocking"><a class="anchor" href="#mongoOptimisticLocking"></a>7.7 Optimistic locking</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/mongo/mongoOptimisticLocking.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Optimistic locking is a strategy where you note the actual record state&#8217;s version and modify the record only when the version is the same.</p>
</div>
<div class="paragraph">
<p>To enable optimistic locking for your entity add <a href="../api/io/micronaut/data/annotation/Version.html">@Version</a> annotated field with one of the types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Integer</code></p>
</li>
<li>
<p><code>java.lang.Long</code></p>
</li>
<li>
<p><code>java.lang.Short</code></p>
</li>
<li>
<p>Date-time type extending <code>java.time.Temporal</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The field is going to be incremented (for number types) or replaced (for date types) on an update operation.</p>
</div>
<div class="paragraph">
<p>Micronaut Data will generate update/delete filter queries with a version match and if the update/delete doesn&#8217;t produce any result <a href="../api/io/micronaut/data/exceptions/OptimisticLockException.html">OptimisticLockException</a> will be thrown.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity
public class Student {

    @Id
    @GeneratedValue
    private ObjectId id;
    @Version
    private Long version;</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MappedEntity
class Student {

    @Id
    @GeneratedValue
    ObjectId id
    @Version
    Long version</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MappedEntity
data class Student(
        @field:Id @GeneratedValue
        val id: ObjectId?,
        @field:Version
        val version: Long?,</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s possible to use <a href="../api/io/micronaut/data/annotation/Version.html">@Version</a> in a partial update or a delete method, in this case the version needs to match the version of the stored record.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoRepository
public interface StudentRepository extends CrudRepository&lt;Student, ObjectId&gt; {

    void update(@Id ObjectId id, @Version Long version, String name);

    void delete(@Id ObjectId id, @Version Long version);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MongoRepository
interface StudentRepository extends CrudRepository&lt;Student, ObjectId&gt; {

    void update(@Id ObjectId id, @Version Long version, String name)

    void delete(@Id ObjectId id, @Version Long version)
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MongoRepository
interface StudentRepository : CrudRepository&lt;Student, ObjectId&gt; {

    fun update(@Id id: ObjectId, @Version version: Long, name: String)

    fun delete(@Id id: ObjectId, @Version version: Long)

}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
See the guides for <a href="https://guides.micronaut.io/latest/micronaut-data-mongodb-synchronous.html">Access a MongoDB Database with Micronaut Data MongoDB</a> and <a href="https://guides.micronaut.io/latest/micronaut-data-mongodb-asynchronous.html">Access a MongoDB Database Asynchronously with Micronaut Data MongoDB and Reactive Streams</a> to learn more.
</td>
</tr>
</table>
</div>

<h1 id="azureCosmos"><a class="anchor" href="#azureCosmos"></a>8 Micronaut Data Azure Cosmos</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data Azure Cosmos supports some of the features of JPA implementations, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#azureCosmosRepositories">Repositories compile-time generated</a> and <a href="#projections">projection</a> queries</p>
</li>
<li>
<p><a href="#azureCosmosAttributeConverter">Attribute converters</a></p>
</li>
<li>
<p><a href="#azureCosmosOptimisticLocking">Optimistic locking</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cascading and joins are not supported like in the rest of data modules. More about <a href="#azureCosmosSpecifics">specifics</a> can be seen here.</p>
</div>
<div class="paragraph">
<p>The interaction between the object layer and Azure Cosmos Db serialization/deserialization is implemented using <a href="https://micronaut-projects.github.io/micronaut-serialization/1.0.x/guide">Micronaut Serialization</a>.</p>
</div>

<h2 id="azureCosmosQuickStart"><a class="anchor" href="#azureCosmosQuickStart"></a>8.1 Quick Start</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosQuickStart.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>At this point there is still no ability to create Micronaut project with Azure Cosmos Db support via Micronaut Launch. Our team will be working on it in the near future.</p>
</div>
<div class="paragraph">
<p>To get started with Micronaut Data Azure Cosmos add the following dependency to your annotation processor path:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">annotationProcessor(<span class="hljs-string">"io.micronaut.data:micronaut-data-document-processor")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;annotationProcessorPaths&gt;
    &lt;path&gt;
        &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
        &lt;artifactId&gt;micronaut-data-document-processor&lt;/artifactId&gt;
    &lt;/path&gt;
&lt;/annotationProcessorPaths&gt;</code></pre>
</div>
</div></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For Kotlin, add the <code>micronaut-data-document-processor</code> dependency in <a href="https://docs.micronaut.io/4.4.3/guide/#kaptOrKsp">kapt or ksp scope</a>, and for Groovy add <code>micronaut-data-document-processor</code> in compileOnly scope.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You should then configure a compile-scoped dependency on the <code>micronaut-data-azure-cosmos</code> module:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-azure-cosmos")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-azure-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>Next up you need to configure at least one data source. The following snippet from the application configuration file is an example of configuring the default Azure Cosmos Db data source:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">micronaut.application.name=example
azure.cosmos.default-gateway-mode=true
azure.cosmos.endpoint-discovery-enabled=false
azure.cosmos.endpoint=https://localhost:8081
azure.cosmos.key=
azure.cosmos.database.throughput-settings.request-units=1000
azure.cosmos.database.throughput-settings.auto-scale=false
azure.cosmos.database.database-name=testDb</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
  application:
    name: example
azure:
  cosmos:
    default-gateway-mode: true
    endpoint-discovery-enabled: false
    endpoint: https://localhost:8081
    key: ''
    database:
      throughput-settings:
        request-units: 1000
        auto-scale: false
      database-name: testDb</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[micronaut]
  [micronaut.application]
    name="example"
[azure]
  [azure.cosmos]
    default-gateway-mode=true
    endpoint-discovery-enabled=false
    endpoint="https://localhost:8081"
    key=""
    [azure.cosmos.database]
      database-name="testDb"
      [azure.cosmos.database.throughput-settings]
        request-units=1000
        auto-scale=false</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">micronaut {
  application {
    name = "example"
  }
}
azure {
  cosmos {
    defaultGatewayMode = true
    endpointDiscoveryEnabled = false
    endpoint = "https://localhost:8081"
    key = ""
    database {
      throughputSettings {
        requestUnits = 1000
        autoScale = false
      }
      databaseName = "testDb"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  micronaut {
    application {
      name = "example"
    }
  }
  azure {
    cosmos {
      default-gateway-mode = true
      endpoint-discovery-enabled = false
      endpoint = "https://localhost:8081"
      key = ""
      database {
        throughput-settings {
          request-units = 1000
          auto-scale = false
        }
        database-name = "testDb"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "micronaut": {
    "application": {
      "name": "example"
    }
  },
  "azure": {
    "cosmos": {
      "default-gateway-mode": true,
      "endpoint-discovery-enabled": false,
      "endpoint": "https://localhost:8081",
      "key": "",
      "database": {
        "throughput-settings": {
          "request-units": 1000,
          "auto-scale": false
        },
        "database-name": "testDb"
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can find more details about configuration <a href="#azureCosmosConfiguration">here</a>.</p>
</div>
<div class="paragraph">
<p>To retrieve objects from the database you need to define a class annotated with <a href="../api/io/micronaut/data/annotation/MappedEntity.html">@MappedEntity</a>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity
public class Book {
    @Id
    @GeneratedValue
    @PartitionKey
    private String id;
    private String title;
    private int pages;
    @MappedProperty(converter = ItemPriceAttributeConverter.class)
    @Nullable
    private ItemPrice itemPrice;
    @DateCreated
    private Date createdDate;
    @DateUpdated
    private Date updatedDate;

    public Book(String title, int pages) {
        this.title = title;
        this.pages = pages;
    }
    // ...
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MappedEntity
class Book {
    @Id
    @GeneratedValue
    private String id
    private String title
    private int pages
    @MappedProperty(converter = ItemPriceAttributeConverter)
    @Nullable
    private ItemPrice itemPrice
    Book(String title, int pages) {
        this.title = title
        this.pages = pages
    }
    //...
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MappedEntity
data class Book(@field:Id
                @GeneratedValue
                var id: String?,
                var title: String,
                var pages: Int = 0,
                @MappedProperty(converter = ItemPriceAttributeConverter::class)
                var itemPrice: ItemPrice? = null,
                @DateCreated
                var createdDate: Date? = null,
                @DateUpdated
                var updatedDate: Date? = null)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Followed by an interface that extends from <a href="../api/io/micronaut/data/repository/CrudRepository.html">CrudRepository</a></p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.annotation.Id;
import io.micronaut.data.cosmos.annotation.CosmosRepository;
import io.micronaut.data.model.Page;
import io.micronaut.data.model.Pageable;
import io.micronaut.data.model.Slice;
import io.micronaut.data.repository.CrudRepository;

import java.util.List;


@CosmosRepository // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, String&gt; { // <b class="conum">(2)</b>
    Book find(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.annotation.Id
import io.micronaut.data.cosmos.annotation.CosmosRepository
import io.micronaut.data.model.Pageable
import io.micronaut.data.model.Slice
import io.micronaut.data.repository.CrudRepository

@CosmosRepository // <b class="conum">(1)</b>
interface BookRepository extends CrudRepository&lt;Book, String&gt; { // <b class="conum">(2)</b>
    Book find(String title)
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.annotation.Id
import io.micronaut.data.cosmos.annotation.CosmosRepository
import io.micronaut.data.model.Pageable
import io.micronaut.data.model.Slice
import io.micronaut.data.repository.CrudRepository

@CosmosRepository // <b class="conum">(1)</b>
interface BookRepository : CrudRepository&lt;Book, String&gt; { // <b class="conum">(2)</b>
    fun find(title: String): Book
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The interface is annotated with <a href="../api/io/micronaut/data/cosmos/annotation/CosmosRepository.html">@CosmosRepository</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>CrudRepository</code> interface take 2 generic arguments, the entity type (in this case <code>Book</code>) and the ID type (in this case <code>String</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can now perform CRUD (Create, Read, Update, Delete) operations on the entity. The implementation of <code>example.BookRepository</code> is created at compilation time. To obtain a reference to it simply inject the bean:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
BookRepository bookRepository;</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Inject @Shared BookRepository bookRepository</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Inject
lateinit var bookRepository: BookRepository</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using Micronaut Data Azure Cosmos, every <code>MappedEntity</code> will correspond to the container. One container can hold only one entity or document type.
The simple name of the class annotated with @MappedEntity will be used as the container name by default. If entity class is <code>CosmosBook</code> then expected container name will be <code>cosmos_book</code> unless not overriden in <code>MappedEntity</code> annotation value. Default naming strategy for entity fields is <code>Raw</code> strategy and users should not usually need to override it.</p>
</div>
<div class="sect2">
<h3 id="_saving_an_instance_create">Saving an Instance (Create)</h3>
<div class="paragraph">
<p>To save an instance use the <code>save</code> method of the <code>CrudRepository</code> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Book book = new Book("The Stand", 1000);
book.setItemPrice(new ItemPrice(200));
bookRepository.save(book);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">def book = new Book("The Stand", 1000)
book.itemPrice = new ItemPrice(99.5)
bookRepository.save(book)
def id = book.id</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">var book = Book(null,"The Stand", 1000, ItemPrice(199.99))
bookRepository.save(book)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_an_instance_read">Retrieving an Instance (Read)</h3>
<div class="paragraph">
<p>To read a book back use <code>findById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">book = bookRepository.findById(id).orElse(null);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">book = bookRepository.findById(id).orElse(null)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">book = bookRepository.findById(id).orElse(null)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_an_instance_update">Updating an Instance (Update)</h3>
<div class="paragraph">
<p>With Micronaut Data Azure Cosmos, you can use <code>save</code> method of the <code>CrudRepository</code> or manually implement an <code>update</code> method. You can define explicit update methods for updates in your repository. For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void update(@Id String id, int pages);

void update(@Id String id, String title);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">void update(@Id String id, int pages)

void update(@Id String id, String title)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun update(@Id id: String, pages: Int)

fun update(@Id id: String, title: String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which can then be called like so:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.update(book.getId(), "Changed");</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.update(book.getId(), "Changed")</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.update(book.id.orEmpty(), "Changed")</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_an_instance_delete">Deleting an Instance (Delete)</h3>
<div class="paragraph">
<p>To delete an instance use <code>deleteById</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bookRepository.deleteById(id);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">bookRepository.deleteById(id)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">bookRepository.deleteById(id)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations you have implemented your first Micronaut Data Azure Cosmos repository! Read on to find out more.</p>
</div>
</div>

<h2 id="azureCosmosConfiguration"><a class="anchor" href="#azureCosmosConfiguration"></a>8.2 Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosConfiguration.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>When using an existing Azure Cosmos database with existing containers no special configuration is needed, except the endpoint, key and database name. However, for test purposes or when database containers need to be created during application startup there are additional options to configure containers.</p>
</div>
<div class="paragraph">
<p>As mentioned in the <a href="#azureCosmosQuickStart">Quick Start</a> every class annotated with @MappedEntity will correspond to one container in Azure Cosmos Db. If the property azure.cosmos.database.update-policy is set to NONE then no attempt to create the container will be made. If that value is set to CREATE_IF_NOT_EXISTS then the application will attempt to create container if the container does not already exist. Whilst, if the value is UPDATE the application will try to replace existing any containers and its properties.</p>
</div>
<div class="paragraph">
<p>Currently, it is only possible to configure a small subset of properties for the database and containers. For the database throughput properties can be configured whilst for containers the throughput properties and partition key path are configurable.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An additional way to configure the partition key value is adding the annotation <a href="../api/io/micronaut/data/cosmos/annotation/PartitionKey.html">@PartitionKey</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The below is an example application configuration showing container and db properties used when creating new containers if the containers don&#8217;t already exist:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">micronaut.application.name=example
azure.cosmos.default-gateway-mode=true
azure.cosmos.endpoint-discovery-enabled=false
azure.cosmos.endpoint=https://localhost:8081
azure.cosmos.key=
azure.cosmos.database.disable-non-streaming-order-by=true
azure.cosmos.database.throughput-settings.request-units=1000
azure.cosmos.database.throughput-settings.auto-scale=false
azure.cosmos.database.database-name=testDb
azure.cosmos.database.packages=io.micronaut.data.azure.entities
azure.cosmos.database.update-policy=CREATE_IF_NOT_EXISTS
azure.cosmos.database.container-settings[0].container-name=family
azure.cosmos.database.container-settings[0].partition-key-path=/lastname
azure.cosmos.database.container-settings[0].throughput-settings.request-units=1000
azure.cosmos.database.container-settings[0].throughput-settings.auto-scale=false
azure.cosmos.database.container-settings[1].container-name=book
azure.cosmos.database.container-settings[1].partition-key-path=/id
azure.cosmos.database.container-settings[1].throughput-settings.request-units=1200
azure.cosmos.database.container-settings[1].throughput-settings.auto-scale=false</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
  application:
    name: example
azure:
  cosmos:
    default-gateway-mode: true
    endpoint-discovery-enabled: false
    endpoint: https://localhost:8081
    key: ''
    database:
      disable-non-streaming-order-by: true
      throughput-settings:
        request-units: 1000
        auto-scale: false
      database-name: testDb
      packages: io.micronaut.data.azure.entities
      update-policy: CREATE_IF_NOT_EXISTS
      container-settings:
        - container-name: family
          partition-key-path: /lastname
          throughput-settings:
            request-units: 1000
            auto-scale: false
        - container-name: book
          partition-key-path: /id
          throughput-settings:
            request-units: 1200
            auto-scale: false</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[micronaut]
  [micronaut.application]
    name="example"
[azure]
  [azure.cosmos]
    default-gateway-mode=true
    endpoint-discovery-enabled=false
    endpoint="https://localhost:8081"
    key=""
    [azure.cosmos.database]
      disable-non-streaming-order-by=true
      database-name="testDb"
      packages="io.micronaut.data.azure.entities"
      update-policy="CREATE_IF_NOT_EXISTS"
      [azure.cosmos.database.throughput-settings]
        request-units=1000
        auto-scale=false
      [[azure.cosmos.database.container-settings]]
        container-name="family"
        partition-key-path="/lastname"
        [azure.cosmos.database.container-settings.throughput-settings]
          request-units=1000
          auto-scale=false
      [[azure.cosmos.database.container-settings]]
        container-name="book"
        partition-key-path="/id"
        [azure.cosmos.database.container-settings.throughput-settings]
          request-units=1200
          auto-scale=false</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy-config hljs" data-lang="groovy-config">micronaut {
  application {
    name = "example"
  }
}
azure {
  cosmos {
    defaultGatewayMode = true
    endpointDiscoveryEnabled = false
    endpoint = "https://localhost:8081"
    key = ""
    database {
      disableNonStreamingOrderBy = true
      throughputSettings {
        requestUnits = 1000
        autoScale = false
      }
      databaseName = "testDb"
      packages = "io.micronaut.data.azure.entities"
      updatePolicy = "CREATE_IF_NOT_EXISTS"
      containerSettings = [{
          containerName = "family"
          partitionKeyPath = "/lastname"
          throughputSettings {
            requestUnits = 1000
            autoScale = false
          }
        }, {
          containerName = "book"
          partitionKeyPath = "/id"
          throughputSettings {
            requestUnits = 1200
            autoScale = false
          }
        }]
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hocon hljs" data-lang="hocon">{
  micronaut {
    application {
      name = "example"
    }
  }
  azure {
    cosmos {
      default-gateway-mode = true
      endpoint-discovery-enabled = false
      endpoint = "https://localhost:8081"
      key = ""
      database {
        disable-non-streaming-order-by = true
        throughput-settings {
          request-units = 1000
          auto-scale = false
        }
        database-name = "testDb"
        packages = "io.micronaut.data.azure.entities"
        update-policy = "CREATE_IF_NOT_EXISTS"
        container-settings = [{
            container-name = "family"
            partition-key-path = "/lastname"
            throughput-settings {
              request-units = 1000
              auto-scale = false
            }
          }, {
            container-name = "book"
            partition-key-path = "/id"
            throughput-settings {
              request-units = 1200
              auto-scale = false
            }
          }]
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json-config hljs" data-lang="json-config">{
  "micronaut": {
    "application": {
      "name": "example"
    }
  },
  "azure": {
    "cosmos": {
      "default-gateway-mode": true,
      "endpoint-discovery-enabled": false,
      "endpoint": "https://localhost:8081",
      "key": "",
      "database": {
        "disable-non-streaming-order-by": true,
        "throughput-settings": {
          "request-units": 1000,
          "auto-scale": false
        },
        "database-name": "testDb",
        "packages": "io.micronaut.data.azure.entities",
        "update-policy": "CREATE_IF_NOT_EXISTS",
        "container-settings": [{
            "container-name": "family",
            "partition-key-path": "/lastname",
            "throughput-settings": {
              "request-units": 1000,
              "auto-scale": false
            }
          }, {
            "container-name": "book",
            "partition-key-path": "/id",
            "throughput-settings": {
              "request-units": 1200,
              "auto-scale": false
            }
          }]
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>azure.cosmos.database.disable-non-streaming-order-by</code> needs to be set to true if the query runs against a region or emulator that has not yet been updated with the new NonStreamingOrderBy query feature.
</td>
</tr>
</table>
</div>

<h2 id="azureCosmosRepositories"><a class="anchor" href="#azureCosmosRepositories"></a>8.3 Repositories</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosRepositories.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As seen in the <a href="#azureCosmosQuickStart">Quick Start</a> Azure Cosmos Data repositories in Micronaut Data are defined as interfaces that are annotated with the <a href="../api/io/micronaut/data/cosmos/annotation/CosmosRepository.html">@CosmosRepository</a>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CosmosRepository <i class="conum" data-value="1"></i><b>(1)</b>
public interface BookRepository extends CrudRepository&lt;Book, String&gt; {
    Optional&lt;Book&gt; findByAuthorId(@NotNull String authorId);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>@CosmosRepository marking the interface to access Azure Cosmos Db</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The entity to treat as the root entity for the purposes of querying is established either from the method signature or from the generic type parameter specified to the <a href="../api/io/micronaut/data/repository/GenericRepository.html">GenericRepository</a> interface.</p>
</div>
<div class="paragraph">
<p>If no root entity can be established then a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>The same interfaces supported by the JPA implementation are supported by Azure Cosmos Data.</p>
</div>
<div class="paragraph">
<p>Note that in addition to interfaces you can also define repositories as abstract classes:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.data.cosmos.annotation.CosmosRepository;
import io.micronaut.data.repository.CrudRepository;

import java.util.List;

@CosmosRepository
public abstract class AbstractBookRepository implements CrudRepository&lt;Book, String&gt; {

    public abstract List&lt;Book&gt; findByTitle(String title);
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import io.micronaut.data.cosmos.annotation.CosmosRepository
import io.micronaut.data.repository.CrudRepository

@CosmosRepository
abstract class AbstractBookRepository implements CrudRepository&lt;Book, String&gt; {

    abstract List&lt;Book&gt; findByTitle(String title)
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.data.cosmos.annotation.CosmosRepository
import io.micronaut.data.repository.CrudRepository

@CosmosRepository
abstract class AbstractBookRepository : CrudRepository&lt;Book, String&gt; {

    abstract fun findByTitle(title: String): List&lt;Book&gt;
}</code></pre>
</div>
</div>

<h2 id="azureCosmosCriteriaSpecifications"><a class="anchor" href="#azureCosmosCriteriaSpecifications"></a>8.4 Repositories with Criteria API</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosCriteriaSpecifications.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In some cases, you need to build a query programmatically and at the runtime; for that, Micronaut Data implements a subset of Jakarta Persistence Criteria API 3.0, which can be used for Micronaut Data Azure Cosmos features. To utilize this feature add the following dependency:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"jakarta.persistence:jakarta.persistence-api")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;jakarta.persistence&lt;/groupId&gt;
    &lt;artifactId&gt;jakarta.persistence-api&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>To implement queries that cannot be defined at the compile-time Micronaut Data introduces <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> repository interface that can be used to extend your repository interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoRepository
public interface PersonRepository extends CrudRepository&lt;Person, ObjectId&gt;, JpaSpecificationExecutor&lt;Person&gt; {
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MongoRepository
interface PersonRepository extends CrudRepository&lt;Person, ObjectId&gt;, JpaSpecificationExecutor&lt;Person&gt; {
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MongoRepository
interface PersonRepository : CrudRepository&lt;Person, ObjectId&gt;, JpaSpecificationExecutor&lt;Person&gt; {
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each method expects a "specification" which is a functional interface with a set of Criteria API objects intended to build a query programmatically.</p>
</div>
<div class="paragraph">
<p>Micronaut Criteria API currently implements only a subset of the API. Most of it is internally used to create queries with predicates and projections.</p>
</div>
<div class="paragraph">
<p>Currently, not supported JPA Criteria API features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Joins with custom <code>ON</code> expressions and typed join methods like <code>joinSet</code> etc</p>
</li>
<li>
<p>Sub-queries</p>
</li>
<li>
<p>Collection operations: <code>isMember</code> etc</p>
</li>
<li>
<p>Custom or tuple result type</p>
</li>
<li>
<p>Transformation expressions like concat, substring etc.</p>
</li>
<li>
<p>Cases and functions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More information about Jakarta Persistence Criteria API 3.0 you can find at the <a href="https://jakarta.ee/specifications/persistence/3.0/jakarta-persistence-spec-3.0.html#a6925">official API specification</a></p>
</div>

<h2 id="azureCosmosCriteriaExecuteQuery"><a class="anchor" href="#azureCosmosCriteriaExecuteQuery"></a>8.4.1 Querying</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosCriteriaSpecifications/azureCosmosCriteriaExecuteQuery.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To find an entity or multiple entities you can use one of the following methods from <a href="../api/io/micronaut/data/jpa/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
Optional&lt;Person&gt; findOne(PredicateSpecification&lt;Person&gt; spec);

@Override
Optional&lt;Person&gt; findOne(QuerySpecification&lt;Person&gt; spec);

@Override
List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec);

@Override
List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec);

@Override
List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Sort sort);

@Override
List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Sort sort);

@Override
Page&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Pageable pageable);

@Override
Page&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Pageable pageable);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Optional&lt;Person&gt; findOne(PredicateSpecification&lt;Person&gt; spec)

Optional&lt;Person&gt; findOne(QuerySpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec)

List&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Sort sort)

List&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Sort sort)

Page&lt;Person&gt; findAll(PredicateSpecification&lt;Person&gt; spec, Pageable pageable)

Page&lt;Person&gt; findAll(QuerySpecification&lt;Person&gt; spec, Pageable pageable)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun findOne(spec: PredicateSpecification&lt;Person&gt;?): Optional&lt;Person&gt;

fun findOne(spec: QuerySpecification&lt;Person&gt;?): Optional&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?): List&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?): List&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?, sort: Sort): List&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?, sort: Sort): List&lt;Person&gt;

fun findAll(spec: PredicateSpecification&lt;Person&gt;?, pageable: Pageable): Page&lt;Person&gt;

fun findAll(spec: QuerySpecification&lt;Person&gt;?, pageable: Pageable): Page&lt;Person&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there are two variations of <code>findOne</code>/<code>findAll</code> methods.</p>
</div>
<div class="paragraph">
<p>First method is expecting <a href="../api/io/micronaut/data/repository/criteria/PredicateSpecification.html">PredicateSpecification</a> which is a simple specification interface that can be implemented to return a predicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface PredicateSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="3"></i><b>(3)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This interface can also be used for update and delete methods, and it provides <code>or</code> and <code>and</code> methods for combining multiple predicates.</p>
</div>
<div class="paragraph">
<p>The second interface is intended only for query criteria because it includes <code>jakarta.persistence.criteria.CriteriaQuery</code> as a parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface QuerySpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaQuery&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria query instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For implementing counting queries following methods can be used:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
long count(PredicateSpecification&lt;Person&gt; spec);

@Override
long count(QuerySpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long count(PredicateSpecification&lt;Person&gt; spec)

long count(QuerySpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun count(spec: PredicateSpecification&lt;Person&gt;?): Long

fun count(spec: QuerySpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define criteria specification methods that will help you to create a query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {
    fun nameEquals(name: String?) = where&lt;Person&gt; { root[Person::name] eq name }

    fun ageIsLessThan(age: Int) = where&lt;Person&gt; { root[Person::age] lt age }

    fun nameInList(names: List&lt;String&gt;) = where&lt;Person&gt; { root[Person::name] inList names }

    fun nameOrAgeMatches(age: Int, name: String?) = where&lt;Person&gt; {
        or {
            root[Person::name] eq name
            root[Person::age] lt age
        }
    }

    fun nameAndAgeMatch(age: Int, name: String) = query&lt;Person&gt; {
        where {
            root[Person::name] eq name
            root[Person::age] lt age
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can combine them for <code>find</code> or <code>count</code> queries:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Person denis = personRepository.findOne(nameEquals("Denis")).orElse(null);

long countAgeLess30 = personRepository.count(ageIsLessThan(30));

long countAgeLess20 = personRepository.count(ageIsLessThan(20));

long countAgeLess30NotDenis = personRepository.count(ageIsLessThan(30).and(not(nameEquals("Denis"))));

List&lt;Person&gt; people = personRepository.findAll(where(nameEquals("Denis").or(nameEquals("Josh"))));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">Person denis = personRepository.findOne(nameEquals("Denis")).orElse(null)

long countAgeLess30 = personRepository.count(ageIsLessThan(30))

long countAgeLess20 = personRepository.count(ageIsLessThan(20))

long countAgeLess30NotDenis = personRepository.count(ageIsLessThan(30) &amp; not(nameEquals("Denis")))

List&lt;Person&gt; people = personRepository.findAll(where(nameEquals("Denis") | nameEquals("Josh")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val denis: Person? = personRepository.findOne(nameEquals("Denis")).orElse(null)

val countAgeLess30: Long = personRepository.count(ageIsLessThan(30))

val countAgeLess20: Long = personRepository.count(ageIsLessThan(20))

val countAgeLess30NotDenis: Long = personRepository.count(ageIsLessThan(30).and(not(nameEquals("Denis"))))

val people = personRepository.findAll(PredicateSpecification.where(nameEquals("Denis").or(nameEquals("Josh"))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Specific criteria supported by Micronaut Azure Cosmos Data is <code>ArrayContains</code> or <code>CollectionContains</code> and for a class having an array or list of strings field named <code>tags</code> it can be used either via custom repository method like this:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public abstract List&lt;Family&gt; findByTagsArrayContains(String tag);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">abstract List&lt;Family&gt; findByTagsArrayContains(String tag)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">abstract fun findByTagsArrayContains(tag: String): List&lt;Family&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or predicate specification:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static PredicateSpecification&lt;Family&gt; tagsContain(String tag) {
    return (root, criteriaBuilder) -&gt; ((PersistentEntityCriteriaBuilder) criteriaBuilder).arrayContains(root.get("tags"), criteriaBuilder.literal(tag));
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">static PredicateSpecification&lt;Family&gt; tagsContain(String tag) {
    return (root, criteriaBuilder) -&gt; ((PersistentEntityCriteriaBuilder)criteriaBuilder).arrayContains(root.get("tags"), criteriaBuilder.literal(tag))
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun tagsContain(tag: String): PredicateSpecification&lt;Family?&gt;? {
    return PredicateSpecification { root: Root&lt;Family?&gt;, criteriaBuilder: CriteriaBuilder -&gt;
        (criteriaBuilder as PersistentEntityCriteriaBuilder).arrayContains(
            root.get&lt;Any&gt;("tags"),
            criteriaBuilder.literal(tag)
        )
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that Microsoft Data Azure Cosmos Db supports searching for list or array containing only against single element.
For partial search using <code>ArrayContains</code> generic repository methods cannot be used but custom methods with raw query like this:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query("SELECT DISTINCT VALUE f FROM family f WHERE ARRAY_CONTAINS(f.children, :gender, true)")
public abstract List&lt;Family&gt; childrenArrayContainsGender(Map.Entry&lt;String, Object&gt; gender);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@Query("SELECT DISTINCT VALUE f FROM family f WHERE ARRAY_CONTAINS(f.children, :gender, true)")
abstract List&lt;Family&gt; childrenArrayContainsGender(Map.Entry&lt;String, Object&gt; gender)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Query("SELECT DISTINCT VALUE f FROM family f WHERE ARRAY_CONTAINS(f.children, :gender, true)")
abstract fun childrenArrayContainsGender(gender: Map.Entry&lt;String, Any&gt;): List&lt;Family&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then pass map entry with "gender" as key and gender as value, basically any object that will serialize to <code>{"gender": "&lt;gender_value&gt;"}</code> for this example.
This will perform search against <code>children</code> array in the <code>Family</code> class using just <code>gender</code> field.
It can be also achieved by using predicate specification:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static PredicateSpecification&lt;Family&gt; childrenArrayContainsGender(GenderAware gender) {
    return (root, criteriaBuilder) -&gt; ((PersistentEntityCriteriaBuilder) criteriaBuilder).arrayContains(root.join("children"), criteriaBuilder.literal(gender));
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">static PredicateSpecification&lt;Family&gt; childrenArrayContainsGender(GenderAware gender) {
    return (root, criteriaBuilder) -&gt; ((PersistentEntityCriteriaBuilder) criteriaBuilder).arrayContains(root.join("children"), criteriaBuilder.literal(gender))
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun childrenArrayContainsGender(gender: IGenderAware): PredicateSpecification&lt;Family?&gt;? {
    return PredicateSpecification { root: Root&lt;Family?&gt;, criteriaBuilder: CriteriaBuilder -&gt;
        (criteriaBuilder as PersistentEntityCriteriaBuilder).arrayContains(
            root.join&lt;Any, Any&gt;("children"),
            criteriaBuilder.literal(gender)
        )
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The examples use compile-known values, and in this case, it would be better to create custom repository methods which would come with compile-time generates queries and eliminate runtime overhead.
It&#8217;s recommended to use criteria only for dynamic queries where the query structure is not known at the build-time.
</td>
</tr>
</table>
</div>

<h2 id="azureCosmosCriteriaExecuteUpdate"><a class="anchor" href="#azureCosmosCriteriaExecuteUpdate"></a>8.4.2 Updating</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosCriteriaSpecifications/azureCosmosCriteriaExecuteUpdate.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To implement the update you can use following method from <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
long updateAll(UpdateSpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long updateAll(UpdateSpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun updateAll(spec: UpdateSpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is expecting <a href="../api/io/micronaut/data/repository/criteria/UpdateSpecification.html">UpdateSpecification</a> which is a variation of specification interface that includes access to <code>jakarta.persistence.criteria.CriteriaUpdate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface UpdateSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaUpdate&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria update instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Updating specific properties can be done using <code>jakarta.persistence.criteria.CriteriaUpdate</code> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">query.set(root.get("name"), newName);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">query.set(root.get("name"), newName)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun updateName(newName: String, existingName: String) = update&lt;Person&gt; {
    set(Person::name, newName)
    where {
        root[Person::name] eq existingName
    }
}
    query.set(root[Person::name], newName)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define criteria specification methods including update specification that will help you to create an update query:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age);
    }

    static UpdateSpecification&lt;Person&gt; setNewName(String newName) {
        return (root, query, criteriaBuilder) -&gt; {
            query.set(root.get("name"), newName);
            return null;
        };
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

    static UpdateSpecification&lt;Person&gt; setNewName(String newName) {
        return (root, query, criteriaBuilder) -&gt; {
            query.set(root.get("name"), newName)
            null
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {
    fun nameEquals(name: String?) = where&lt;Person&gt; { root[Person::name] eq name }

    fun ageIsLessThan(age: Int) = where&lt;Person&gt; { root[Person::age] lt age }

    fun nameInList(names: List&lt;String&gt;) = where&lt;Person&gt; { root[Person::name] inList names }

    fun nameOrAgeMatches(age: Int, name: String?) = where&lt;Person&gt; {
        or {
            root[Person::name] eq name
            root[Person::age] lt age
        }
    }

    fun nameAndAgeMatch(age: Int, name: String) = query&lt;Person&gt; {
        where {
            root[Person::name] eq name
            root[Person::age] lt age
        }
    }

    fun updateName(newName: String, existingName: String) = update&lt;Person&gt; {
        set(Person::name, newName)
        where {
            root[Person::name] eq existingName
        }
    }

    // Different style using the criteria builder
    fun nameEquals2(name: String?) = PredicateSpecification { root, criteriaBuilder -&gt;
        criteriaBuilder.equal(root[Person::name], name)
    }

    fun ageIsLessThan2(age: Int) = PredicateSpecification { root, criteriaBuilder -&gt;
        criteriaBuilder.lessThan(root[Person::age], age)
    }

    fun setNewName2(newName: String) = UpdateSpecification { root, query, _ -&gt;
        query.set(root[Person::name], newName)
        null
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use the update specification combined with predicate specifications:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long recordsUpdated = personRepository.updateAll(setNewName("Steven").where(nameEquals("Denis")));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long recordsUpdated = personRepository.updateAll(setNewName("Steven").where(nameEquals("Denis")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val recordsUpdated = personRepository.updateAll(updateName("Steven", "Denis"))</code></pre>
</div>
</div>

<h2 id="azureCosmosCriteriaExecuteDelete"><a class="anchor" href="#azureCosmosCriteriaExecuteDelete"></a>8.4.3 Deleting</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosCriteriaSpecifications/azureCosmosCriteriaExecuteDelete.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To delete an entity or multiple entities you can use one of the following methods from <a href="../api/io/micronaut/data/repository/JpaSpecificationExecutor.html">JpaSpecificationExecutor</a> interface:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
long deleteAll(PredicateSpecification&lt;Person&gt; spec);

@Override
long deleteAll(DeleteSpecification&lt;Person&gt; spec);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long deleteAll(PredicateSpecification&lt;Person&gt; spec)

long deleteAll(DeleteSpecification&lt;Person&gt; spec)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">fun deleteAll(spec: PredicateSpecification&lt;Person&gt;?): Long

fun deleteAll(spec: DeleteSpecification&lt;Person&gt;?): Long</code></pre>
</div>
</div>
<div class="paragraph">
<p>As it is for querying, <code>deleteAll</code> methods also come in two variations.</p>
</div>
<div class="paragraph">
<p>First method is expecting <a href="../api/io/micronaut/data/repository/criteria/PredicateSpecification.html">PredicateSpecification</a> which is the same interface described in <a href="#criteriaExecuteQuery">Querying</a> section</p>
</div>
<div class="paragraph">
<p>The second method comes with <a href="../api/io/micronaut/data/repository/DeleteSpecification.html">DeleteSpecification</a> and is intended only for delete criteria because it includes access to <code>jakarta.persistence.criteria.CriteriaDelete</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static jakarta.persistence.criteria.*;

public interface DeleteSpecification&lt;T&gt; {

    <i class="conum" data-value="1"></i><b>(1)</b>
    @Nullable
    Predicate toPredicate(@NonNull Root&lt;T&gt; root, <i class="conum" data-value="2"></i><b>(2)</b>
                          @NonNull CriteriaDelete&lt;?&gt; query, <i class="conum" data-value="3"></i><b>(3)</b>
                          @NonNull CriteriaBuilder criteriaBuilder <i class="conum" data-value="4"></i><b>(4)</b>
    );

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The specification is producing a query limiting predicate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The criteria delete instance</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The criteria builder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For deleting you can reuse the same predicates as for querying and updating:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name);
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">class Specifications {

    static PredicateSpecification&lt;Person&gt; nameEquals(String name) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get("name"), name)
    }

    static PredicateSpecification&lt;Person&gt; ageIsLessThan(int age) {
        return (root, criteriaBuilder) -&gt; criteriaBuilder.lessThan(root.get("age"), age)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">object Specifications {
    fun nameEquals(name: String?) = where&lt;Person&gt; { root[Person::name] eq name }

    fun ageIsLessThan(age: Int) = where&lt;Person&gt; { root[Person::age] lt age }

    fun nameInList(names: List&lt;String&gt;) = where&lt;Person&gt; { root[Person::name] inList names }

    fun nameOrAgeMatches(age: Int, name: String?) = where&lt;Person&gt; {
        or {
            root[Person::name] eq name
            root[Person::age] lt age
        }
    }

    fun nameAndAgeMatch(age: Int, name: String) = query&lt;Person&gt; {
        where {
            root[Person::name] eq name
            root[Person::age] lt age
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simply pass the predicate specification to the <code>deleteAll</code> method:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long recordsDeleted = personRepository.deleteAll(where(nameEquals("Denis")));</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">long recordsDeleted = personRepository.deleteAll(where(nameEquals("Denis")))</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val recordsDeleted = personRepository.deleteAll(PredicateSpecification.where(nameEquals("Denis")))
val recordsDeleted = personRepository.deleteAll(where {
    root[Person::name] eq "Denis"
})
val recordsDeleted = personRepository.deleteAll(where {
    root[Person::name] eq "Denis"
})</code></pre>
</div>
</div>

<h2 id="azureCosmosSpecifics"><a class="anchor" href="#azureCosmosSpecifics"></a>8.5 Azure Cosmos Specifics</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosSpecifics.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Since Azure Cosmos database is not relational like most of the database Micronaut Data supports, it does have different implementations in some specifics.</p>
</div>
<div class="sect2">
<h3 id="_relation_mapping">Relation Mapping</h3>
<div class="paragraph">
<p>Since this database is not relational and cross container and cross document joins are not supported, relations between entities/containers are not mappable. The only type of relations supported is <code>@Relation(value = Relation.Kind.EMBEDDED)</code> and <code>@Relation(value = Relation.Kind.ONE_TO_MANY)</code> which are actually relations between document and its embedded objects or arrays. Here is an example of such mapping:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity
public class Family {

    @Id
    private String id;

    @PartitionKey
    private String lastName;

    @Relation(value = Relation.Kind.EMBEDDED)
    private Address address;

    @Relation(value = Relation.Kind.ONE_TO_MANY)
    private List&lt;Child&gt; children = new ArrayList&lt;&gt;();</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MappedEntity
class Family {

    @Id
    private String id
    @PartitionKey
    private String lastName
    @Relation(value = Relation.Kind.EMBEDDED)
    private Address address
    @Relation(value = Relation.Kind.ONE_TO_MANY)
    private List&lt;Child&gt; children = new ArrayList&lt;&gt;()</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MappedEntity
data class Family(
    @field:Id
    val id: String,
    @PartitionKey
    var lastName: String,
    @Relation(value = Relation.Kind.EMBEDDED)
    var address: Address,
    @Relation(value = Relation.Kind.ONE_TO_MANY)
    var children: List&lt;Child&gt; = ArrayList(),</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>Relation</code> mapping in this case is needed for our query builder to generate projections, ordering and filtering by the fields in the embedded objects or arrays which can be seen in methods declared in <code>FamilyRepository</code></p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public abstract List&lt;Family&gt; findByAddressStateAndAddressCityOrderByAddressCity(String state, String city);

    public abstract void updateByAddressCounty(String county, boolean registered, @Nullable Date registeredDate);

    @Join(value = "children.pets", alias = "pets")
    public abstract List&lt;Family&gt; findByChildrenPetsType(PetType type);

    public abstract List&lt;Child&gt; findChildrenByChildrenPetsGivenName(String name);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">    abstract List&lt;Family&gt; findByAddressStateAndAddressCityOrderByAddressCity(String state, String city)

    abstract void updateByAddressCounty(String county, boolean registered, @Nullable Date registeredDate)

    @Join(value = "children.pets", alias = "pets")
    abstract List&lt;Family&gt; findByChildrenPetsType(PetType type)

    abstract List&lt;Child&gt; findChildrenByChildrenPetsGivenName(String name)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">    abstract fun findByAddressStateAndAddressCityOrderByAddressCity(state: String, city: String): List&lt;Family&gt;
    abstract fun updateByAddressCounty(county: String, registered: Boolean, @Nullable registeredDate: Date?)
    @Join(value = "children.pets", alias = "pets")
    abstract fun findByChildrenPetsType(type: PetType): List&lt;Family&gt;
    abstract fun findChildrenByChildrenPetsGivenName(name: String): List&lt;Child&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Due to the nature of the database and implementation of relations, cascading does not have much sense either. Embedded objects and arrays in the documents are being automatically saved when the document is saved.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity">Identity</h3>
<div class="paragraph">
<p>With Azure Cosmos Db, every document has got internal id property of String type. Micronaut Data Cosmos expects @Id to be of types: Short, Integer, Long, String or UUID. When saving and reading the type is serialized to String and deserialized from a String stored in the id property. Declaring a property annotated with @Id with an unsupported type will result in an exception.
Generation of ids will work only for String and UUID where UUID can be generated either by using the @GeneratedValue or @AutoPopulated annotations. String id can be generated only by using @GeneratedValue annotation. Numerical ids cannot be auto generated, and it is up to user to set the id value before saving.
Composite identities are not supported.</p>
</div>
</div>
<div class="sect2">
<h3 id="_partition_key">Partition Key</h3>
<div class="paragraph">
<p>In Azure Cosmos Db partition keys are the core element to distributing data efficiently into different logical and physical sets so that the queries performed against the database are completed as quickly as possible. Every mapped entity should have partition key defined. Like explained above, it can be defined using <a href="../api/io/micronaut/data/cosmos/annotation/PartitionKey.html">@PartitionKey</a> annotation on appropriate entity field or via configuration as explained in <a href="#azureCosmosConfiguration">configuration</a> section. Efficiently using well-defined partition key will improve operations performance and reduce request unit costs.
Micronaut Data Cosmos tries to use a partition key whenever possible. Here are some repository method examples that make use of a partition key in read, update or delete operations</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public abstract Optional&lt;Family&gt; queryById(String id, PartitionKey partitionKey);

    public abstract void updateRegistered(@Id String id, boolean registered, PartitionKey partitionKey);

    public abstract void deleteByLastName(String lastName, PartitionKey partitionKey);

    public abstract void deleteById(String id, PartitionKey partitionKey);</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">    abstract Optional&lt;Family&gt; queryById(String id, PartitionKey partitionKey)

    abstract void updateRegistered(@Id String id, boolean registered, PartitionKey partitionKey)

    abstract void deleteByLastName(String lastName, PartitionKey partitionKey)

    abstract void deleteById(String id, PartitionKey partitionKey)</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">    abstract fun queryById(id: String?, partitionKey: PartitionKey?): Optional&lt;Family?&gt;?
    abstract fun deleteByLastName(lastName: String, partitionKey: PartitionKey)
    abstract fun deleteById(id: String, partitionKey: PartitionKey)
    abstract fun updateRegistered(@Id id: String, registered: Boolean, partitionKey: PartitionKey)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_diagnostics">Diagnostics</h3>
<div class="paragraph">
<p>Azure Cosmos Db provides operations diagnostics so users can get that information and perhaps integrate  with their logging or metrics system. In Micronaut Data Azure we expose interface <a href="../api/io/micronaut/data/cosmos/operations/CosmosDiagnosticsProcessor.html">CosmosDiagnosticsProcessor</a>. Users need to implement this interface and add it to the context, so it can be available to our operations classes. It has only one method</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">void processDiagnostics(String operationName, @Nullable CosmosDiagnostics cosmosDiagnostics, @Nullable String activityId, double requestCharge);</code></pre>
</div>
</div>
<div class="paragraph">
<p>which is being called after each operation against Azure Cosmos Db. Parameter <code>operationName</code> is internal operation name in Micronaut Data Azure, and it has got these known values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">String CREATE_DATABASE_IF_NOT_EXISTS = "CreateDatabaseIfNotExists";
String REPLACE_DATABASE_THROUGHPUT = "ReplaceDatabaseThroughput";
String CREATE_CONTAINER_IF_NOT_EXISTS = "CreateContainerIfNotExists";
String REPLACE_CONTAINER_THROUGHPUT = "ReplaceContainerThroughput";
String REPLACE_CONTAINER = "ReplaceContainer";
String QUERY_ITEMS = "QueryItems";
String EXECUTE_BULK = "ExecuteBulk";
String CREATE_ITEM = "CreateItem";
String REPLACE_ITEM = "ReplaceItem";
String DELETE_ITEM = "DeleteItem";</code></pre>
</div>
</div>
<div class="paragraph">
<p>so user is aware for which operation diagnostics are being processed.</p>
</div>
</div>

<h2 id="azureCosmosAttributeConverter"><a class="anchor" href="#azureCosmosAttributeConverter"></a>8.6 Using Attribute Converter</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosAttributeConverter.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>There are cases where you would like to represent the attribute differently in the database than in the entity.</p>
</div>
<div class="paragraph">
<p>Consider the following example entity:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MappedEntity
public class Book {
    @Id
    @GeneratedValue
    @PartitionKey
    private String id;
    private String title;
    private int pages;
    @MappedProperty(converter = ItemPriceAttributeConverter.class)
    @Nullable
    private ItemPrice itemPrice;
    @DateCreated
    private Date createdDate;
    @DateUpdated
    private Date updatedDate;

    public Book(String title, int pages) {
        this.title = title;
        this.pages = pages;
    }
    // ...
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@MappedEntity
class Book {
    @Id
    @GeneratedValue
    private String id
    private String title
    private int pages
    @MappedProperty(converter = ItemPriceAttributeConverter)
    @Nullable
    private ItemPrice itemPrice
    Book(String title, int pages) {
        this.title = title
        this.pages = pages
    }
    //...
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MappedEntity
data class Book(@field:Id
                @GeneratedValue
                var id: String?,
                var title: String,
                var pages: Int = 0,
                @MappedProperty(converter = ItemPriceAttributeConverter::class)
                var itemPrice: ItemPrice? = null,
                @DateCreated
                var createdDate: Date? = null,
                @DateUpdated
                var updatedDate: Date? = null)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Book</code> class has a reference to a type <code>ItemPrice</code>. The <code>ItemPrice</code> type is defined as:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.annotation.Introspected;

@Introspected
public class ItemPrice {

    private double price;

    public ItemPrice(double price) {
        this.price = price;
    }

    public double getPrice() {
        return price;
    }

    public static ItemPrice valueOf(double price) {
        return new ItemPrice(price);
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.Immutable

@Immutable
class ItemPrice {
    double price
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

data class ItemPrice(val price: Double)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see <code>@MappedProperty(converter = ItemPriceAttributeConverter.class)</code> is used to define the <code>ItemPrce</code> converter.</p>
</div>
<div class="paragraph">
<p>The last step is to add custom attribute conversion so that Micronaut Data knows how to read and write the type from an <code>Double</code>:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;

import io.micronaut.core.convert.ConversionContext;
import io.micronaut.data.model.runtime.convert.AttributeConverter;
import jakarta.inject.Singleton;

@Singleton
public class ItemPriceAttributeConverter implements AttributeConverter&lt;ItemPrice, Double&gt; {

    @Override
    public Double convertToPersistedValue(ItemPrice bookPrice, ConversionContext context) {
        return bookPrice == null ? null : bookPrice.getPrice();
    }

    @Override
    public ItemPrice convertToEntityValue(Double value, ConversionContext context) {
        return value == null ? null : ItemPrice.valueOf(value);
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">package example

import groovy.transform.CompileStatic
import io.micronaut.core.convert.ConversionContext
import io.micronaut.data.model.runtime.convert.AttributeConverter
import jakarta.inject.Singleton

@Singleton // <b class="conum">(1)</b>
@CompileStatic
class ItemPriceAttributeConverter implements AttributeConverter&lt;ItemPrice, Double&gt; {

    @Override // <b class="conum">(2)</b>
    Double convertToPersistedValue(ItemPrice itemPrice, ConversionContext context) {
        return itemPrice == null ? null : itemPrice.getPrice()
    }

    @Override // <b class="conum">(3)</b>
    ItemPrice convertToEntityValue(Double value, ConversionContext context) {
        return value == null ? null : new ItemPrice(value)
    }

}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">package example

import io.micronaut.core.convert.ConversionContext
import io.micronaut.data.model.runtime.convert.AttributeConverter
import jakarta.inject.Singleton

@Singleton // <b class="conum">(1)</b>
class ItemPriceAttributeConverter : AttributeConverter&lt;ItemPrice?, Double?&gt; {

    // <b class="conum">(2)</b>
    override fun convertToPersistedValue(itemPrice: ItemPrice?, context: ConversionContext): Double? {
        return itemPrice?.price
    }

    // <b class="conum">(3)</b>
    override fun convertToEntityValue(value: Double?, context: ConversionContext): ItemPrice? {
        return if (value == null) null else ItemPrice(value)
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The attribute converter implements <a href="../api/io/micronaut/data/model/runtime/convert/AttributeConverter.html">@AttributeConverter</a> and must be a bean</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A converter from <code>ItemPrice</code> to <code>Double</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A converter from <code>Double</code> to <code>ItemPrice</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s possible to define the converter result type using <a href="../api/io/micronaut/data/annotation/MappedProperty.html">@MappedProperty</a>: <code>@MappedProperty(converterPersistedType = Double.class)</code>, in this case the data type will be detected automatically.
</td>
</tr>
</table>
</div>

<h2 id="azureCosmosOptimisticLocking"><a class="anchor" href="#azureCosmosOptimisticLocking"></a>8.7 Optimistic locking</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/azureCosmos/azureCosmosOptimisticLocking.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Optimistic locking is a strategy where you note the actual record state&#8217;s version and modify the record only when the version is the same.</p>
</div>
<div class="paragraph">
<p>Unlike some other Db implementations in Micronaut, for Azure Cosmos Db we rely on existence of _etag field in every document. We don&#8217;t use <a href="../api/io/micronaut/data/annotation/Version.html">@Version</a> because _etag field is of type <code>String</code> and for that purpose we introduce <a href="../api/io/micronaut/data/cosmos/annotation/ETag.html">@ETag</a> annotation.</p>
</div>
<div class="paragraph">
<p>The field is updated each time document gets updated in Azure Cosmos Db and before updating it next time, it checks whether current value in the document being updated matches current value in the database. If value doesn&#8217;t match Micronaut will throw  <a href="../api/io/micronaut/data/exceptions/OptimisticLockException.html">OptimisticLockException</a>.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ETag
private String documentVersion;</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">@ETag
private String documentVersion</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@ETag
var documentVersion: String? = null</code></pre>
</div>
</div>

<h1 id="howItWorks"><a class="anchor" href="#howItWorks"></a>9 How Micronaut Data Works</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/howItWorks.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data uses two key features of <a href="https://micronaut.io">Micronaut</a>: The <a href="https://docs.micronaut.io/latest/api/io/micronaut/inject/visitor/TypeElementVisitor.html">TypeElementVisitor</a> API and <a href="https://docs.micronaut.io/latest/guide/index.html#introductionAdvice">Introduction Advice</a>.</p>
</div>
<div class="paragraph">
<p>Micronaut Data defines a <a href="../api/io/micronaut/data/processor/visitors/RepositoryTypeElementVisitor.html">RepositoryTypeElementVisitor</a> that at compilation time visits all interfaces in the source tree that are annotated with the <a href="../api/io/micronaut/data/annotation/Repository.html">@Repository</a> annotation.</p>
</div>
<div class="paragraph">
<p>The <code>RepositoryTypeElementVisitor</code> uses service loader to load all available <a href="../api/io/micronaut/data/processor/visitors/finders/MethodCandidate.html">MethodCandidate</a> implementations and iterate over them.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can add additional method candidates by creating a library that depends on <code>micronaut-data-processor</code> and defining the <code>META-INF/services</code> definition for the method candidate. The new library should be added to your annotation processor path.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>MethodCandidate</code> interface features a <code>isMethodMatch</code> method which allows matching a <a href="https://docs.micronaut.io/latest/api/io/micronaut/inject/ast/MethodElement.html">MethodElement</a>. Once a <code>MethodElement</code> has been matched the <code>buildMatchInfo</code> method of the <code>MethodCandidate</code> is invoked which returns an instance of <a href="../api/io/micronaut/data/processor/visitors/finders/MethodMatchInfo.html">MethodMatchInfo</a>.</p>
</div>
<div class="paragraph">
<p>The constructor for <code>MethodMatchInfo</code> allows specifying the runtime <a href="../api/io/micronaut/data/intercept/DataInterceptor.html">DataInterceptor</a> to execute, which typically differs based on the return type and behaviour required and an optional <a href="../api/io/micronaut/data/model/query/Query.html">Query</a> instance which represents the query model of the query to be executed.</p>
</div>
<div class="paragraph">
<p>The <code>RepositoryTypeElementVisitor</code> takes the <code>MethodMatchInfo</code> and converts the <a href="../api/io/micronaut/data/model/query/Query.html">Query</a> instance into the equivalent String-based query (such as JPA-QL) using the <a href="../api/io/micronaut/data/model/query/builder/QueryBuilder.html">QueryBuilder</a> that is configured by the <a href="../api/io/micronaut/data/annotation/Repository.html">@Repository</a> annotation.</p>
</div>
<div class="paragraph">
<p>A binding between runtime method parameters and named query parameters is also created.</p>
</div>
<div class="paragraph">
<p>The visited <code>MethodElement</code> is then dynamically annotated with the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The constructed string-based query (for example JPA-QL)</p>
</li>
<li>
<p>The parameter binding (A map containing the named parameter in the query as key and the name of the method argument as a value)</p>
</li>
<li>
<p>The runtime <a href="../api/io/micronaut/data/intercept/DataInterceptor.html">DataInterceptor</a> to execute.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At runtime all the <a href="../api/io/micronaut/data/intercept/DataInterceptor.html">DataInterceptor</a> has to do is retrieve the query, read the method parameter values using the parameter binding and execute the query.</p>
</div>

<h1 id="graal"><a class="anchor" href="#graal"></a>10 Going Native with GraalVM</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/graal.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data supports GraalVM native images for both the JPA and JDBC implementations.</p>
</div>
<div class="paragraph">
<p>The currently supported databases are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>H2</p>
</li>
<li>
<p>Postgres</p>
</li>
<li>
<p>Oracle</p>
</li>
<li>
<p>MariaDB</p>
</li>
<li>
<p>MySQL</p>
</li>
<li>
<p>MS SQLServer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Micronaut Data will automatically detect the driver and configure the driver correctly for each database as appropriate.</p>
</div>

<h1 id="spring"><a class="anchor" href="#spring"></a>11 Spring Data Support</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/spring.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut Data features general Spring support that is provided through the <code>micronaut-data-spring</code> dependency:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-spring")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-spring&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>In addition to this dependency you will need either <code>spring-orm</code> (for Hibernate) or <code>spring-jdbc</code> (for JDBC) on your classpath to enable support for Spring-based transaction management:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"org.springframework:spring-orm:5.2.0.RELEASE")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-orm&lt;/artifactId&gt;
    &lt;version&gt;5.2.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>You can then compile existing Spring Data repository interfaces and use Spring annotations such as <code>org.springframework.transaction.annotation.Transactional</code> in your application.</p>
</div>
<div class="paragraph">
<p>You can extend from existing Spring Data interfaces such as <code>CrudRepository</code>, <code>PagingAndSortingRepository</code> and so on.</p>
</div>
<div class="paragraph">
<p>The following Spring Data types are also supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Pageable.html">Pageable</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Sort.html">Sort</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Slice.html">Page</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/PageRequest.html">PageRequest</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/repository/CrudRepository.html">CrudRepository</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/repository/PagingAndSortingRepository.html">PagingAndSortingRepository</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_spring_data_jpa_specification_support">Spring Data JPA Specification Support</h3>
<div class="paragraph">
<p>To obtain additional support for <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#specifications">Spring Data JPA Specifications</a> when using Hibernate and JPA you should add the following dependency to your classpath:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-spring")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-spring&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>You can then implement the <code>JpaSpecificationExecutor</code> (the generic argument to the interface should be a domain class) interface as per the <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#specifications">Spring Data JPA documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_spring_tx_manager">Spring TX manager</h3>
<div class="paragraph">
<p>To replace the internal data-source TX manager with the Spring JDBC alternative include:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-spring-jdbc")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-spring-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
<div class="paragraph">
<p>And to replace the internal Hibernate TX manager with the Spring Hibernate alternative include:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.data:micronaut-data-spring-jpa")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.data&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-data-spring-jpa&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div></p>
</div>
</div>

<h1 id="dataGuides"><a class="anchor" href="#dataGuides"></a>12 Guides</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-data/edit/4.9.x/src/main/docs/guide/dataGuides.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Read from the following list of guides to learn more about working with Micronaut Data in the Micronaut Framework:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://guides.micronaut.io/latest/tag-micronaut_data.html">Micronaut Data Guides</a></p>
</li>
</ul>
</div>

    </div>
</div>

<script type="text/javascript">

</script>
</body>
</html>
